"use strict";exports.id=5306,exports.ids=[5306],exports.modules={45306:(e,t,r)=>{r.d(t,{Aq:()=>n,Gy:()=>d,QT:()=>i,Tt:()=>a,saveReflectionResponse:()=>l});var o=r(75535),s=r(43649);async function l(e,t,r,a,i,n=!0){console.log("saveReflectionResponse called with:",{articleId:e,promptId:t,promptText:r,response:a,position:i,isPrivate:n});let d=s.j2.currentUser;if(console.log("Current user:",d?d.uid:"Not authenticated"),!d){console.log("User not authenticated, saving to local storage"),c(e,t,r,a,i,n);return}let p=`${d.uid}_${e}_${t}_${Date.now()}`,u=(0,o.doc)(s.db,"reflectionResponses",p),g={id:p,userId:d.uid,articleId:e,promptId:t,promptText:r,response:a,position:i,createdAt:(0,o.serverTimestamp)(),isPrivate:n};try{console.log("Attempting to save to Firestore with ID:",p),await (0,o.setDoc)(u,g),console.log("Successfully saved to Firestore"),c(e,t,r,a,i,n)}catch(o){console.error("Error saving reflection response:",o),c(e,t,r,a,i,n)}}function c(e,t,r,o,s,l){try{let c=`reflection_${e}`;console.log("Saving to local storage with key:",c);let a=localStorage.getItem(c),i=a?JSON.parse(a):[];console.log("Existing reflections:",i.length);let n={id:`local_${Date.now()}`,promptId:t,promptText:r,response:o,position:s,createdAt:new Date().toISOString(),isPrivate:l};i.push(n),localStorage.setItem(c,JSON.stringify(i)),console.log("Successfully saved to local storage. Total reflections:",i.length)}catch(e){console.error("Error saving reflection to local storage:",e)}}async function a(e){let t=s.j2.currentUser,l=e||t?.uid,c=new Map;if(t&&l)try{let e=(0,o.collection)(s.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",l),(0,o.orderBy)("createdAt","desc"));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data(),r=t.articleId;c.has(r)||c.set(r,{userId:t.userId,articleId:r,articleTitle:"Loading...",articleSlug:r,responses:[],createdAt:t.createdAt,updatedAt:t.createdAt});let o=c.get(r);o.responses.push(t),t.createdAt>o.updatedAt&&(o.updatedAt=t.createdAt)})}catch(e){console.error("Error fetching reflection responses from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=e.replace("reflection_",""),r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);if(!Array.isArray(e))return;e.forEach(e=>{let r={id:e.id||`local_${Date.now()}`,userId:"local",articleId:t,promptId:e.promptId,promptText:e.promptText,response:e.response,position:e.position,createdAt:new Date(e.createdAt),isPrivate:e.isPrivate};c.has(t)||c.set(t,{userId:"local",articleId:t,articleTitle:"Loading...",articleSlug:t,responses:[],createdAt:r.createdAt,updatedAt:r.createdAt});let o=c.get(t);!o.responses.some(e=>e.promptId===r.promptId&&e.position===r.position&&e.response===r.response)&&(o.responses.push(r),r.createdAt>o.updatedAt&&(o.updatedAt=r.createdAt))})}catch(e){console.error("Error parsing local storage reflection data:",e)}})}catch(e){console.error("Error reading from local storage:",e)}let a=Array.from(c.values()).filter(e=>e.responses.length>0);return await Promise.all(a.map(async e=>{try{let{getArticleById:t}=await r.e(9440).then(r.bind(r,79440)),o=await t(e.articleId);o?(e.articleTitle=o.title,e.articleSlug=o.slug||e.articleId,console.log(`Successfully fetched title for ${e.articleId}: ${o.title}`)):(e.articleTitle=`Article: ${e.articleId}`,console.log(`Article not found for ID: ${e.articleId}`))}catch(t){console.error(`Error fetching article for ${e.articleId}:`,t),e.articleTitle=`Article: ${e.articleId}`}})),a.sort((e,t)=>{let r=e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis();return(t.updatedAt instanceof Date?t.updatedAt.getTime():t.updatedAt.toMillis())-r}),a}async function i(e,t){console.log("Deleting reflection:",{articleId:e,reflectionId:t});let r=s.j2.currentUser,l=!1,c=!1;if(r)try{let c=(0,o.collection)(s.db,"reflectionResponses"),a=(0,o.query)(c,(0,o.where)("userId","==",r.uid),(0,o.where)("articleId","==",e),(0,o.where)("id","==",t)),i=await (0,o.getDocs)(a);if(!i.empty){let e=i.docs[0];await (0,o.deleteDoc)(e.ref),console.log("Successfully deleted from Firestore"),l=!0}}catch(e){console.error("Error deleting from Firestore:",e)}try{let r=`reflection_${e}`,o=localStorage.getItem(r);if(o){let e=JSON.parse(o),s=e.filter(e=>e.id!==t);s.length!==e.length&&(0===s.length?localStorage.removeItem(r):localStorage.setItem(r,JSON.stringify(s)),console.log("Successfully deleted from local storage"),c=!0)}}catch(e){console.error("Error deleting from local storage:",e)}return l||c}async function n(e){let t=s.j2.currentUser,l=e||t?.uid,c=[],a=new Set;if(t&&l)try{let e=(0,o.collection)(s.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",l),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(10)),i=await (0,o.getDocs)(t),n=new Map;for(let e of i.docs){let t=e.data();if(t.response&&t.response.length>20){let e=t.response.toLowerCase().trim();if(!a.has(e)){a.add(e);let o=n.get(t.articleId);if(!o)try{let{getArticleById:e}=await r.e(9440).then(r.bind(r,79440)),s=await e(t.articleId);o=s?.title||"Unknown Article",n.set(t.articleId,o)}catch(e){o="Unknown Article"}c.push({response:t.response,articleTitle:o,promptText:t.promptText})}}}}catch(e){console.error("Error fetching inspiration from Firestore:",e)}try{let e=Object.keys(localStorage).filter(e=>e.startsWith("reflection_")),t=[];e.forEach(e=>{let r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);Array.isArray(e)&&t.push(...e)}catch(e){console.error("Error parsing local storage reflection:",e)}}),t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,10).forEach(e=>{if(e.response&&e.response.length>20){let t=e.response.toLowerCase().trim();a.has(t)||(a.add(t),c.push({response:e.response,articleTitle:"Local Article",promptText:e.promptText}))}})}catch(e){console.error("Error reading inspiration from local storage:",e)}return c.sort(()=>Math.random()-.5).slice(0,5)}async function d(e){let t=s.j2.currentUser,r=e||t?.uid,l=new Set,c=[];if(t&&r)try{let e=(0,o.collection)(s.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",r),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(20));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data();t.promptText&&c.push(t.promptText)})}catch(e){console.error("Error fetching themes from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=localStorage.getItem(e);if(t)try{let e=JSON.parse(t);Array.isArray(e)&&e.forEach(e=>{e.promptText&&c.push(e.promptText)})}catch(e){console.error("Error parsing local storage for themes:",e)}})}catch(e){console.error("Error reading themes from local storage:",e)}return c.forEach(e=>{let t=e.toLowerCase();t.includes("feel")&&l.add("emotions"),(t.includes("choice")||t.includes("decision"))&&l.add("decision-making"),t.includes("experience")&&l.add("personal experience"),t.includes("question")&&l.add("questioning"),t.includes("surprise")&&l.add("unexpected insights"),(t.includes("perspective")||t.includes("view"))&&l.add("perspectives"),t.includes("author")&&l.add("dialogue with authors"),(t.includes("relate")||t.includes("connect"))&&l.add("connections")}),Array.from(l).slice(0,6)}}};