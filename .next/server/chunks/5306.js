"use strict";exports.id=5306,exports.ids=[5306],exports.modules={45306:(e,t,r)=>{r.d(t,{Aq:()=>n,Gy:()=>d,QT:()=>l,Tt:()=>i,saveReflectionResponse:()=>s});var o=r(75535),a=r(43649);async function s(e,t,r,i,l,n=!0){let d=a.j2.currentUser;if(!d)return void c(e,t,r,i,l,n);let p=`${d.uid}_${e}_${t}_${Date.now()}`,u=(0,o.doc)(a.db,"reflectionResponses",p),f={id:p,userId:d.uid,articleId:e,promptId:t,promptText:r,response:i,position:l,createdAt:(0,o.serverTimestamp)(),isPrivate:n};try{await (0,o.setDoc)(u,f),c(e,t,r,i,l,n)}catch(o){console.error("Error saving reflection response:",o),c(e,t,r,i,l,n)}}function c(e,t,r,o,a,s){try{let c=`reflection_${e}`,i=localStorage.getItem(c),l=i?JSON.parse(i):[],n={id:`local_${Date.now()}`,promptId:t,promptText:r,response:o,position:a,createdAt:new Date().toISOString(),isPrivate:s};l.push(n),localStorage.setItem(c,JSON.stringify(l))}catch(e){console.error("Error saving reflection to local storage:",e)}}async function i(e){let t=a.j2.currentUser,s=e||t?.uid,c=new Map;if(t&&s)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",s),(0,o.orderBy)("createdAt","desc"));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data(),r=t.articleId;c.has(r)||c.set(r,{userId:t.userId,articleId:r,articleTitle:"Loading...",articleSlug:r,responses:[],createdAt:t.createdAt,updatedAt:t.createdAt});let o=c.get(r);o.responses.push(t),t.createdAt>o.updatedAt&&(o.updatedAt=t.createdAt)})}catch(e){console.error("Error fetching reflection responses from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=e.replace("reflection_",""),r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);if(!Array.isArray(e))return;e.forEach(e=>{let r={id:e.id||`local_${Date.now()}`,userId:"local",articleId:t,promptId:e.promptId,promptText:e.promptText,response:e.response,position:e.position,createdAt:new Date(e.createdAt),isPrivate:e.isPrivate};c.has(t)||c.set(t,{userId:"local",articleId:t,articleTitle:"Loading...",articleSlug:t,responses:[],createdAt:r.createdAt,updatedAt:r.createdAt});let o=c.get(t);!o.responses.some(e=>e.promptId===r.promptId&&e.position===r.position&&e.response===r.response)&&(o.responses.push(r),r.createdAt>o.updatedAt&&(o.updatedAt=r.createdAt))})}catch(e){console.error("Error parsing local storage reflection data:",e)}})}catch(e){console.error("Error reading from local storage:",e)}let i=Array.from(c.values()).filter(e=>e.responses.length>0);return await Promise.all(i.map(async e=>{try{let{getArticleById:t}=await r.e(9440).then(r.bind(r,79440)),o=await t(e.articleId);o?(e.articleTitle=o.title,e.articleSlug=o.slug||e.articleId):e.articleTitle=`Article: ${e.articleId}`}catch(t){console.error(`Error fetching article for ${e.articleId}:`,t),e.articleTitle=`Article: ${e.articleId}`}})),i.sort((e,t)=>{let r=e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis();return(t.updatedAt instanceof Date?t.updatedAt.getTime():t.updatedAt.toMillis())-r}),i}async function l(e,t){let r=a.j2.currentUser,s=!1,c=!1;if(r)try{let c=(0,o.collection)(a.db,"reflectionResponses"),i=(0,o.query)(c,(0,o.where)("userId","==",r.uid),(0,o.where)("articleId","==",e),(0,o.where)("id","==",t)),l=await (0,o.getDocs)(i);if(!l.empty){let e=l.docs[0];await (0,o.deleteDoc)(e.ref),s=!0}}catch(e){console.error("Error deleting from Firestore:",e)}try{let r=`reflection_${e}`,o=localStorage.getItem(r);if(o){let e=JSON.parse(o),a=e.filter(e=>e.id!==t);a.length!==e.length&&(0===a.length?localStorage.removeItem(r):localStorage.setItem(r,JSON.stringify(a)),c=!0)}}catch(e){console.error("Error deleting from local storage:",e)}return s||c}async function n(e){let t=a.j2.currentUser,s=e||t?.uid,c=[],i=new Set;if(t&&s)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",s),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(10)),l=await (0,o.getDocs)(t),n=new Map;for(let e of l.docs){let t=e.data();if(t.response&&t.response.length>20){let e=t.response.toLowerCase().trim();if(!i.has(e)){i.add(e);let o=n.get(t.articleId);if(!o)try{let{getArticleById:e}=await r.e(9440).then(r.bind(r,79440)),a=await e(t.articleId);o=a?.title||"Unknown Article",n.set(t.articleId,o)}catch(e){o="Unknown Article"}c.push({response:t.response,articleTitle:o,promptText:t.promptText})}}}}catch(e){console.error("Error fetching inspiration from Firestore:",e)}try{let e=Object.keys(localStorage).filter(e=>e.startsWith("reflection_")),t=[];e.forEach(e=>{let r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);Array.isArray(e)&&t.push(...e)}catch(e){console.error("Error parsing local storage reflection:",e)}}),t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,10).forEach(e=>{if(e.response&&e.response.length>20){let t=e.response.toLowerCase().trim();i.has(t)||(i.add(t),c.push({response:e.response,articleTitle:"Local Article",promptText:e.promptText}))}})}catch(e){console.error("Error reading inspiration from local storage:",e)}return c.sort(()=>Math.random()-.5).slice(0,5)}async function d(e){let t=a.j2.currentUser,r=e||t?.uid,s=new Set,c=[];if(t&&r)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",r),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(20));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data();t.promptText&&c.push(t.promptText)})}catch(e){console.error("Error fetching themes from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=localStorage.getItem(e);if(t)try{let e=JSON.parse(t);Array.isArray(e)&&e.forEach(e=>{e.promptText&&c.push(e.promptText)})}catch(e){console.error("Error parsing local storage for themes:",e)}})}catch(e){console.error("Error reading themes from local storage:",e)}return c.forEach(e=>{let t=e.toLowerCase();t.includes("feel")&&s.add("emotions"),(t.includes("choice")||t.includes("decision"))&&s.add("decision-making"),t.includes("experience")&&s.add("personal experience"),t.includes("question")&&s.add("questioning"),t.includes("surprise")&&s.add("unexpected insights"),(t.includes("perspective")||t.includes("view"))&&s.add("perspectives"),t.includes("author")&&s.add("dialogue with authors"),(t.includes("relate")||t.includes("connect"))&&s.add("connections")}),Array.from(s).slice(0,6)}}};