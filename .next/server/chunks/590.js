exports.id=590,exports.ids=[590],exports.modules={6621:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});class a{initialize(e,t){this.containerElement=e,this.currentModel=t,this.rebuildParagraphMap()}fullRender(e){if(!this.containerElement)return void console.error("DOMPatcher not initialized with a container element");this.currentModel=e,this.containerElement.innerHTML="",this.paragraphMap.clear(),this.sectionMap.clear();let t=document.createElement("h1");t.classList.add("article-title"),t.textContent=e.title,this.containerElement.appendChild(t),e.sections.forEach(e=>{let t=this.createSectionElement(e);this.containerElement.appendChild(t),this.sectionMap.set(e.id,t),e.paragraphs.forEach(e=>{let r=this.createParagraphElement(e);t.appendChild(r),this.paragraphMap.set(e.id,r)})})}applyOperation(e,t){if(!this.containerElement)return void console.error("DOMPatcher not initialized with a container element");switch(this.currentModel=e,t.type){case"INSERT_PARAGRAPH":this.insertParagraphDOM(t.sectionId,t.index,t.paragraph);break;case"REMOVE_PARAGRAPH":this.removeParagraphDOM(t.sectionId,t.paragraphId);break;case"UPDATE_PARAGRAPH":this.updateParagraphDOM(t.sectionId,t.paragraphId,t.updates);break;case"INSERT_SECTION":this.insertSectionDOM(t.index,t.section);break;case"REMOVE_SECTION":this.removeSectionDOM(t.sectionId);break;case"UPDATE_SECTION":this.updateSectionDOM(t.sectionId,t.updates);break;default:console.warn("Unknown operation type:",t.type),this.fullRender(e)}}applyOperations(e,t){t.forEach(t=>{this.applyOperation(e,t)})}createParagraphElement(e){let t;switch(e.type){case"heading":t=document.createElement(`h${e.level||2}`);break;case"image":return t=document.createElement("img"),e.src&&(t.setAttribute("src",e.src),t.setAttribute("alt",e.text||"Image")),t;case"blockquote":t=document.createElement("blockquote");break;case"bulletList":t=document.createElement("ul");break;case"orderedList":t=document.createElement("ol");break;case"listItem":t=document.createElement("li");break;default:t=document.createElement("p")}return(t.dataset.paragraphId=e.id,e.marks&&0!==e.marks.length)?this.renderFormattedText(t,e.text,e.marks):t.textContent=e.text,t}createSectionElement(e){let t=document.createElement("section");return t.dataset.sectionId=e.id,t}renderFormattedText(e,t,r){let a=[...r].sort((e,t)=>e.from-t.from);if(0===a.length){e.textContent=t;return}e.innerHTML="";let n=0;if(a.forEach(r=>{let a;if(r.from>n){let a=t.substring(n,r.from);e.appendChild(document.createTextNode(a))}let i=t.substring(r.from,r.to);switch(r.type){case"bold":a=document.createElement("strong");break;case"italic":a=document.createElement("em");break;case"code":a=document.createElement("code");break;case"link":a=document.createElement("a"),r.attrs?.href&&a.setAttribute("href",r.attrs.href);break;default:a=document.createElement("span")}a.textContent=i,e.appendChild(a),n=r.to}),n<t.length){let r=t.substring(n);e.appendChild(document.createTextNode(r))}}insertParagraphDOM(e,t,r){let a=this.sectionMap.get(e);if(!a)return void console.warn(`Section element with ID ${e} not found`);let n=this.createParagraphElement(r);t>=a.children.length?a.appendChild(n):a.insertBefore(n,a.children[t]),this.paragraphMap.set(r.id,n)}removeParagraphDOM(e,t){let r=this.paragraphMap.get(t);if(!r)return void console.warn(`Paragraph element with ID ${t} not found`);r.remove(),this.paragraphMap.delete(t)}updateParagraphDOM(e,t,r){let a=this.paragraphMap.get(t);if(!a)return void console.warn(`Paragraph element with ID ${t} not found`);let n=this.currentModel?.sections.find(t=>t.id===e);if(!n)return;let i=n.paragraphs.find(e=>e.id===t);if(i){if(r.type&&r.type!==i.type){let e=this.createParagraphElement({...i,...r});a.replaceWith(e),this.paragraphMap.set(t,e);return}if(void 0!==r.text||void 0!==r.marks){let e={...i,text:void 0!==r.text?r.text:i.text,marks:void 0!==r.marks?r.marks:i.marks};"image"===e.type?"IMG"===a.tagName&&e.src&&(a.src=e.src,a.alt=e.text||"Image"):(a.innerHTML="",this.renderFormattedText(a,e.text,e.marks))}if(void 0!==r.level&&"heading"===i.type){let e=document.createElement(`h${r.level}`);for(;a.attributes.length>0;){let t=a.attributes[0];e.setAttribute(t.name,t.value),a.removeAttributeNode(t)}e.innerHTML=a.innerHTML,a.replaceWith(e),this.paragraphMap.set(t,e)}}}insertSectionDOM(e,t){if(!this.containerElement)return;let r=this.createSectionElement(t);t.paragraphs.forEach(e=>{let t=this.createParagraphElement(e);r.appendChild(t),this.paragraphMap.set(e.id,t)});let a=Array.from(this.containerElement.querySelectorAll("section"));e>=a.length?this.containerElement.appendChild(r):this.containerElement.insertBefore(r,a[e]),this.sectionMap.set(t.id,r)}removeSectionDOM(e){let t=this.sectionMap.get(e);if(!t)return void console.warn(`Section element with ID ${e} not found`);t.querySelectorAll("[data-paragraph-id]").forEach(e=>{let t=e.getAttribute("data-paragraph-id");t&&this.paragraphMap.delete(t)}),t.remove(),this.sectionMap.delete(e)}updateSectionDOM(e,t){if(!this.sectionMap.get(e))return void console.warn(`Section element with ID ${e} not found`)}rebuildParagraphMap(){this.containerElement&&(this.paragraphMap.clear(),this.sectionMap.clear(),this.containerElement.querySelectorAll("section[data-section-id]").forEach(e=>{let t=e.getAttribute("data-section-id");t&&this.sectionMap.set(t,e)}),this.containerElement.querySelectorAll("[data-paragraph-id]").forEach(e=>{let t=e.getAttribute("data-paragraph-id");t&&this.paragraphMap.set(t,e)}))}constructor(){this.containerElement=null,this.paragraphMap=new Map,this.sectionMap=new Map,this.currentModel=null}}let n=new a},16189:(e,t,r)=>{"use strict";var a=r(65773);r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},31237:e=>{e.exports={articleComposer:"ArticleComposer_articleComposer__NKNNz",composerHeader:"ArticleComposer_composerHeader__WxKaK",logoContainer:"ArticleComposer_logoContainer__9JBIu",logo:"ArticleComposer_logo__83mXS",actionButtons:"ArticleComposer_actionButtons__LvipB",actionButton:"ArticleComposer_actionButton__bgiC0",publishButton:"ArticleComposer_publishButton__eU1uK",savedIndicator:"ArticleComposer_savedIndicator__cBs7G",fadeIn:"ArticleComposer_fadeIn__YzYAJ",composerContent:"ArticleComposer_composerContent__e1ngn",titleInput:"ArticleComposer_titleInput__8eRxt",coverImageInput:"ArticleComposer_coverImageInput__ADPNp",imageUrlInput:"ArticleComposer_imageUrlInput__vYpqn",coverImagePreview:"ArticleComposer_coverImagePreview__gNa8V",tagContainer:"ArticleComposer_tagContainer__I_881",tag:"ArticleComposer_tag__kZ61S",removeTagButton:"ArticleComposer_removeTagButton__P2zqg",tagInput:"ArticleComposer_tagInput__SZSrz",editorContainer:"ArticleComposer_editorContainer__s8Tk_",errorMessage:"ArticleComposer_errorMessage__dg7w6",composerLoading:"ArticleComposer_composerLoading__RrK_T",loadingIndicator:"ArticleComposer_loadingIndicator__i6fhy",spin:"ArticleComposer_spin__WCbXX"}},79440:(e,t,r)=>{"use strict";r.d(t,{BC:()=>u,GE:()=>o,N6:()=>c,Oe:()=>p,S1:()=>E,Tu:()=>g,a:()=>f,fz:()=>h,iZ:()=>d,l6:()=>l,tT:()=>m,zE:()=>s});var a=r(75535),n=r(43649),i=r(28163);async function o(e={}){let{limit:t,includeDrafts:r=!1}=e;console.log("getArticles called with limit:",t);try{let e=(0,a.rJ)(n.db,"articles"),i=[];r||i.push((0,a._M)("status","==","published")),i.push((0,a.My)("createdAt","desc")),t&&t>0&&(console.log("Adding limit constraint:",t),i.push((0,a.AB)(t)));let o=(0,a.P)(e,...i),s=await (0,a.GG)(o);console.log("Query returned document count:",s.size);let l=[];return s.forEach(e=>{let t=e.data();l.push({id:e.id,...t})}),l}catch(e){throw console.error("Error getting articles:",e),e}}async function s(e){try{let t=Date.now();console.log(`üîÑ DIRECT FETCH: Getting article with ID: ${e} (time: ${t})`);let r=(0,a.H9)(n.db,"articles",e),i=await (0,a.x7)(r);if(!i.exists())return console.log("‚ùå Article not found for ID:",e),null;{let e={id:i.id,...i.data()};return console.log("‚úÖ Article found:",e.title),console.log("\uD83D\uDCC4 Content length:",e.body?.length||0),console.log("\uD83C\uDFF7Ô∏è Tags:",e.tags?.join(", ")||"none"),e}}catch(e){throw console.error("\uD83D\uDED1 Error getting article:",e),e}}async function l(e){try{console.log(`Getting article by slug: ${e}, timestamp: ${Date.now()}`);let t=0;for(;t<2;){t++,console.log(`Attempt ${t} to get article by slug`),t>1&&await new Promise(e=>setTimeout(e,500));let r=(0,a.rJ)(n.db,"articles"),i=(0,a.P)(r,(0,a._M)("slug","==",e),(0,a._M)("status","==","published")),o=await (0,a.GG)(i);if(o.empty){if(t>=2){console.log("Article not found for slug after multiple attempts:",e);break}}else{let e=o.docs[0],t={id:e.id,...e.data()};return console.log("Article found by slug:",t.title,"Content length:",t.body?.length||0),t}console.log(`Article not found by slug on attempt ${t}, will retry...`)}return null}catch(e){throw console.error("Error getting article by slug:",e),e}}async function c(e){try{let t=n.j2.currentUser;if(!t)throw Error("You must be logged in to create an article");let r={title:e.title,body:e.body,slug:e.slug||e.title.toLowerCase().replace(/[\s\W-]+/g,"-").replace(/^-+|-+$/g,""),createdAt:a.Dc.now(),authorId:t.uid,authorName:t.displayName||t.email?.split("@")[0]||"Anonymous",tags:e.tags||[],status:e.status||"published",coverImage:e.coverImage||null,likes:[],excerpt:e.excerpt||"",viewCount:0,reposts:[],comments:[]};return{id:(await (0,a.gS)((0,a.rJ)(n.db,"articles"),r)).id,...r}}catch(e){throw console.error("Error creating article:",e),e}}async function d(e,t){try{let r=n.j2.currentUser;if(!r)throw Error("You must be logged in to edit an article");let i=(0,a.H9)(n.db,"articles",e),o=await (0,a.x7)(i);if(!o.exists())throw Error("Article not found");if(o.data().authorId!==r.uid)throw Error("You can only edit your own articles");let s={...t};t.title&&(s.slug=t.title.toLowerCase().replace(/[\s\W-]+/g,"-").replace(/^-+|-+$/g,""),console.log("Updated slug to:",s.slug)),s.updatedAt=a.Dc.now(),await (0,a.mZ)(i,s);let l=await (0,a.x7)(i);return{id:l.id,...l.data()}}catch(e){throw console.error("Error updating article:",e),e}}async function h(e){try{let t=(0,a.rJ)(n.db,"articles",e,"comments"),r=(0,a.P)(t,(0,a.My)("createdAt","desc")),i=await (0,a.GG)(r),o=[];return i.forEach(e=>{let t=e.data();o.push({id:e.id,commentId:e.id,...t,replies:t.replies||[]})}),o}catch(e){throw console.error("Error getting comments:",e),e}}async function u(e,t){try{let r=n.j2.currentUser;if(!r)throw Error("You must be logged in to comment");let o={userId:r.uid,userName:r.displayName||r.email?.split("@")[0]||"Anonymous",content:t,createdAt:a.Dc.now(),likes:[],replies:[]},l=await (0,a.gS)((0,a.rJ)(n.db,"articles",e,"comments"),o),c=await s(e);return c&&c.authorId!==r.uid&&await (0,i.fZ)(c.authorId,e,c.slug||"",c.title||"Article",l.id,t),{id:l.id,commentId:l.id,...o}}catch(e){throw console.error("Error adding comment:",e),e}}async function p(e,t,r){try{let i=n.j2.currentUser;if(!i)throw Error("You must be logged in to reply");let o=(0,a.H9)(n.db,"articles",e,"comments",t),l=await (0,a.x7)(o);if(!l.exists())throw Error("Comment not found");let c={replyId:Math.random().toString(36).substring(2,15),userId:i.uid,userName:i.displayName||i.email?.split("@")[0]||"Anonymous",content:r,createdAt:a.Dc.now(),likes:[]};await (0,a.mZ)(o,{replies:(0,a.hq)(c)});let d=l.data();if(d.userId!==i.uid){let r=await s(e);console.log(`User ${i.uid} replied to comment ${t} by ${d.userId} on article ${r?.title}`)}return c}catch(e){throw console.error("Error adding reply:",e),e}}async function m(e,t){try{let r=n.j2.currentUser;if(!r)throw Error("You must be logged in to like a comment");let i=(0,a.H9)(n.db,"articles",e,"comments",t),o=await (0,a.x7)(i);if(!o.exists())throw Error("Comment not found");let s=o.data(),l=r.uid,c=(s.likes||[]).includes(l);await (0,a.mZ)(i,{likes:c?(0,a.C3)(l):(0,a.hq)(l)});let d=(await (0,a.x7)(i)).data();return{success:!0,action:c?"unliked":"liked",likes:d.likes,count:d.likes.length}}catch(e){throw console.error("Error liking comment:",e),e}}async function g(e,t){try{let r=n.j2.currentUser;if(!r)throw Error("You must be logged in to delete a comment");let i=(0,a.H9)(n.db,"articles",e,"comments",t),o=await (0,a.x7)(i);if(!o.exists())throw Error("Comment not found");if(o.data().userId!==r.uid)throw Error("You can only delete your own comments");return await (0,a.kd)(i),{success:!0,message:"Comment deleted successfully"}}catch(e){throw console.error("Error deleting comment:",e),e}}async function f(e){try{let t=n.j2.currentUser;if(!t)throw Error("You must be logged in to delete an article");let r=(0,a.H9)(n.db,"articles",e),i=await (0,a.x7)(r);if(!i.exists())throw Error("Article not found");if(i.data().authorId!==t.uid)throw Error("You can only delete your own articles");return await (0,a.kd)(r),{success:!0,message:"Article deleted successfully"}}catch(e){throw console.error("Error deleting article:",e),e}}async function E(e,t={}){let{limit:r}=t;try{let t=(0,a.rJ)(n.db,"articles"),i=[(0,a._M)("tags","array-contains",e),(0,a._M)("status","==","published"),(0,a.My)("createdAt","desc")];r&&r>0&&i.push((0,a.AB)(r));let o=(0,a.P)(t,...i),s=await (0,a.GG)(o),l=[];return s.forEach(e=>{l.push({id:e.id,...e.data()})}),l}catch(e){throw console.error("Error getting articles by tag:",e),e}}},95218:e=>{e.exports={articleEditor:"ArticleEditor_articleEditor__Y7zhH",toolbar:"ArticleEditor_toolbar__7VR6u",keyboardHint:"ArticleEditor_keyboardHint__oSXE_",toolbarButton:"ArticleEditor_toolbarButton__n6ugP",active:"ArticleEditor_active__l06wW",editorContent:"ArticleEditor_editorContent__IMeaV",editorStatus:"ArticleEditor_editorStatus__UViLo",fadeIn:"ArticleEditor_fadeIn__hSZwT"}},99590:(e,t,r)=>{"use strict";r.d(t,{A:()=>S});var a=r(60687),n=r(43210),i=r(16189),o=r(55511),s=r.n(o);let l=new Uint8Array(256),c=l.length,d=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).substr(1));let u=function(e,t=0){let r=(h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]).toLowerCase();if(!("string"==typeof r&&d.test(r)))throw TypeError("Stringified UUID is invalid");return r},p=function(e,t,r){let a=(e=e||{}).random||(e.rng||function(){return c>l.length-16&&(s().randomFillSync(l),c=0),l.slice(c,c+=16)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return u(a)};var m=r(79440),g=r(43649);class f{applyOperation(e,t){let r=JSON.parse(JSON.stringify(e));switch(t.type){case"INSERT_PARAGRAPH":return this.insertParagraph(r,t.sectionId,t.index,t.paragraph);case"REMOVE_PARAGRAPH":return this.removeParagraph(r,t.sectionId,t.paragraphId,t.index);case"UPDATE_PARAGRAPH":return this.updateParagraph(r,t.sectionId,t.paragraphId,t.updates);case"INSERT_SECTION":return this.insertSection(r,t.index,t.section);case"REMOVE_SECTION":return this.removeSection(r,t.sectionId,t.index);case"UPDATE_SECTION":return this.updateSection(r,t.sectionId,t.updates);default:return console.warn("Unknown operation type:",t.type),r}}applyOperations(e,t){return t.reduce((e,t)=>this.applyOperation(e,t),e)}insertParagraph(e,t,r,a){let n=e.sections.findIndex(e=>e.id===t);if(-1===n)return console.warn(`Section with ID ${t} not found`),e;let i={...a,id:a.id||p()};return e.sections[n].paragraphs.splice(r,0,i),e}removeParagraph(e,t,r,a){let n=e.sections.findIndex(e=>e.id===t);if(-1===n)return console.warn(`Section with ID ${t} not found`),e;let i=e.sections[n];if(a>=0&&a<i.paragraphs.length)if(i.paragraphs[a].id!==r){console.warn(`Paragraph ID mismatch at index ${a}`);let e=i.paragraphs.findIndex(e=>e.id===r);-1!==e&&i.paragraphs.splice(e,1)}else i.paragraphs.splice(a,1);return e}updateParagraph(e,t,r,a){let n=e.sections.findIndex(e=>e.id===t);if(-1===n)return console.warn(`Section with ID ${t} not found`),e;let i=e.sections[n].paragraphs.findIndex(e=>e.id===r);return -1===i?console.warn(`Paragraph with ID ${r} not found in section ${t}`):e.sections[n].paragraphs[i]={...e.sections[n].paragraphs[i],...a},e}insertSection(e,t,r){let a={...r,id:r.id||p()};return e.sections.splice(t,0,a),e}removeSection(e,t,r){if(r>=0&&r<e.sections.length)if(e.sections[r].id!==t){console.warn(`Section ID mismatch at index ${r}`);let a=e.sections.findIndex(e=>e.id===t);-1!==a&&e.sections.splice(a,1)}else e.sections.splice(r,1);return e}updateSection(e,t,r){let a=e.sections.findIndex(e=>e.id===t);return -1===a?console.warn(`Section with ID ${t} not found`):e.sections[a]={...e.sections[a],...r},e}addTextMark(e,t,r,a,n,i,o){let s=e.sections.findIndex(e=>e.id===t);if(-1===s)return e;let l=e.sections[s].paragraphs.findIndex(e=>e.id===r);if(-1===l)return e;let c={type:a,from:n,to:i,...o&&{attrs:o}},d=[...e.sections[s].paragraphs[l].marks,c];return this.updateParagraph(e,t,r,{marks:d})}removeTextMark(e,t,r,a,n,i){let o=e.sections.findIndex(e=>e.id===t);if(-1===o)return e;let s=e.sections[o].paragraphs.findIndex(e=>e.id===r);if(-1===s)return e;let l=e.sections[o].paragraphs[s].marks.filter(e=>e.type!==a||e.from!==n||e.to!==i);return this.updateParagraph(e,t,r,{marks:l})}splitParagraph(e,t,r,a){let n=e.sections.findIndex(e=>e.id===t);if(-1===n)return e;let i=e.sections[n].paragraphs.findIndex(e=>e.id===r);if(-1===i)return e;let o=e.sections[n].paragraphs[i],s=o.text.substring(0,a),l=o.marks.filter(e=>e.from<a).map(e=>({...e,to:Math.min(e.to,a)})),c=o.text.substring(a),d=o.marks.filter(e=>e.to>a).map(e=>({...e,from:Math.max(e.from-a,0),to:e.to-a})),h=this.updateParagraph(e,t,r,{text:s,marks:l}),u={id:p(),type:o.type,text:c,marks:d,level:o.level};return this.insertParagraph(h,t,i+1,u)}mergeParagraphs(e,t,r,a){let n=e.sections.findIndex(e=>e.id===t);if(-1===n)return e;let i=e.sections[n],o=i.paragraphs.findIndex(e=>e.id===r),s=i.paragraphs.findIndex(e=>e.id===a);if(-1===o||-1===s||s!==o+1)return e;let l=i.paragraphs[o],c=i.paragraphs[s],d=l.text+c.text,h=c.marks.map(e=>({...e,from:e.from+l.text.length,to:e.to+l.text.length})),u=[...l.marks,...h],p=this.updateParagraph(e,t,r,{text:d,marks:u});return this.removeParagraph(p,t,a,s)}}let E=new f;var y=r(6621);class I{initialize(e,t,r){this.model=e,this.editorElement=t,this.onChangeCallback=r||null,y.A.initialize(t,e),y.A.fullRender(e),this.attachEventListeners()}updateModel(e){this.model=e,y.A.fullRender(e)}attachEventListeners(){this.editorElement&&(this.editorElement.setAttribute("contenteditable","true"),this.editorElement.setAttribute("spellcheck","true"),this.editorElement.addEventListener("keydown",this.handleKeyDown),document.addEventListener("selectionchange",this.handleSelectionChange),this.editorElement.addEventListener("focus",this.handleFocus),this.editorElement.addEventListener("blur",this.handleBlur),this.editorElement.addEventListener("input",this.handleInput),this.editorElement.addEventListener("click",this.handleClick),this.editorElement.addEventListener("paste",this.handlePaste))}destroy(){this.editorElement&&(this.editorElement.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("selectionchange",this.handleSelectionChange),this.editorElement.removeEventListener("focus",this.handleFocus),this.editorElement.removeEventListener("blur",this.handleBlur),this.editorElement.removeEventListener("input",this.handleInput),this.editorElement.removeEventListener("click",this.handleClick),this.editorElement.removeEventListener("paste",this.handlePaste))}handleEnterKey(){if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let e=this.findCursorOffsetInParagraph();if(null===e)return;let t=E.splitParagraph(this.model,this.currentSectionId,this.currentParagraphId,e),r=t.sections.findIndex(e=>e.id===this.currentSectionId);if(-1===r)return;let a=t.sections[r].paragraphs.findIndex(e=>e.id===this.currentParagraphId);if(-1===a||a+1>=t.sections[r].paragraphs.length)return;let n=t.sections[r].paragraphs[a+1].id;this.model=t,y.A.fullRender(t),this.setCursorPosition(n,0),this.notifyChange()}handleBackspaceAtStart(){if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let e=this.model.sections.findIndex(e=>e.id===this.currentSectionId);if(-1===e)return;let t=this.model.sections[e].paragraphs.findIndex(e=>e.id===this.currentParagraphId);if(-1===t||0===t)return;let r=this.model.sections[e].paragraphs[t-1],a=r.text.length,n=E.mergeParagraphs(this.model,this.currentSectionId,r.id,this.currentParagraphId);this.model=n,y.A.fullRender(n),this.setCursorPosition(r.id,a),this.currentParagraphId=r.id,this.notifyChange()}handleDeleteAtEnd(){if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let e=this.model.sections.findIndex(e=>e.id===this.currentSectionId);if(-1===e)return;let t=this.model.sections[e].paragraphs.findIndex(e=>e.id===this.currentParagraphId);if(-1===t||t>=this.model.sections[e].paragraphs.length-1)return;let r=this.model.sections[e].paragraphs[t].text.length,a=this.model.sections[e].paragraphs[t+1],n=E.mergeParagraphs(this.model,this.currentSectionId,this.currentParagraphId,a.id);this.model=n,y.A.fullRender(n),this.setCursorPosition(this.currentParagraphId,r),this.notifyChange()}toggleFormat(e){let t;if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let r=window.getSelection();if(!r||r.isCollapsed)return;let{startOffset:a,endOffset:n}=this.getSelectionOffsets();if(null===a||null===n)return;let i=this.findParagraphById(this.currentParagraphId);if(!i)return;let o=i.marks.find(t=>t.type===e&&t.from<=a&&t.to>=n);t=o?E.removeTextMark(this.model,this.currentSectionId,this.currentParagraphId,e,o.from,o.to):E.addTextMark(this.model,this.currentSectionId,this.currentParagraphId,e,a,n),this.model=t,y.A.fullRender(t),this.setTextSelection(this.currentParagraphId,a,n),this.notifyChange()}insertLink(){if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let e=window.getSelection();if(!e||e.isCollapsed)return;let{startOffset:t,endOffset:r}=this.getSelectionOffsets();if(null===t||null===r)return;let a=window.prompt("Enter URL:");if(!a)return;let n=E.addTextMark(this.model,this.currentSectionId,this.currentParagraphId,"link",t,r,{href:a});this.model=n,y.A.fullRender(n),this.setTextSelection(this.currentParagraphId,t,r),this.notifyChange()}updateCurrentParagraphAndSection(){let e=window.getSelection();if(!e||!e.anchorNode){this.currentParagraphId=null,this.currentSectionId=null;return}let t=e.anchorNode.nodeType===Node.ELEMENT_NODE?e.anchorNode:e.anchorNode.parentElement;for(;t&&!t.hasAttribute("data-paragraph-id");)t=t.parentElement;if(!t){this.currentParagraphId=null,this.currentSectionId=null;return}this.currentParagraphId=t.getAttribute("data-paragraph-id");let r=t.parentElement;for(;r&&!r.hasAttribute("data-section-id");)r=r.parentElement;if(!r){this.currentSectionId=null;return}this.currentSectionId=r.getAttribute("data-section-id")}isAtStartOfParagraph(){let e=window.getSelection();return!!e&&!!e.anchorNode&&!!e.isCollapsed&&(e.anchorNode.nodeType===Node.TEXT_NODE,0===e.anchorOffset)}isAtEndOfParagraph(){let e=window.getSelection();if(!e||!e.anchorNode||!e.isCollapsed)return!1;if(e.anchorNode.nodeType===Node.TEXT_NODE)return e.anchorOffset===e.anchorNode.textContent?.length;let t=e.anchorNode;return e.anchorOffset===t.childNodes.length}findCursorOffsetInParagraph(){if(!this.currentParagraphId||!this.model)return null;let e=window.getSelection();if(!e||!e.isCollapsed)return null;let t=this.findParagraphById(this.currentParagraphId);if(!t)return null;let r=document.querySelector(`[data-paragraph-id="${this.currentParagraphId}"]`);return r?e.anchorNode?.nodeType===Node.TEXT_NODE&&e.anchorNode.parentNode===r?e.anchorOffset:t.text.length:null}findParagraphById(e){if(!this.model)return null;for(let t of this.model.sections){let r=t.paragraphs.find(t=>t.id===e);if(r)return r}return null}setCursorPosition(e,t){let r=document.querySelector(`[data-paragraph-id="${e}"]`);if(!r)return;let a=document.createRange(),n=window.getSelection();0===t?(a.setStart(r,0),a.collapse(!0)):(a.selectNodeContents(r),a.collapse(!1)),n&&(n.removeAllRanges(),n.addRange(a))}setTextSelection(e,t,r){let a=document.querySelector(`[data-paragraph-id="${e}"]`);if(!a)return;let n=document.createRange(),i=window.getSelection();n.selectNodeContents(a),i&&(i.removeAllRanges(),i.addRange(n))}getSelectionOffsets(){return{startOffset:0,endOffset:0}}notifyChange(){this.onChangeCallback&&this.model&&this.onChangeCallback(this.model)}constructor(){this.model=null,this.editorElement=null,this.selectionState={anchorNode:null,anchorOffset:0,focusNode:null,focusOffset:0,isCollapsed:!0},this.onChangeCallback=null,this.focusedElement=null,this.currentParagraphId=null,this.currentSectionId=null,this.handleKeyDown=e=>{if(this.model)switch(this.updateCurrentParagraphAndSection(),e.key){case"Enter":e.shiftKey||(e.preventDefault(),this.handleEnterKey());break;case"Backspace":this.isAtStartOfParagraph()&&(e.preventDefault(),this.handleBackspaceAtStart());break;case"Delete":this.isAtEndOfParagraph()&&(e.preventDefault(),this.handleDeleteAtEnd());break;case"b":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.toggleFormat("bold"));break;case"i":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.toggleFormat("italic"));break;case"`":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.toggleFormat("code"));break;case"k":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.insertLink())}},this.handleSelectionChange=()=>{let e=window.getSelection();e&&(this.selectionState={anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed},this.updateCurrentParagraphAndSection())},this.handleFocus=e=>{this.focusedElement=e.target,this.updateCurrentParagraphAndSection()},this.handleBlur=()=>{this.focusedElement=null},this.handleInput=e=>{if(!this.model||!this.currentParagraphId||!this.currentSectionId)return;let t=e.target.textContent||"",r={type:"UPDATE_PARAGRAPH",sectionId:this.currentSectionId,paragraphId:this.currentParagraphId,updates:{text:t}},a=E.applyOperation(this.model,r);this.model=a,this.notifyChange()},this.handleClick=()=>{this.updateCurrentParagraphAndSection()},this.handlePaste=e=>{if(e.preventDefault(),!this.model||!this.currentParagraphId||!this.currentSectionId||!e.clipboardData)return;let t=e.clipboardData.getData("text/plain"),r=window.getSelection();if(!r||!r.rangeCount)return;r.getRangeAt(0);let a=this.findParagraphById(this.currentParagraphId);if(!a)return;let n=this.findCursorOffsetInParagraph();if(null===n)return;let i=a.text.substring(0,n)+t+a.text.substring(n),o={type:"UPDATE_PARAGRAPH",sectionId:this.currentSectionId,paragraphId:this.currentParagraphId,updates:{text:i}},s=E.applyOperation(this.model,o);this.model=s,y.A.applyOperation(s,o),this.notifyChange(),this.setCursorPosition(this.currentParagraphId,n+t.length)}}}let w=new I;var C=r(95218),v=r.n(C);let x=({articleId:e,initialHtml:t="",onChange:r})=>{let i=(0,n.useRef)(null),[o,s]=(0,n.useState)(!1),[l,c]=(0,n.useState)({id:e,title:"",sections:[{id:p(),type:"section",paragraphs:[{id:p(),type:"paragraph",text:"",marks:[]}]}]});(0,n.useEffect)(()=>{if(i.current&&!o){if(t&&t.trim())try{let r=t.replace(/<div[^>]*>Content is loaded from HTML<\/div>/g,"").replace(/<h1[^>]*>Untitled Article<\/h1>/g,""),a=document.createElement("div");a.innerHTML=r;let n=Array.from(a.children).map(e=>{let t=e.tagName.toLowerCase(),r="paragraph";"h1"===t||"h2"===t||"h3"===t?r="heading":"blockquote"===t?r="blockquote":"ul"===t?r="bulletList":"ol"===t?r="orderedList":"li"===t?r="listItem":"img"===t&&(r="image");let a=e.textContent||"",n=[];e.querySelector("strong, b")&&n.push({type:"bold",from:0,to:a.length}),e.querySelector("em, i")&&n.push({type:"italic",from:0,to:a.length});let i={id:p(),type:r,text:a,marks:n};return"heading"===r&&("h1"===t?i.level=1:"h2"===t?i.level=2:"h3"===t&&(i.level=3)),"image"===r&&(i.src=e.getAttribute("src")||""),i});0===n.length&&n.push({id:p(),type:"paragraph",text:"",marks:[]});let i={id:e,title:"",sections:[{id:p(),type:"section",paragraphs:n}]};c(i)}catch(e){console.error("Error parsing initial HTML:",e)}return setTimeout(()=>{if(i.current){if(i.current.innerHTML="",w.initialize(l,i.current,d),t&&t.trim()){let e=t.replace(/<div[^>]*>Content is loaded from HTML<\/div>/g,"").replace(/<h1[^>]*>Untitled Article<\/h1>/g,"");i.current.innerHTML=e;let r=document.createRange(),a=window.getSelection();if(i.current.childNodes.length>0){let e=i.current.lastChild;e&&(r.setStartAfter(e),r.collapse(!0),a&&(a.removeAllRanges(),a.addRange(r)))}}else i.current.innerHTML="<p><br></p>";s(!0)}},50),()=>{w.destroy()}}},[e,t]);let d=e=>{c(e),r&&i.current&&r(i.current.innerHTML.replace(/<div[^>]*>Content is loaded from HTML<\/div>/g,"").replace(/<h1[^>]*>Untitled Article<\/h1>/g,""),e)},h=()=>{document.execCommand("bold",!1),i.current&&i.current.focus()},u=()=>{document.execCommand("italic",!1),i.current&&i.current.focus()},m=e=>{document.execCommand("formatBlock",!1,`h${e}`),i.current&&i.current.focus()};return(0,a.jsxs)("div",{className:v().articleEditor,children:[(0,a.jsxs)("div",{className:v().toolbar,children:[(0,a.jsx)("button",{className:v().toolbarButton,onClick:h,title:"Bold (‚åò/Ctrl+B)",children:(0,a.jsx)("strong",{children:"B"})}),(0,a.jsx)("button",{className:v().toolbarButton,onClick:u,title:"Italic (‚åò/Ctrl+I)",children:(0,a.jsx)("em",{children:"I"})}),(0,a.jsx)("button",{className:v().toolbarButton,onClick:()=>m(1),title:"Heading 1 (‚åò/Ctrl+1)",children:"H1"}),(0,a.jsx)("button",{className:v().toolbarButton,onClick:()=>m(2),title:"Heading 2 (‚åò/Ctrl+2)",children:"H2"}),(0,a.jsx)("button",{className:v().toolbarButton,onClick:()=>m(3),title:"Heading 3 (‚åò/Ctrl+3)",children:"H3"}),(0,a.jsxs)("div",{className:v().keyboardHint,children:[(0,a.jsx)("kbd",{children:"‚åòB"})," Bold \xa0 ",(0,a.jsx)("kbd",{children:"‚åòI"})," Italic \xa0 ",(0,a.jsx)("kbd",{children:"‚åò1-3"})," Headings"]})]}),(0,a.jsx)("div",{ref:i,className:v().editorContent,contentEditable:!0,"aria-label":"Article editor",suppressContentEditableWarning:!0,onFocus:()=>{if(i.current&&""===i.current.innerHTML){i.current.innerHTML="<p><br></p>";let e=document.createRange(),t=window.getSelection(),r=i.current.querySelector("p");r&&(e.setStart(r,0),e.collapse(!0),t&&(t.removeAllRanges(),t.addRange(e)))}},onKeyDown:e=>{let t=navigator.platform.toUpperCase().indexOf("MAC")>=0?e.metaKey:e.ctrlKey;if(t&&"b"===e.key)return e.preventDefault(),h(),!1;if(t&&"i"===e.key)return e.preventDefault(),u(),!1;if(t&&"1"===e.key)return e.preventDefault(),m(1),!1;if(t&&"2"===e.key)return e.preventDefault(),m(2),!1;if(t&&"3"===e.key)return e.preventDefault(),m(3),!1;if("Enter"===e.key&&!e.shiftKey){e.preventDefault(),document.execCommand("insertParagraph",!1);let t=window.getSelection();if(t&&t.rangeCount>0){let e=t.getRangeAt(0).startContainer.parentElement;e&&"div"===e.tagName.toLowerCase()&&document.execCommand("formatBlock",!1,"p")}return i.current&&r&&r(i.current.innerHTML,l),!1}},onPaste:e=>{if("true"===e.nativeEvent.clipboardData?.getData("text/html-editor-match-style")||e.nativeEvent.clipboardData?.types.includes("text/html-editor-match-style")){e.preventDefault();let t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)}i.current&&r&&setTimeout(()=>{i.current&&r(i.current.innerHTML,l)},0)}})]})};var b=r(31237),A=r.n(b);let S=({articleId:e,onUpdateComplete:t})=>{let r=(0,i.useRouter)(),[o,s]=(0,n.useState)(""),[l,c]=(0,n.useState)(""),[d,h]=(0,n.useState)([]),[u,f]=(0,n.useState)(""),[E,y]=(0,n.useState)(!1),[I,w]=(0,n.useState)(!1),[C,v]=(0,n.useState)(!1),[b,S]=(0,n.useState)(""),[P,k]=(0,n.useState)(!!e),[_,M]=(0,n.useState)(null),[N,D]=(0,n.useState)(""),[T,O]=(0,n.useState)(null),R=(0,n.useRef)(null),L=(0,n.useRef)(null),j=(0,n.useCallback)(()=>{R.current&&(R.current.style.height="auto",R.current.style.height=`${R.current.scrollHeight}px`,!o&&R.current&&R.current.focus())},[o]);(0,n.useEffect)(()=>{let e=g.j2.onAuthStateChanged(e=>{M(e),e||r.push("/login?redirect=compose")});return()=>e()},[r]),(0,n.useEffect)(()=>{e&&_?(async()=>{try{k(!0);let t=await (0,m.zE)(e);if(!t){S("Article not found"),r.push("/");return}if(t.authorId!==_.uid){S("You can only edit your own articles"),r.push("/");return}s(t.title);let a=t.body.replace(/data-[\w-]+="[^"]*"/g,"");c(a),h(t.tags||[]),f(t.coverImage||"");let n={id:e,title:t.title,sections:[{id:p(),type:"section",paragraphs:[]}]};O(n)}catch(e){console.error("Error loading article:",e),S("Failed to load article")}finally{k(!1)}})():e||O({id:p(),title:"",sections:[{id:p(),type:"section",paragraphs:[{id:p(),type:"paragraph",text:"",marks:[]}]}]})},[e,_,r]),(0,n.useEffect)(()=>{j()},[o,j]),(0,n.useEffect)(()=>{let e;return _&&o.trim()&&l.trim()&&!I&&!E&&(e=setTimeout(()=>{U("drafts")},3e4)),()=>{e&&clearTimeout(e)}},[_,o,l,I,E]);let H=()=>{let e=N.trim().toLowerCase();e&&!d.includes(e)&&d.length<5&&(h([...d,e]),D(""))},B=e=>{h(d.filter(t=>t!==e))},$=(0,n.useRef)(null),U=async(a="drafts")=>{if(!_)return void S("You must be logged in to save an article");if(!o.trim())return void S("Title is required");if(!l.trim())return void S("Content is required");try{w(!0),S("");let n=l.replace(/data-[\w-]+="[^"]*"/g,""),i={title:o.trim(),body:n,tags:d,coverImage:u.trim(),status:a};if(console.log("Saving article data:",i),e)try{let r=await (0,m.iZ)(e,i);console.log("Article updated successfully:",r?.title),v(!0),await new Promise(e=>setTimeout(e,500));let a=await (0,m.zE)(e);console.log("Fetched updated article data:",a?.title),t&&t(a),setTimeout(()=>{console.log("Applying changes immediately and redirecting to article ID page"),window.location.href=`/articles/${e}/view?updated=true&time=${Date.now()}`,setTimeout(()=>{window.location.pathname.includes("/edit")&&(console.log("Fallback navigation to main articles page"),window.location.href=`/articles?id=${e}&updated=true&time=${Date.now()}`)},2e3)},1e3)}catch(e){console.error("Error updating article:",e),S("Failed to update article. Please try again."),v(!1)}else{let e=await (0,m.N6)(i);"published"===a?r.push(`/articles/${e.id}`):r.push("/dashboard")}}catch(e){console.error("Error saving article:",e),S("Failed to save article. Please try again.")}finally{w(!1),y(!1)}},K=async()=>{if(!l.trim())return void S("Content is required");y(!0),await U("published")},q=async()=>{await U("drafts")};return P?(0,a.jsxs)("div",{className:A().composerLoading,children:[(0,a.jsx)("div",{className:A().loadingIndicator}),(0,a.jsx)("p",{children:"Loading article..."})]}):(0,a.jsxs)("div",{className:A().articleComposer,children:[(0,a.jsxs)("header",{className:A().composerHeader,children:[(0,a.jsx)("div",{className:A().logoContainer,children:(0,a.jsx)("div",{className:A().logo,children:"Journalite"})}),(0,a.jsxs)("div",{className:A().actionButtons,children:[C&&(0,a.jsxs)("span",{className:A().savedIndicator,children:[(0,a.jsx)("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"currentColor",children:(0,a.jsx)("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"})}),"Saved"]}),(0,a.jsx)("button",{className:A().actionButton,onClick:q,disabled:I||E,children:"Save draft"}),(0,a.jsx)("button",{className:A().publishButton,onClick:K,disabled:I||E||!o.trim()||!l.trim(),children:e?"Update":"Publish"})]})]}),(0,a.jsxs)("main",{className:A().composerContent,children:[(0,a.jsx)("textarea",{ref:R,className:A().titleInput,value:o,onChange:e=>{s(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),$.current&&$.current.focus())},placeholder:"Title",rows:1}),(0,a.jsxs)("div",{className:A().coverImageInput,children:[(0,a.jsx)("input",{type:"text",value:u,onChange:e=>{f(e.target.value)},placeholder:"Add a cover image (enter image URL)",className:A().imageUrlInput}),u&&(0,a.jsx)("div",{className:A().coverImagePreview,children:(0,a.jsx)("img",{src:u,alt:"Cover preview"})})]}),(0,a.jsxs)("div",{className:A().tagContainer,children:[d.map(e=>(0,a.jsxs)("div",{className:A().tag,children:[e,(0,a.jsx)("button",{className:A().removeTagButton,onClick:()=>B(e),"aria-label":`Remove ${e} tag`,children:"\xd7"})]},e)),d.length<5&&(0,a.jsx)("input",{ref:L,type:"text",value:N,onChange:e=>{D(e.target.value)},onKeyDown:e=>{("Enter"===e.key||","===e.key)&&(e.preventDefault(),H())},onBlur:H,placeholder:0===d.length?"Add up to 5 tags...":"Add another tag...",className:A().tagInput})]}),b&&(0,a.jsx)("div",{className:A().errorMessage,children:b}),T&&(0,a.jsx)("div",{className:A().editorContainer,ref:$,children:(0,a.jsx)(x,{articleId:T.id,initialHtml:l,onChange:(e,t)=>{e!==l&&(c(e),O(t),C&&v(!1))}})})]})]})}}};