(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8883],{2897:(e,t,r)=>{"use strict";r.d(t,{$i:()=>m,FA:()=>d,KB:()=>f,SR:()=>h,_z:()=>u,iS:()=>g,zS:()=>w});var s=r(5317),a=r(3201),n=r(4744);let o=new Map,i=new Map;async function c(e){let t=o.get(e),r=Date.now();if(t&&r-t.timestamp<3e5)return t.profile;let s=await (0,n.VM)(e);return s&&o.set(e,{profile:s,timestamp:r}),s}async function l(e,t){let r="".concat(e,"-").concat(t),s=i.get(r),a=Date.now();if(s&&a-s.timestamp<3e4)return s.count;let n=await p(e,t);return i.set(r,{count:n,timestamp:a}),n}async function d(e,t){if(!e||!t)throw Error("Both user IDs are required");if(e===t)throw Error("Cannot create conversation with yourself");try{let r=(0,s.collection)(a.db,"conversations"),n=(0,s.query)(r,(0,s.where)("participants","array-contains",e));for(let e of(await (0,s.getDocs)(n)).docs)if(e.data().participants.includes(t))return e.id;let o={participants:[e,t].sort(),lastMessage:{content:"",senderId:"",timestamp:(0,s.serverTimestamp)(),read:!1},createdAt:(0,s.serverTimestamp)(),updatedAt:(0,s.serverTimestamp)()};return(await (0,s.addDoc)(r,o)).id}catch(e){throw console.error("Error getting or creating conversation:",e),e}}async function u(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"text",o=a.j2.currentUser;if(!o)throw Error("User must be authenticated to send messages");if(!r.trim())throw Error("Message content cannot be empty");try{let c=(0,s.collection)(a.db,"messages"),l={conversationId:e,senderId:o.uid,receiverId:t,content:r.trim(),type:n,timestamp:(0,s.serverTimestamp)(),read:!1},d=await (0,s.addDoc)(c,l),u=(0,s.doc)(a.db,"conversations",e);await (0,s.updateDoc)(u,{lastMessage:{content:r.trim(),senderId:o.uid,timestamp:(0,s.serverTimestamp)(),read:!1},updatedAt:(0,s.serverTimestamp)()});let m="".concat(e,"-").concat(t);return i.delete(m),d.id}catch(e){throw console.error("Error sending message:",e),e}}async function m(e,t,r){let n=a.j2.currentUser;if(!n)throw Error("User must be authenticated to send messages");if(!r.uid||!r.username)throw Error("Profile data must include uid and username");try{let o=(0,s.collection)(a.db,"messages"),c={conversationId:e,senderId:n.uid,receiverId:t,content:"Shared ".concat(r.firstName," ").concat(r.lastName,"'s profile"),type:"profile",timestamp:(0,s.serverTimestamp)(),read:!1,profileAttachment:r},l=await (0,s.addDoc)(o,c),d=(0,s.doc)(a.db,"conversations",e);await (0,s.updateDoc)(d,{lastMessage:{content:"Shared ".concat(r.firstName," ").concat(r.lastName,"'s profile"),senderId:n.uid,timestamp:(0,s.serverTimestamp)(),read:!1},updatedAt:(0,s.serverTimestamp)()});let u="".concat(e,"-").concat(t);return i.delete(u),l.id}catch(e){throw console.error("Error sending profile message:",e),e}}function h(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;try{let n=(0,s.collection)(a.db,"messages"),o=(0,s.query)(n,(0,s.where)("conversationId","==",e),(0,s.orderBy)("timestamp","desc"),(0,s.limit)(r));return(0,s.onSnapshot)(o,e=>{let r=[];e.forEach(e=>{r.push({id:e.id,...e.data()})}),t(r.reverse())})}catch(e){throw console.error("Error subscribing to messages:",e),e}}function f(e,t){try{let r=(0,s.collection)(a.db,"conversations"),n=(0,s.query)(r,(0,s.where)("participants","array-contains",e),(0,s.orderBy)("updatedAt","desc"));return(0,s.onSnapshot)(n,async r=>{let s=[],a=new Map;for(let t of r.docs){let r=({id:t.id,...t.data()}).participants.find(t=>t!==e);r&&!a.has(r)&&a.set(r,c(r))}let n=new Map;for(let[e,t]of a)try{let r=await t;r&&n.set(e,r)}catch(t){console.error("Error fetching profile for user ".concat(e,":"),t)}for(let t of r.docs){let r={id:t.id,...t.data()},a=r.participants.find(t=>t!==e);if(!a)continue;let o=n.get(a);if(!o)continue;let i=await l(r.id,e);s.push({conversation:r,otherUser:{uid:o.uid,username:o.username,firstName:o.firstName,lastName:o.lastName},unreadCount:i})}t(s)})}catch(e){throw console.error("Error subscribing to conversations:",e),e}}async function g(e,t){try{let r=(0,s.collection)(a.db,"messages"),n=(0,s.query)(r,(0,s.where)("conversationId","==",e),(0,s.where)("receiverId","==",t),(0,s.where)("read","==",!1)),o=(await (0,s.getDocs)(n)).docs.map(e=>(0,s.updateDoc)(e.ref,{read:!0}));await Promise.all(o);let c="".concat(e,"-").concat(t);i.delete(c)}catch(e){throw console.error("Error marking messages as read:",e),e}}async function p(e,t){try{let r=(0,s.collection)(a.db,"messages"),n=(0,s.query)(r,(0,s.where)("conversationId","==",e),(0,s.where)("receiverId","==",t),(0,s.where)("read","==",!1));return(await (0,s.getDocs)(n)).size}catch(e){return console.error("Error getting unread message count:",e),0}}async function w(e){try{let t=(0,s.collection)(a.db,"messages"),r=(0,s.query)(t,(0,s.where)("receiverId","==",e),(0,s.where)("read","==",!1));return(await (0,s.getDocs)(r)).size}catch(e){return console.error("Error getting total unread count:",e),0}}},6363:e=>{e.exports={container:"MessageNotificationBell_container__5aDLA",button:"MessageNotificationBell_button__csZH1",icon:"MessageNotificationBell_icon__jDLI1",badge:"MessageNotificationBell_badge__XBtr6",dropdown:"MessageNotificationBell_dropdown__FrQoZ",header:"MessageNotificationBell_header__dUyx_",viewAll:"MessageNotificationBell_viewAll__rou73",content:"MessageNotificationBell_content__9BE73",empty:"MessageNotificationBell_empty__5dFf7",messageInfo:"MessageNotificationBell_messageInfo__dDLRK",message:"MessageNotificationBell_message__1p3sE",viewLink:"MessageNotificationBell_viewLink__w6OtV"}},8883:(e,t,r)=>{"use strict";r.d(t,{A:()=>m});var s=r(5155),a=r(2115),n=r(6874),o=r.n(n),i=r(8731),c=r(3201),l=r(2897),d=r(6363),u=r.n(d);let m=()=>{let[e]=(0,i.hD)(c.j2),[t,r]=(0,a.useState)(0),[n,d]=(0,a.useState)(!1),m=(0,a.useRef)(null);return((0,a.useEffect)(()=>{if(!e)return;let t=async()=>{try{let t=await (0,l.zS)(e.uid);r(t)}catch(e){console.error("Error getting message unread count:",e)}};t();let s=(0,l.KB)(e.uid,e=>{r(e.reduce((e,t)=>e+t.unreadCount,0))}),a=setInterval(t,12e4);return()=>{s(),clearInterval(a)}},[e]),(0,a.useEffect)(()=>{let e=e=>{m.current&&!m.current.contains(e.target)&&d(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),e)?(0,s.jsxs)("div",{className:u().container,ref:m,children:[(0,s.jsx)(o(),{href:"/messages",children:(0,s.jsxs)("button",{className:u().button,onClick:()=>{d(!n)},"aria-label":"Messages",children:[(0,s.jsx)("svg",{className:u().icon,width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,s.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})}),t>0&&(0,s.jsx)("span",{className:u().badge,children:t})]})}),n&&(0,s.jsxs)("div",{className:u().dropdown,children:[(0,s.jsxs)("div",{className:u().header,children:[(0,s.jsx)("h3",{children:"Messages"}),(0,s.jsx)(o(),{href:"/messages",className:u().viewAll,children:"View All"})]}),(0,s.jsx)("div",{className:u().content,children:0===t?(0,s.jsx)("div",{className:u().empty,children:"No new messages"}):(0,s.jsxs)("div",{className:u().messageInfo,children:[(0,s.jsxs)("p",{className:u().message,children:["You have ",t," unread message",1!==t?"s":""]}),(0,s.jsx)(o(),{href:"/messages",className:u().viewLink,children:"Go to Messages"})]})})]})]}):null}}}]);