"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2992],{7015:(e,t,n)=>{n.d(t,{$$:()=>hT,$1:()=>uq,$c:()=>uU,AB:()=>uP,AM:()=>hJ,B:()=>lR,BN:()=>ho,Bh:()=>hj,C3:()=>hP,CL:()=>hF,Ci:()=>l3,Cq:()=>uD,Cs:()=>lk,Dc:()=>j,EO:()=>uB,F7:()=>hG,FA:()=>J,FC:()=>hd,FD:()=>uG,Fs:()=>l5,G8:()=>u1,GA:()=>hD,GG:()=>hi,GV:()=>hq,Gv:()=>uK,H6:()=>lL,H9:()=>lD,HM:()=>uz,He:()=>_,Ix:()=>l1,J_:()=>h$,K$:()=>X,K7:()=>hC,LA:()=>lH,LV:()=>hz,Li:()=>uR,MH:()=>lY,Mh:()=>lO,My:()=>uO,NJ:()=>u9,O5:()=>hO,O8:()=>u8,O_:()=>hp,Os:()=>lW,P:()=>uk,Q5:()=>l$,Rr:()=>ha,Rw:()=>tq,S0:()=>l8,St:()=>lJ,T1:()=>lx,U9:()=>u2,Uo:()=>uM,V7:()=>l4,W6:()=>k,Wc:()=>lX,Wq:()=>u4,Ws:()=>lB,XK:()=>lS,Y$:()=>B,YQ:()=>u6,YS:()=>lN,Z9:()=>hZ,ZX:()=>hV,_7:()=>lP,_A:()=>lq,_M:()=>uA,_e:()=>hr,aQ:()=>hc,aU:()=>lU,bI:()=>N,c4:()=>hM,c8:()=>lg,cY:()=>hN,cm:()=>tX,cz:()=>u0,d_:()=>hg,eQ:()=>R,fS:()=>uZ,gS:()=>hh,gT:()=>u5,hq:()=>hL,i1:()=>hU,iB:()=>lQ,jy:()=>uF,kA:()=>hX,kL:()=>h_,kU:()=>hs,kd:()=>hu,lN:()=>u7,lo:()=>lv,mT:()=>hQ,mZ:()=>hl,mc:()=>u3,me:()=>lj,nY:()=>hn,oN:()=>l0,ol:()=>lK,or:()=>uV,po:()=>lZ,qG:()=>tP,qi:()=>E,rJ:()=>lC,rf:()=>u$,ts:()=>hb,uY:()=>l2,vK:()=>hE,vN:()=>lE,wP:()=>hB,wx:()=>uC,wy:()=>q,x7:()=>he,xC:()=>uL,yf:()=>hW,yx:()=>lA,z6:()=>hf});var r,i,s,a,o=n(6235),l=n(6391),u=n(796),h=n(9887),c=n(2107),d=n(927),f=n(7358),m=n(4134).hp;let g="@firebase/firestore",p="4.7.10";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="11.5.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function _(e){v.setLogLevel(e)}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let n=t.map(S);v.debug(`Firestore (${w}): ${e}`,...n)}}function b(e,...t){if(v.logLevel<=u.$b.ERROR){let n=t.map(S);v.error(`Firestore (${w}): ${e}`,...n)}}function E(e,...t){if(v.logLevel<=u.$b.WARN){let n=t.map(S);v.warn(`Firestore (${w}): ${e}`,...n)}}function S(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function x(e="Unexpected state"){let t=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: `+e;throw b(t),Error(t)}function N(e,t){e||x()}let C={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class k extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class D{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class A{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class R{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class V{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class M{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||x();let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new D;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new D,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new D)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||x(),new A(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||x(),new y(e)}}class F{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.T=new Map}I(){return this.P?this.P():null}get headers(){this.T.set("X-Goog-AuthUser",this.l);let e=this.I();return e&&this.T.set("Authorization",e),this.h&&this.T.set("X-Goog-Iam-Authorization-Token",this.h),this.T}}class O{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new F(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class L{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class P{constructor(e,t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null,this.V=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.V=e.settings.appCheckToken)}start(e,t){void 0===this.o||x();let n=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.R;return this.R=e.token,T("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?r(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.V)return Promise.resolve(new L(this.V));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||x(),this.R=e.token,new L(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class q{getToken(){return Promise.resolve(new L(""))}invalidateToken(){}start(e,t){}shutdown(){}}function U(){return new TextEncoder}class B{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function z(e,t){return e<t?-1:+(e>t)}function K(e,t){let n=0;for(;n<e.length&&n<t.length;){let r=e.codePointAt(n),i=t.codePointAt(n);if(r!==i){if(r<128&&i<128)return z(r,i);{let s=U(),a=function(e,t){for(let n=0;n<e.length&&n<t.length;++n)if(e[n]!==t[n])return z(e[n],t[n]);return z(e.length,t.length)}(s.encode($(e,n)),s.encode($(t,n)));return 0!==a?a:z(r,i)}}n+=r>65535?2:1}return z(e.length,t.length)}function $(e,t){return e.codePointAt(t)>65535?e.substring(t,t+2):e.substring(t,t+1)}function G(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class j{static now(){return j.fromMillis(Date.now())}static fromDate(e){return j.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new j(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new k(C.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new k(C.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?z(this.nanoseconds,e.nanoseconds):z(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Q{static fromTimestamp(e){return new Q(e)}static min(){return new Q(new j(0,0))}static max(){return new Q(new j(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}let W="__name__";class H{constructor(e,t,n){void 0===t?t=0:t>e.length&&x(),void 0===n?n=e.length-t:n>e.length-t&&x(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===H.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof H?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=H.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return z(e.length,t.length)}static compareSegments(e,t){let n=H.isNumericId(e),r=H.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?H.extractNumericId(e).compare(H.extractNumericId(t)):K(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class Y extends H{construct(e,t,n){return new Y(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new k(C.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new Y(t)}static emptyPath(){return new Y([])}}let Z=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class J extends H{construct(e,t,n){return new J(e,t,n)}static isValidIdentifier(e){return Z.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),J.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===W}static keyField(){return new J([W])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new k(C.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new k(C.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new k(C.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new k(C.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new J(t)}static emptyPath(){return new J([])}}class X{constructor(e){this.path=e}static fromPath(e){return new X(Y.fromString(e))}static fromName(e){return new X(Y.fromString(e).popFirst(5))}static empty(){return new X(Y.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===Y.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return Y.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new X(new Y(e.slice()))}}class ee{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function et(e){return e.fields.find(e=>2===e.kind)}function en(e){return e.fields.filter(e=>2!==e.kind)}function er(e,t){let n=z(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(0!==(n=function(e,t){let n=J.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:z(e.kind,t.kind)}(e.fields[r],t.fields[r])))return n;return z(e.fields.length,t.fields.length)}ee.UNKNOWN_ID=-1;class ei{constructor(e,t){this.fieldPath=e,this.kind=t}}class es{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new es(0,el.min())}}function ea(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new el(Q.fromTimestamp(1e9===r?new j(n+1,0):new j(n,r)),X.empty(),t)}function eo(e){return new el(e.readTime,e.key,-1)}class el{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new el(Q.min(),X.empty(),-1)}static max(){return new el(Q.max(),X.empty(),-1)}}function eu(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=X.comparator(e.documentKey,t.documentKey))?n:z(e.largestBatchId,t.largestBatchId)}let eh="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ec{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ed(e){if(e.code!==C.FAILED_PRECONDITION||e.message!==eh)throw e;T("LocalStore","Unexpectedly lost primary lease")}class ef{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&x(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ef((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ef?t:ef.resolve(t)}catch(e){return ef.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ef.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ef.reject(t)}static resolve(e){return new ef((t,n)=>{t(e)})}static reject(e){return new ef((t,n)=>{n(e)})}static waitFor(e){return new ef((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ef.resolve(!1);for(let n of e)t=t.next(e=>e?ef.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ef((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ef((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let em="SimpleDb";class eg{static open(e,t,n,r){try{return new eg(t,e.transaction(r,n))}catch(e){throw new ev(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.m=new D,this.transaction.oncomplete=()=>{this.m.resolve()},this.transaction.onabort=()=>{t.error?this.m.reject(new ev(e,t.error)):this.m.resolve()},this.transaction.onerror=t=>{let n=eE(t.target.error);this.m.reject(new ev(e,n))}}get p(){return this.m.promise}abort(e){e&&this.m.reject(e),this.aborted||(T(em,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}S(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new e_(this.transaction.objectStore(e))}}class ep{static delete(e){return T(em,"Removing database:",e),eT(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(ep.v())return!0;let e=(0,h.ZQ)(),t=ep.C(e),n=ey(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static v(){var e;return void 0!==f&&"YES"===(null==(e=f.__PRIVATE_env)?void 0:e.F)}static M(e,t){return e.store(t)}static C(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.O=n,12.2===ep.C((0,h.ZQ)())&&b("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async N(e){return this.db||(T(em,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new ev(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new k(C.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new k(C.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ev(e,r))},r.onupgradeneeded=e=>{T(em,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.O.B(t,r.transaction,e.oldVersion,this.version).next(()=>{T(em,"Database upgrade to version "+this.version+" complete")})}})),this.L&&(this.db.onversionchange=e=>this.L(e)),this.db}k(e){this.L=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.N(e);let t=eg.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.S(),e)).catch(e=>(t.abort(e),ef.reject(e))).toPromise();return s.catch(()=>{}),await t.p,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(em,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ey(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class ew{constructor(e){this.q=e,this.$=!1,this.U=null}get isDone(){return this.$}get K(){return this.U}set cursor(e){this.q=e}done(){this.$=!0}W(e){this.U=e}delete(){return eT(this.q.delete())}}class ev extends k{constructor(e,t){super(C.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eI(e){return"IndexedDbTransactionError"===e.name}class e_{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(T(em,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(T(em,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eT(n)}add(e){return T(em,"ADD",this.store.name,e,e),eT(this.store.add(e))}get(e){return eT(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(em,"GET",this.store.name,e,t),t))}delete(e){return T(em,"DELETE",this.store.name,e),eT(this.store.delete(e))}count(){return T(em,"COUNT",this.store.name),eT(this.store.count())}G(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ef((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.j(e,(e,n)=>{t.push(n)}).next(()=>t)}}H(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ef((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}J(e,t){T(em,"DELETE ALL",this.store.name);let n=this.options(e,t);n.Y=!1;let r=this.cursor(n);return this.j(r,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.j(r,t)}X(e){let t=this.cursor({});return new ef((n,r)=>{t.onerror=e=>{r(eE(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}j(e,t){let n=[];return new ef((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new ew(i),a=t(i.primaryKey,i.value,s);if(a instanceof ef){let e=a.catch(e=>(s.done(),ef.reject(e)));n.push(e)}s.isDone?r():null===s.K?i.continue():i.continue(s.K)}}).next(()=>ef.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eT(e){return new ef((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eE(e.target.error))}})}let eb=!1;function eE(e){let t=ep.C((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eb||(eb=!0,setTimeout(()=>{throw e},0)),e}}return e}let eS="IndexBackfiller";class ex{constructor(e,t){this.asyncQueue=e,this.ee=t,this.task=null}start(){this.te(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}te(e){T(eS,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ee.ne();T(eS,`Documents written: ${e}`)}catch(e){eI(e)?T(eS,"Ignoring IndexedDB error during index backfill: ",e):await ed(e)}await this.te(6e4)})}}class eN{constructor(e,t){this.localStore=e,this.persistence=t}async ne(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.re(t,e))}re(e,t){let n=new Set,r=t,i=!0;return ef.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return T(eS,`Processing collection: ${t}`),this.ie(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}ie(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.se(r,n)).next(n=>(T(eS,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}se(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=eo(t);eu(r,n)>0&&(n=r)}),new el(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eC{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.oe(e),this._e=e=>t.writeSequenceNumber(e))}oe(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this._e&&this._e(e),e}}function ek(e){return null==e}function eD(e){return 0===e&&1/e==-1/0}function eA(e){return"number"==typeof e&&Number.isInteger(e)&&!eD(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eR(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}eC.ae=-1;function eV(e){let t=e.length;if(t>=2||x(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||x(),Y.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&x(),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:x()}s=t+2}return new Y(r)}let eM="remoteDocuments",eF="owner",eO="owner",eL="mutationQueues",eP="mutations",eq="batchId",eU="userMutationsIndex",eB=["userId","batchId"],ez={},eK="documentMutations",e$="remoteDocumentsV14",eG=["prefixPath","collectionGroup","readTime","documentId"],ej="documentKeyIndex",eQ=["prefixPath","collectionGroup","documentId"],eW="collectionGroupIndex",eH=["collectionGroup","readTime","prefixPath","documentId"],eY="remoteDocumentGlobal",eZ="remoteDocumentGlobalKey",eJ="targets",eX="queryTargetsIndex",e0=["canonicalId","targetId"],e1="targetDocuments",e2=["targetId","path"],e5="documentTargetsIndex",e8=["path","targetId"],e3="targetGlobalKey",e4="targetGlobal",e6="collectionParents",e9=["collectionId","parent"],e7="clientMetadata",te="bundles",tt="namedQueries",tn="indexConfiguration",tr="collectionGroupIndex",ti="indexState",ts=["indexId","uid"],ta="sequenceNumberIndex",to=["uid","sequenceNumber"],tl="indexEntries",tu=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],th="documentKeyIndex",tc=["indexId","uid","orderedDocumentKey"],td="documentOverlays",tf=["userId","collectionPath","documentId"],tm="collectionPathOverlayIndex",tg=["userId","collectionPath","largestBatchId"],tp="collectionGroupOverlayIndex",ty=["userId","collectionGroup","largestBatchId"],tw="globals",tv=[eL,eP,eK,eM,eJ,eF,e4,e1,e7,eY,e6,te,tt],tI=[...tv,td],t_=[eL,eP,eK,e$,eJ,eF,e4,e1,e7,eY,e6,te,tt,td],tT=[...t_,tn,ti,tl],tb=[...tT,tw];class tE extends ec{constructor(e,t){super(),this.ue=e,this.currentSequenceNumber=t}}function tS(e,t){return ep.M(e.ue,t)}function tx(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tN(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tC(e,t){let n=[];for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}function tk(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tD{constructor(e,t){this.comparator=e,this.root=t||tR.EMPTY}insert(e,t){return new tD(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tR.BLACK,null,null))}remove(e){return new tD(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tR.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tA(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tA(this.root,e,this.comparator,!1)}getReverseIterator(){return new tA(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tA(this.root,e,this.comparator,!0)}}class tA{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tR{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tR.RED,this.left=null!=r?r:tR.EMPTY,this.right=null!=i?i:tR.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tR(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tR.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tR.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tR.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tR.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw x();let e=this.left.check();if(e!==this.right.check())throw x();return e+ +!this.isRed()}}tR.EMPTY=null,tR.RED=!0,tR.BLACK=!1,tR.EMPTY=new class{constructor(){this.size=0}get key(){throw x()}get value(){throw x()}get color(){throw x()}get left(){throw x()}get right(){throw x()}copy(e,t,n,r,i){return this}insert(e,t,n){return new tR(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tV{constructor(e){this.comparator=e,this.data=new tD(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tM(this.data.getIterator())}getIteratorFrom(e){return new tM(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tV)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tV(this.comparator);return t.data=e,t}}class tM{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tF(e){return e.hasNext()?e.getNext():void 0}class tO{constructor(e){this.fields=e,e.sort(J.comparator)}static empty(){return new tO([])}unionWith(e){let t=new tV(J.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tO(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return G(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tL extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function tP(){return"undefined"!=typeof atob}class tq{constructor(e){this.binaryString=e}static fromBase64String(e){return new tq(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tL("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tq(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return z(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tq.EMPTY_BYTE_STRING=new tq("");let tU=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function tB(e){if(e||x(),"string"==typeof e){let t=0,n=tU.exec(e);if(n||x(),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tz(e.seconds),nanos:tz(e.nanos)}}function tz(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tK(e){return"string"==typeof e?tq.fromBase64String(e):tq.fromUint8Array(e)}let t$="server_timestamp",tG="__type__",tj="__previous_value__",tQ="__local_write_time__";function tW(e){var t,n;return(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[tG])?void 0:n.stringValue)===t$}function tH(e){let t=e.mapValue.fields[tj];return tW(t)?tH(t):t}function tY(e){let t=tB(e.mapValue.fields[tQ].timestampValue);return new j(t.seconds,t.nanos)}class tZ{constructor(e,t,n,r,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}let tJ="(default)";class tX{constructor(e,t){this.projectId=e,this.database=t||tJ}static empty(){return new tX("","")}get isDefaultDatabase(){return this.database===tJ}isEqual(e){return e instanceof tX&&e.projectId===this.projectId&&e.database===this.database}}let t0="__type__",t1="__max__",t2={mapValue:{fields:{__type__:{stringValue:t1}}}},t5="__vector__",t8="value",t3={nullValue:"NULL_VALUE"};function t4(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tW(e)?4:nc(e)?0x1fffffffffffff:nu(e)?10:11:x()}function t6(e,t){if(e===t)return!0;let n=t4(e);if(n!==t4(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tY(e).isEqual(tY(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=tB(e.timestampValue),i=tB(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return tK(e.bytesValue).isEqual(tK(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tz(e.geoPointValue.latitude)===tz(t.geoPointValue.latitude)&&tz(e.geoPointValue.longitude)===tz(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return tz(e.integerValue)===tz(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tz(e.doubleValue),r=tz(t.doubleValue);return n===r?eD(n)===eD(r):isNaN(n)&&isNaN(r)}return!1;case 9:return G(e.arrayValue.values||[],t.arrayValue.values||[],t6);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(tx(s)!==tx(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!t6(s[e],a[e])))return!1;return!0;default:return x()}}function t9(e,t){return void 0!==(e.values||[]).find(e=>t6(e,t))}function t7(e,t){if(e===t)return 0;let n=t4(e),r=t4(t);if(n!==r)return z(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return z(e.booleanValue,t.booleanValue);case 2:let i=tz(e.integerValue||e.doubleValue),s=tz(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return ne(e.timestampValue,t.timestampValue);case 4:return ne(tY(e),tY(t));case 5:return K(e.stringValue,t.stringValue);case 6:return function(e,t){let n=tK(e),r=tK(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=z(n[e],r[e]);if(0!==t)return t}return z(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=z(tz(e.latitude),tz(t.latitude));return 0!==n?n:z(tz(e.longitude),tz(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return nt(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null==(n=a[t8])?void 0:n.arrayValue,u=null==(r=o[t8])?void 0:r.arrayValue,h=z((null==(i=null==l?void 0:l.values)?void 0:i.length)||0,(null==(s=null==u?void 0:u.values)?void 0:s.length)||0);return 0!==h?h:nt(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===t2.mapValue&&t===t2.mapValue)return 0;if(e===t2.mapValue)return 1;if(t===t2.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=K(r[e],s[e]);if(0!==t)return t;let a=t7(n[r[e]],i[s[e]]);if(0!==a)return a}return z(r.length,s.length)}(e.mapValue,t.mapValue);default:throw x()}}function ne(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return z(e,t);let n=tB(e),r=tB(t),i=z(n.seconds,r.seconds);return 0!==i?i:z(n.nanos,r.nanos)}function nt(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=t7(n[e],r[e]);if(t)return t}return z(n.length,r.length)}function nn(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=tB(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tK(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,X.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=nn(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${nn(e.fields[i])}`;return n+"}"}(e.mapValue):x()}function nr(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function ni(e){return!!e&&"integerValue"in e}function ns(e){return!!e&&"arrayValue"in e}function na(e){return!!e&&"nullValue"in e}function no(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nl(e){return!!e&&"mapValue"in e}function nu(e){var t,n;return(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{})[t0])?void 0:n.stringValue)===t5}function nh(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return tN(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nh(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nh(e.arrayValue.values[n]);return t}return Object.assign({},e)}function nc(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===t1}let nd={mapValue:{fields:{[t0]:{stringValue:t5},[t8]:{arrayValue:{}}}}};function nf(e,t){let n=t7(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function nm(e,t){let n=t7(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ng{constructor(e){this.value=e}static empty(){return new ng({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nl(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nh(t)}setAll(e){let t=J.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nh(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nl(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return t6(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nl(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tN(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new ng(nh(this.value))}}class np{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new np(e,0,Q.min(),Q.min(),Q.min(),ng.empty(),0)}static newFoundDocument(e,t,n,r){return new np(e,1,t,Q.min(),n,r,0)}static newNoDocument(e,t){return new np(e,2,t,Q.min(),Q.min(),ng.empty(),0)}static newUnknownDocument(e,t){return new np(e,3,t,Q.min(),Q.min(),ng.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(Q.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ng.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ng.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Q.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof np&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new np(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ny{constructor(e,t){this.position=e,this.inclusive=t}}function nw(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?X.comparator(X.fromName(a.referenceValue),n.key):t7(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nv(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!t6(e.position[n],t.position[n]))return!1;return!0}class nI{constructor(e,t="asc"){this.field=e,this.dir=t}}class n_{}class nT extends n_{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nk(e,t,n):"array-contains"===t?new nV(e,n):"in"===t?new nM(e,n):"not-in"===t?new nF(e,n):"array-contains-any"===t?new nO(e,n):new nT(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nD(e,n):new nA(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(t7(t,this.value)):null!==t&&t4(this.value)===t4(t)&&this.matchesComparison(t7(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return x()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nb extends n_{constructor(e,t){super(),this.filters=e,this.op=t,this.ce=null}static create(e,t){return new nb(e,t)}matches(e){return nE(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ce||(this.ce=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ce}getFilters(){return Object.assign([],this.filters)}}function nE(e){return"and"===e.op}function nS(e){return"or"===e.op}function nx(e){return nN(e)&&nE(e)}function nN(e){for(let t of e.filters)if(t instanceof nb)return!1;return!0}function nC(e,t){let n=e.filters.concat(t);return nb.create(n,e.op)}class nk extends nT{constructor(e,t,n){super(e,t,n),this.key=X.fromName(n.referenceValue)}matches(e){let t=X.comparator(e.key,this.key);return this.matchesComparison(t)}}class nD extends nT{constructor(e,t){super(e,"in",t),this.keys=nR("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nA extends nT{constructor(e,t){super(e,"not-in",t),this.keys=nR("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function nR(e,t){var n;return((null==(n=t.arrayValue)?void 0:n.values)||[]).map(e=>X.fromName(e.referenceValue))}class nV extends nT{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ns(t)&&t9(t.arrayValue,this.value)}}class nM extends nT{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&t9(this.value.arrayValue,t)}}class nF extends nT{constructor(e,t){super(e,"not-in",t)}matches(e){if(t9(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!t9(this.value.arrayValue,t)}}class nO extends nT{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ns(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>t9(this.value.arrayValue,e))}}class nL{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.le=null}}function nP(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nL(e,t,n,r,i,s,a)}function nq(e){if(null===e.le){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nT)return t.field.canonicalString()+t.op.toString()+nn(t.value);if(nx(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),ek(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>nn(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>nn(e)).join(",")),e.le=t}return e.le}function nU(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nT?n instanceof nT&&t.op===n.op&&t.field.isEqual(n.field)&&t6(t.value,n.value):t instanceof nb?n instanceof nb&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void x()}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nv(e.startAt,t.startAt)&&nv(e.endAt,t.endAt)}function nB(e){return X.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nz(e,t){return e.filters.filter(e=>e instanceof nT&&e.field.isEqual(t))}function nK(e,t,n){let r=t3,i=!0;for(let n of nz(e,t)){let e=t3,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?t3:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?nr(tX.empty(),X.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nu(s)?nd:{mapValue:{}}:x();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=t3}0>nf({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>nf({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function n$(e,t,n){let r=t2,i=!0;for(let n of nz(e,t)){let e=t2,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?nr(tX.empty(),X.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?nd:"mapValue"in s?nu(s)?{mapValue:{}}:t2:x(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=t2}nm({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];nm({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nG{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.he=null,this.Pe=null,this.Te=null,this.startAt,this.endAt}}function nj(e){return new nG(e)}function nQ(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nW(e){return null!==e.collectionGroup}function nH(e){if(null===e.he){let t;e.he=[];let n=new Set;for(let t of e.explicitOrderBy)e.he.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tV(J.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.he.push(new nI(t,r))}),n.has(J.keyField().canonicalString())||e.he.push(new nI(J.keyField(),r))}return e.he}function nY(e){return e.Pe||(e.Pe=nJ(e,nH(e))),e.Pe}function nZ(e){return e.Te||(e.Te=nJ(e,e.explicitOrderBy)),e.Te}function nJ(e,t){if("F"===e.limitType)return nP(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nI(e.field,t)});let n=e.endAt?new ny(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new ny(e.startAt.position,e.startAt.inclusive):null;return nP(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function nX(e,t){let n=e.filters.concat([t]);return new nG(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function n0(e,t,n){return new nG(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function n1(e,t){return nU(nY(e),nY(t))&&e.limitType===t.limitType}function n2(e){return`${nq(nY(e))}|lt:${e.limitType}`}function n5(e){var t;let n;return`Query(target=${n=(t=nY(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nT?`${t.field.canonicalString()} ${t.op} ${nn(t.value)}`:t instanceof nb?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),ek(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>nn(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>nn(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function n8(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):X.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nH(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nw(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nH(e),t))&&(!e.endAt||!!function(e,t,n){let r=nw(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nH(e),t))}function n3(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function n4(e){return(t,n)=>{let r=!1;for(let i of nH(e)){let e=function(e,t,n){let r=e.field.isKeyField()?X.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?t7(r,i):x()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return x()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class n6{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tN(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tk(this.inner)}size(){return this.innerSize}}let n9=new tD(X.comparator),n7=new tD(X.comparator);function re(...e){let t=n7;for(let n of e)t=t.insert(n.key,n);return t}function rt(e){let t=n7;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rn(){return new n6(e=>e.toString(),(e,t)=>e.isEqual(t))}let rr=new tD(X.comparator),ri=new tV(X.comparator);function rs(...e){let t=ri;for(let n of e)t=t.add(n);return t}let ra=new tV(z);function ro(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eD(t)?"-0":t}}function rl(e){return{integerValue:""+e}}function ru(e,t){return eA(t)?rl(t):ro(e,t)}class rh{constructor(){this._=void 0}}function rc(e,t){return e instanceof ry?ni(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rd extends rh{}class rf extends rh{constructor(e){super(),this.elements=e}}function rm(e,t){let n=rv(t);for(let t of e.elements)n.some(e=>t6(e,t))||n.push(t);return{arrayValue:{values:n}}}class rg extends rh{constructor(e){super(),this.elements=e}}function rp(e,t){let n=rv(t);for(let t of e.elements)n=n.filter(e=>!t6(e,t));return{arrayValue:{values:n}}}class ry extends rh{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function rw(e){return tz(e.integerValue||e.doubleValue)}function rv(e){return ns(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rI{constructor(e,t){this.field=e,this.transform=t}}class r_{constructor(e,t){this.version=e,this.transformResults=t}}class rT{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rT}static exists(e){return new rT(void 0,e)}static updateTime(e){return new rT(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function rb(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rE{}function rS(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rV(e.key,rT.none()):new rC(e.key,e.data,rT.none());{let n=e.data,r=ng.empty(),i=new tV(J.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rk(e.key,r,new tO(i.toArray()),rT.none())}}function rx(e,t,n,r){return e instanceof rC?function(e,t,n,r){if(!rb(e.precondition,t))return n;let i=e.value.clone(),s=rR(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rk?function(e,t,n,r){if(!rb(e.precondition,t))return n;let i=rR(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rD(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):rb(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rN(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&G(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rf&&r instanceof rf||n instanceof rg&&r instanceof rg?G(n.elements,r.elements,t6):n instanceof ry&&r instanceof ry?t6(n.Ie,r.Ie):n instanceof rd&&r instanceof rd)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rC extends rE{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rk extends rE{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rD(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rA(e,t,n){var r;let i=new Map;e.length===n.length||x();for(let s=0;s<n.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(r=n[s],o instanceof rf?rm(o,l):o instanceof rg?rp(o,l):r))}return i}function rR(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rd?function(e,t){let n={fields:{[tG]:{stringValue:t$},[tQ]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tW(t)&&(t=tH(t)),t&&(n.fields[tj]=t),{mapValue:n}}(t,s):e instanceof rf?rm(e,s):e instanceof rg?rp(e,s):function(e,t){let n=rc(e,t),r=rw(n)+rw(e.Ie);return ni(n)&&ni(e.Ie)?rl(r):ro(e.serializer,r)}(e,s))}return r}class rV extends rE{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rM extends rE{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rF{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){e instanceof rC?function(e,t,n){let r=e.value.clone(),i=rA(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof rk?function(e,t,n){if(!rb(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=rA(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rD(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rx(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rx(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=rn();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rS(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(Q.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),rs())}isEqual(e){return this.batchId===e.batchId&&G(this.mutations,e.mutations,(e,t)=>rN(e,t))&&G(this.baseMutations,e.baseMutations,(e,t)=>rN(e,t))}}class rO{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){e.mutations.length===n.length||x();let r=rr,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rO(e,t,n,r)}}class rL{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rP{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class rq{constructor(e,t){this.count=e,this.unchangedNames=t}}function rU(e){switch(e){case C.OK:return x();case C.CANCELLED:case C.UNKNOWN:case C.DEADLINE_EXCEEDED:case C.RESOURCE_EXHAUSTED:case C.INTERNAL:case C.UNAVAILABLE:case C.UNAUTHENTICATED:return!1;case C.INVALID_ARGUMENT:case C.NOT_FOUND:case C.ALREADY_EXISTS:case C.PERMISSION_DENIED:case C.FAILED_PRECONDITION:case C.ABORTED:case C.OUT_OF_RANGE:case C.UNIMPLEMENTED:case C.DATA_LOSS:return!0;default:return x()}}function rB(e){if(void 0===e)return b("GRPC error has no .code"),C.UNKNOWN;switch(e){case r.OK:return C.OK;case r.CANCELLED:return C.CANCELLED;case r.UNKNOWN:return C.UNKNOWN;case r.DEADLINE_EXCEEDED:return C.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return C.RESOURCE_EXHAUSTED;case r.INTERNAL:return C.INTERNAL;case r.UNAVAILABLE:return C.UNAVAILABLE;case r.UNAUTHENTICATED:return C.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return C.INVALID_ARGUMENT;case r.NOT_FOUND:return C.NOT_FOUND;case r.ALREADY_EXISTS:return C.ALREADY_EXISTS;case r.PERMISSION_DENIED:return C.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return C.FAILED_PRECONDITION;case r.ABORTED:return C.ABORTED;case r.OUT_OF_RANGE:return C.OUT_OF_RANGE;case r.UNIMPLEMENTED:return C.UNIMPLEMENTED;case r.DATA_LOSS:return C.DATA_LOSS;default:return x()}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rz=null,rK=new c.jz([0xffffffff,0xffffffff],0);function r$(e){let t=U().encode(e),n=new c.VV;return n.update(t),new Uint8Array(n.digest())}function rG(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([n,r],0),new c.jz([i,s],0)]}class rj{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rQ(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rQ(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rQ(`Invalid padding when bitmap length is 0: ${t}`);this.Ee=8*e.length-t,this.de=c.jz.fromNumber(this.Ee)}Ae(e,t,n){let r=e.add(t.multiply(c.jz.fromNumber(n)));return 1===r.compare(rK)&&(r=new c.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.de).toNumber()}Re(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ee)return!1;let[t,n]=rG(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);if(!this.Re(r))return!1}return!0}static create(e,t,n){let r=new rj(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.Ee)return;let[t,n]=rG(r$(e));for(let e=0;e<this.hashCount;e++){let r=this.Ae(t,n,e);this.Ve(r)}}Ve(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rQ extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rW{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rH.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rW(Q.min(),r,new tD(z),n9,rs())}}class rH{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rH(n,t,rs(),rs(),rs())}}class rY{constructor(e,t,n,r){this.me=e,this.removedTargetIds=t,this.key=n,this.fe=r}}class rZ{constructor(e,t){this.targetId=e,this.ge=t}}class rJ{constructor(e,t,n=tq.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rX{constructor(){this.pe=0,this.ye=r2(),this.we=tq.EMPTY_BYTE_STRING,this.Se=!1,this.be=!0}get current(){return this.Se}get resumeToken(){return this.we}get De(){return 0!==this.pe}get ve(){return this.be}Ce(e){e.approximateByteSize()>0&&(this.be=!0,this.we=e)}Fe(){let e=rs(),t=rs(),n=rs();return this.ye.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:x()}}),new rH(this.we,this.Se,e,t,n)}Me(){this.be=!1,this.ye=r2()}xe(e,t){this.be=!0,this.ye=this.ye.insert(e,t)}Oe(e){this.be=!0,this.ye=this.ye.remove(e)}Ne(){this.pe+=1}Be(){this.pe-=1,this.pe>=0||x()}Le(){this.be=!0,this.Se=!0}}class r0{constructor(e){this.ke=e,this.qe=new Map,this.Qe=n9,this.$e=r1(),this.Ue=r1(),this.Ke=new tD(z)}We(e){for(let t of e.me)e.fe&&e.fe.isFoundDocument()?this.Ge(t,e.fe):this.ze(t,e.key,e.fe);for(let t of e.removedTargetIds)this.ze(t,e.key,e.fe)}je(e){this.forEachTarget(e,t=>{let n=this.He(t);switch(e.state){case 0:this.Je(t)&&n.Ce(e.resumeToken);break;case 1:n.Be(),n.De||n.Me(),n.Ce(e.resumeToken);break;case 2:n.Be(),n.De||this.removeTarget(t);break;case 3:this.Je(t)&&(n.Le(),n.Ce(e.resumeToken));break;case 4:this.Je(t)&&(this.Ye(t),n.Ce(e.resumeToken));break;default:x()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.qe.forEach((e,n)=>{this.Je(n)&&t(n)})}Ze(e){let t=e.targetId,n=e.ge.count,r=this.Xe(t);if(r){let i=r.target;if(nB(i))if(0===n){let e=new X(i.path);this.ze(t,e,np.newNoDocument(e,Q.min()))}else 1===n||x();else{let r=this.et(t);if(r!==n){let n=this.tt(e),i=n?this.nt(n,e,r):1;0!==i&&(this.Ye(t),this.Ke=this.Ke.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch")),null==rz||rz.rt(function(e,t,n,r,i){var s,a,o,l,u,h;let c={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(c.bloomFilter={applied:0===i,hashCount:null!=(s=null==d?void 0:d.hashCount)?s:0,bitmapLength:null!=(l=null==(o=null==(a=null==d?void 0:d.bits)?void 0:a.bitmap)?void 0:o.length)?l:0,padding:null!=(h=null==(u=null==d?void 0:d.bits)?void 0:u.padding)?h:0,mightContain:e=>{var t;return null!=(t=null==r?void 0:r.mightContain(e))&&t}}),c}(r,e.ge,this.ke.it(),n,i))}}}}tt(e){let t,n,r=e.ge.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=tK(i).toUint8Array()}catch(e){if(e instanceof tL)return E("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new rj(t,s,a)}catch(e){return E(e instanceof rQ?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.Ee?null:n}nt(e,t,n){return 2*(t.ge.count!==n-this.st(e,t.targetId))}st(e,t){let n=this.ke.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.ke.it(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.ze(t,n,null),r++)}),r}ot(e){let t=new Map;this.qe.forEach((n,r)=>{let i=this.Xe(r);if(i){if(n.current&&nB(i.target)){let t=new X(i.target.path);this._t(t).has(r)||this.ut(r,t)||this.ze(r,t,np.newNoDocument(t,e))}n.ve&&(t.set(r,n.Fe()),n.Me())}});let n=rs();this.Ue.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.Xe(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.Qe.forEach((t,n)=>n.setReadTime(e));let r=new rW(e,t,this.Ke,this.Qe,n);return this.Qe=n9,this.$e=r1(),this.Ue=r1(),this.Ke=new tD(z),r}Ge(e,t){if(!this.Je(e))return;let n=2*!!this.ut(e,t.key);this.He(e).xe(t.key,n),this.Qe=this.Qe.insert(t.key,t),this.$e=this.$e.insert(t.key,this._t(t.key).add(e)),this.Ue=this.Ue.insert(t.key,this.ct(t.key).add(e))}ze(e,t,n){if(!this.Je(e))return;let r=this.He(e);this.ut(e,t)?r.xe(t,1):r.Oe(t),this.Ue=this.Ue.insert(t,this.ct(t).delete(e)),this.Ue=this.Ue.insert(t,this.ct(t).add(e)),n&&(this.Qe=this.Qe.insert(t,n))}removeTarget(e){this.qe.delete(e)}et(e){let t=this.He(e).Fe();return this.ke.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ne(e){this.He(e).Ne()}He(e){let t=this.qe.get(e);return t||(t=new rX,this.qe.set(e,t)),t}ct(e){let t=this.Ue.get(e);return t||(t=new tV(z),this.Ue=this.Ue.insert(e,t)),t}_t(e){let t=this.$e.get(e);return t||(t=new tV(z),this.$e=this.$e.insert(e,t)),t}Je(e){let t=null!==this.Xe(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}Xe(e){let t=this.qe.get(e);return t&&t.De?null:this.ke.lt(e)}Ye(e){this.qe.set(e,new rX),this.ke.getRemoteKeysForTarget(e).forEach(t=>{this.ze(e,t,null)})}ut(e,t){return this.ke.getRemoteKeysForTarget(e).has(t)}}function r1(){return new tD(X.comparator)}function r2(){return new tD(X.comparator)}let r5={asc:"ASCENDING",desc:"DESCENDING"},r8={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},r3={and:"AND",or:"OR"};class r4{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function r6(e,t){return e.useProto3Json||ek(t)?t:{value:t}}function r9(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function r7(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function ie(e){return e||x(),Q.fromTimestamp(function(e){let t=tB(e);return new j(t.seconds,t.nanos)}(e))}function it(e,t){return ir(e,t).canonicalString()}function ir(e,t){let n=new Y(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function ii(e){let t=Y.fromString(e);return iT(t)||x(),t}function is(e,t){return it(e.databaseId,t.path)}function ia(e,t){let n=ii(t);if(n.get(1)!==e.databaseId.projectId)throw new k(C.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new k(C.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new X(ih(n))}function io(e,t){return it(e.databaseId,t)}function il(e){let t=ii(e);return 4===t.length?Y.emptyPath():ih(t)}function iu(e){return new Y(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ih(e){return e.length>4&&"documents"===e.get(4)||x(),e.popFirst(5)}function ic(e,t,n){return{name:is(e,t),fields:n.value.mapValue.fields}}function id(e,t,n){let r=ia(e,t.name),i=ie(t.updateTime),s=t.createTime?ie(t.createTime):Q.min(),a=new ng({mapValue:{fields:t.fields}}),o=np.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function im(e,t){var n;let r;if(t instanceof rC)r={update:ic(e,t.key,t.value)};else if(t instanceof rV)r={delete:is(e,t.key)};else if(t instanceof rk)r={update:ic(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rM))return x();r={verify:is(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rd)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rf)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rg)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof ry)return{fieldPath:t.field.canonicalString(),increment:n.Ie};throw x()})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:r9(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:x()),r}function ig(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rT.updateTime(ie(n.updateTime)):void 0!==n.exists?rT.exists(n.exists):rT.none():rT.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{var n,r;let i;return n=e,i=null,"setToServerValue"in(r=t)?("REQUEST_TIME"===r.setToServerValue||x(),i=new rd):"appendMissingElements"in r?i=new rf(r.appendMissingElements.values||[]):"removeAllFromArray"in r?i=new rg(r.removeAllFromArray.values||[]):"increment"in r?i=new ry(n,r.increment):x(),new rI(J.fromServerFormat(r.fieldPath),i)}):[];if(t.update){t.update.name;let n=ia(e,t.update.name),s=new ng({mapValue:{fields:t.update.fields}});return t.updateMask?new rk(n,s,new tO((t.updateMask.fieldPaths||[]).map(e=>J.fromServerFormat(e))),r,i):new rC(n,s,r,i)}return t.delete?new rV(ia(e,t.delete),r):t.verify?new rM(ia(e,t.verify),r):x()}function ip(e,t){return{documents:[io(e,t.path)]}}function iy(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=io(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof nT?function(e){if("=="===e.op){if(no(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NAN"}};if(na(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(no(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NOT_NAN"}};if(na(e.value))return{unaryFilter:{field:iI(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iI(e.field),op:r8[e.op],value:e.value}}}(t):t instanceof nb?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:r3[t.op],filters:n}}}(t):x()}(nb.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iI(e.field),direction:r5[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=r6(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ht:s,parent:i}}function iw(e,t,n,r){let{ht:i,parent:s}=iy(e,t),a={},o=[],l=0;return n.forEach(e=>{let t=r?e.alias:"aggregate_"+l++;a[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:iI(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:iI(e.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:i.structuredQuery},parent:i.parent},Pt:a,parent:s}}function iv(e){var t;let n,r=il(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||x();let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=i_(e.unaryFilter.field);return nT.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=i_(e.unaryFilter.field);return nT.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=i_(e.unaryFilter.field);return nT.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=i_(e.unaryFilter.field);return nT.create(i,"!=",{nullValue:"NULL_VALUE"});default:return x()}}(t):void 0!==t.fieldFilter?nT.create(i_(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return x()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nb.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return x()}}(t.compositeFilter.op)):x()}(e);return t instanceof nb&&nx(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nI(i_(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=ek(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new ny(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new ny(e.values||[],t)}(i.endAt)),new nG(r,a,l,o,u,"F",h,c)}function iI(e){return{fieldPath:e.canonicalString()}}function i_(e){return J.fromServerFormat(e.fieldPath)}function iT(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class ib{constructor(e,t,n,r,i=Q.min(),s=Q.min(),a=tq.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new ib(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new ib(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iE{constructor(e){this.Tt=e}}function iS(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ix(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:is(i=e.Tt,t.key),fields:t.data.value.mapValue.fields,updateTime:r9(i,t.version.toTimestamp()),createTime:r9(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:iN(t.version)};else{if(!t.isUnknownDocument())return x();r.unknownDocument={path:n.path.toArray(),version:iN(t.version)}}return r}function ix(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function iN(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iC(e){let t=new j(e.seconds,e.nanoseconds);return Q.fromTimestamp(t)}function ik(e,t){let n=(t.baseMutations||[]).map(t=>ig(e.Tt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>ig(e.Tt,t)),i=j.fromMillis(t.localWriteTimeMs);return new rF(t.batchId,i,n,r)}function iD(e){var t;let n=iC(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?iC(e.lastLimboFreeSnapshotVersion):Q.min();return new ib(void 0!==e.query.documents?(1===(t=e.query).documents.length||x(),nY(nj(il(t.documents[0])))):nY(iv(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,tq.fromBase64String(e.resumeToken))}function iA(e,t){let n,r=iN(t.snapshotVersion),i=iN(t.lastLimboFreeSnapshotVersion);n=nB(t.target)?ip(e.Tt,t.target):iy(e.Tt,t.target).ht;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nq(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iR(e){let t=iv({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?n0(t,t.limit,"L"):t}function iV(e,t){return new rL(t.largestBatchId,ig(e.Tt,t.overlayMutation))}function iM(e,t){let n=t.path.lastSegment();return[e,eR(t.path.popLast()),n]}function iF(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:iN(r.readTime),documentKey:eR(r.documentKey.path),largestBatchId:r.largestBatchId}}class iO{getBundleMetadata(e,t){return tS(e,te).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iC(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tS(e,te).put({bundleId:t.id,createTime:iN(ie(t.createTime)),version:t.version})}getNamedQuery(e,t){return tS(e,tt).get(t).next(e=>{if(e)return{name:e.name,query:iR(e.bundledQuery),readTime:iC(e.readTime)}})}saveNamedQuery(e,t){return tS(e,tt).put({name:t.name,readTime:iN(ie(t.readTime)),bundledQuery:t.bundledQuery})}}class iL{constructor(e,t){this.serializer=e,this.userId=t}static It(e,t){return new iL(e,t.uid||"")}getOverlay(e,t){return tS(e,td).get(iM(this.userId,t)).next(e=>e?iV(this.serializer,e):null)}getOverlays(e,t){let n=rn();return ef.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rL(t,i);r.push(this.Et(e,s))}),ef.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eR(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tS(e,td).J(tm,r))}),ef.waitFor(i)}getOverlaysForCollection(e,t,n){let r=rn(),i=eR(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tS(e,td).G(tm,s).next(e=>{for(let t of e){let e=iV(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=rn(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tS(e,td).Z({index:tp,range:a},(e,t,n)=>{let a=iV(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}Et(e,t){return tS(e,td).put(function(e,t,n){let[r,i,s]=iM(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:im(e.Tt,n.mutation)}}(this.serializer,this.userId,t))}}class iP{dt(e){return tS(e,tw)}getSessionToken(e){return this.dt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?tq.fromUint8Array(t):tq.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.dt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iq{constructor(){}At(e,t){this.Rt(e,t),t.Vt()}Rt(e,t){if("nullValue"in e)this.ft(t,5);else if("booleanValue"in e)this.ft(t,10),t.gt(+!!e.booleanValue);else if("integerValue"in e)this.ft(t,15),t.gt(tz(e.integerValue));else if("doubleValue"in e){let n=tz(e.doubleValue);isNaN(n)?this.ft(t,13):(this.ft(t,15),eD(n)?t.gt(0):t.gt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.ft(t,20),"string"==typeof n&&(n=tB(n)),t.yt(`${n.seconds||""}`),t.gt(n.nanos||0)}else if("stringValue"in e)this.wt(e.stringValue,t),this.St(t);else if("bytesValue"in e)this.ft(t,30),t.bt(tK(e.bytesValue)),this.St(t);else if("referenceValue"in e)this.Dt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.ft(t,45),t.gt(n.latitude||0),t.gt(n.longitude||0)}else"mapValue"in e?nc(e)?this.ft(t,Number.MAX_SAFE_INTEGER):nu(e)?this.vt(e.mapValue,t):(this.Ct(e.mapValue,t),this.St(t)):"arrayValue"in e?(this.Ft(e.arrayValue,t),this.St(t)):x()}wt(e,t){this.ft(t,25),this.Mt(e,t)}Mt(e,t){t.yt(e)}Ct(e,t){let n=e.fields||{};for(let e of(this.ft(t,55),Object.keys(n)))this.wt(e,t),this.Rt(n[e],t)}vt(e,t){var n,r;let i=e.fields||{};this.ft(t,53);let s=(null==(r=null==(n=i[t8].arrayValue)?void 0:n.values)?void 0:r.length)||0;this.ft(t,15),t.gt(tz(s)),this.wt(t8,t),this.Rt(i[t8],t)}Ft(e,t){let n=e.values||[];for(let e of(this.ft(t,50),n))this.Rt(e,t)}Dt(e,t){this.ft(t,37),X.fromName(e).path.forEach(e=>{this.ft(t,60),this.Mt(e,t)})}ft(e,t){e.gt(t)}St(e){e.gt(2)}}function iU(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iq.xt=new iq;class iB{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ot(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Nt(n.value),n=t.next();this.Bt()}Lt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.kt(n.value),n=t.next();this.qt()}Qt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Nt(e);else if(e<2048)this.Nt(960|e>>>6),this.Nt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Nt(480|e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e);else{let e=t.codePointAt(0);this.Nt(240|e>>>18),this.Nt(128|63&e>>>12),this.Nt(128|63&e>>>6),this.Nt(128|63&e)}}this.Bt()}$t(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.kt(e);else if(e<2048)this.kt(960|e>>>6),this.kt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.kt(480|e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e);else{let e=t.codePointAt(0);this.kt(240|e>>>18),this.kt(128|63&e>>>12),this.kt(128|63&e>>>6),this.kt(128|63&e)}}this.qt()}Ut(e){let t=this.Kt(e),n=iU(t);this.Wt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Gt(e){let t=this.Kt(e),n=iU(t);this.Wt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}zt(){this.jt(255),this.jt(255)}Ht(){this.Jt(255),this.Jt(255)}reset(){this.position=0}seed(e){this.Wt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Yt(){return this.buffer.slice(0,this.position)}Kt(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}Nt(e){let t=255&e;0===t?(this.jt(0),this.jt(255)):255===t?(this.jt(255),this.jt(0)):this.jt(t)}kt(e){let t=255&e;0===t?(this.Jt(0),this.Jt(255)):255===t?(this.Jt(255),this.Jt(0)):this.Jt(e)}Bt(){this.jt(0),this.jt(1)}qt(){this.Jt(0),this.Jt(1)}jt(e){this.Wt(1),this.buffer[this.position++]=e}Jt(e){this.Wt(1),this.buffer[this.position++]=~e}Wt(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iz{constructor(e){this.Zt=e}bt(e){this.Zt.Ot(e)}yt(e){this.Zt.Qt(e)}gt(e){this.Zt.Ut(e)}Vt(){this.Zt.zt()}}class iK{constructor(e){this.Zt=e}bt(e){this.Zt.Lt(e)}yt(e){this.Zt.$t(e)}gt(e){this.Zt.Gt(e)}Vt(){this.Zt.Ht()}}class i${constructor(){this.Zt=new iB,this.Xt=new iz(this.Zt),this.en=new iK(this.Zt)}seed(e){this.Zt.seed(e)}tn(e){return 0===e?this.Xt:this.en}Yt(){return this.Zt.Yt()}reset(){this.Zt.reset()}}class iG{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}nn(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new iG(this.indexId,this.documentKey,this.arrayValue,n)}}function ij(e,t){let n=e.indexId-t.indexId;return 0!==n||0!==(n=iQ(e.arrayValue,t.arrayValue))||0!==(n=iQ(e.directionalValue,t.directionalValue))?n:X.comparator(e.documentKey,t.documentKey)}function iQ(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class iW{constructor(e){for(let t of(this.rn=new tV((e,t)=>J.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.sn=e.orderBy,this._n=[],e.filters))t.isInequality()?this.rn=this.rn.add(t):this._n.push(t)}get an(){return this.rn.size>1}un(e){if(e.collectionGroup===this.collectionId||x(),this.an)return!1;let t=et(e);if(void 0!==t&&!this.cn(t))return!1;let n=en(e),r=new Set,i=0,s=0;for(;i<n.length&&this.cn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.rn.size>0){let e=this.rn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.ln(e,t)||!this.hn(this.sn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.sn.length||!this.hn(this.sn[s++],e))return!1}return!0}Pn(){if(this.an)return null;let e=new tV(J.comparator),t=[];for(let n of this._n)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new ei(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new ei(n.field,0))}for(let n of this.sn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new ei(n.field,+("asc"!==n.dir))));return new ee(ee.UNKNOWN_ID,this.collectionId,t,es.empty())}cn(e){for(let t of this._n)if(this.ln(t,e))return!0;return!1}ln(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}hn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iH(e){return e instanceof nT}function iY(e){return e instanceof nb&&nx(e)}function iZ(e){return iH(e)||iY(e)||function(e){if(e instanceof nb&&nS(e)){for(let t of e.getFilters())if(!iH(t)&&!iY(t))return!1;return!0}return!1}(e)}function iJ(e,t){return e instanceof nT||e instanceof nb||x(),t instanceof nT||t instanceof nb||x(),i0(e instanceof nT?t instanceof nT?nb.create([e,t],"and"):iX(e,t):t instanceof nT?iX(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||x(),nE(e)&&nE(t))return nC(e,t.getFilters());let n=nS(e)?e:t,r=nS(e)?t:e,i=n.filters.map(e=>iJ(e,r));return nb.create(i,"or")}(e,t))}function iX(e,t){if(nE(t))return nC(t,e.getFilters());{let n=t.filters.map(t=>iJ(e,t));return nb.create(n,"or")}}function i0(e){if(e instanceof nT||e instanceof nb||x(),e instanceof nT)return e;let t=e.getFilters();if(1===t.length)return i0(t[0]);if(nN(e))return e;let n=t.map(e=>i0(e)),r=[];return n.forEach(t=>{t instanceof nT?r.push(t):t instanceof nb&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nb.create(r,e.op)}class i1{constructor(){this.Tn=new i2}addToCollectionParentIndex(e,t){return this.Tn.add(t),ef.resolve()}getCollectionParents(e,t){return ef.resolve(this.Tn.getEntries(t))}addFieldIndex(e,t){return ef.resolve()}deleteFieldIndex(e,t){return ef.resolve()}deleteAllFieldIndexes(e){return ef.resolve()}createTargetIndexes(e,t){return ef.resolve()}getDocumentsMatchingTarget(e,t){return ef.resolve(null)}getIndexType(e,t){return ef.resolve(0)}getFieldIndexes(e,t){return ef.resolve([])}getNextCollectionGroupToUpdate(e){return ef.resolve(null)}getMinOffset(e,t){return ef.resolve(el.min())}getMinOffsetFromCollectionGroup(e,t){return ef.resolve(el.min())}updateCollectionGroup(e,t,n){return ef.resolve()}updateIndexEntries(e,t){return ef.resolve()}}class i2{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tV(Y.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tV(Y.comparator)).toArray()}}let i5="IndexedDbIndexManager",i8=new Uint8Array(0);class i3{constructor(e,t){this.databaseId=t,this.In=new i2,this.En=new n6(e=>nq(e),(e,t)=>nU(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.In.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.In.add(t)});let i={collectionId:n,parent:eR(r)};return tS(e,e6).put(i)}return ef.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tS(e,e6).G(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eV(r.parent))}return n})}addFieldIndex(e,t){let n=tS(e,tn),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tS(e,ti);return i.next(e=>{n.put(iF(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tS(e,tn),r=tS(e,ti),i=tS(e,tl);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tS(e,tn),n=tS(e,tl),r=tS(e,ti);return t.J().next(()=>n.J()).next(()=>r.J())}createTargetIndexes(e,t){return ef.forEach(this.dn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iW(t).Pn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tS(e,tl),r=!0,i=new Map;return ef.forEach(this.dn(t),t=>this.An(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=rs(),r=[];return ef.forEach(i,(i,s)=>{T(i5,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nq(t)}`);let a=function(e,t){let n=et(t);if(void 0===n)return null;for(let t of nz(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of en(t))for(let t of nz(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of en(t)){let t=0===i.kind?nK(e,i.fieldPath,e.startAt):n$(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new ny(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of en(t)){let t=0===i.kind?n$(e,i.fieldPath,e.endAt):nK(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new ny(n,r)}(s,i),h=this.Rn(i,s,l),c=this.Rn(i,s,u),d=this.Vn(i,s,o),f=this.mn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ef.forEach(f,i=>n.H(i,t.limit).next(t=>{t.forEach(t=>{let n=X.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ef.resolve(null)})}dn(e){let t=this.En.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof nT||t instanceof nb||x(),t instanceof nT)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nb.create(n,t.op);return iZ(r=i0(r))?r:(r instanceof nb||x(),nE(r)||x(),r.filters.length>1||x(),r.filters.reduce((e,t)=>iJ(e,t)))}(function e(t){var n,r;if(t instanceof nT||t instanceof nb||x(),t instanceof nT){if(t instanceof nM){let e=(null==(r=null==(n=t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>nT.create(t.field,"==",e)))||[];return nb.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return nb.create(i,t.op)}(e));return iZ(t)||x(),iH(t)||iY(t)?[t]:t.getFilters()})(nb.create(e.filters,"and")).map(t=>nP(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.En.set(e,t)),t}mn(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.fn(t[h/l]):i8,c=this.gn(e,o,n[h%l],r),d=this.pn(e,o,i[h%l],s),f=a.map(t=>this.gn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}gn(e,t,n,r){let i=new iG(e,X.empty(),t,n);return r?i:i.nn()}pn(e,t,n,r){let i=new iG(e,X.empty(),t,n);return r?i.nn():i}An(e,t){let n=new iW(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.un(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.dn(t);return ef.forEach(r,t=>this.An(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tV(J.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}yn(e,t){let n=new i$;for(let r of en(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.tn(r.kind);iq.xt.At(e,i)}return n.Yt()}fn(e){let t=new i$;return iq.xt.At(e,t.tn(0)),t.Yt()}wn(e,t){let n=new i$;return iq.xt.At(nr(this.databaseId,t),n.tn(function(e){let t=en(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Yt()}Vn(e,t,n){if(null===n)return[];let r=[];r.push(new i$);let i=0;for(let s of en(e)){let e=n[i++];for(let n of r)if(this.Sn(t,s.fieldPath)&&ns(e))r=this.bn(r,s,e);else{let t=n.tn(s.kind);iq.xt.At(e,t)}}return this.Dn(r)}Rn(e,t,n){return this.Vn(e,t,n.position)}Dn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Yt();return t}bn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new i$;r.seed(n.Yt()),iq.xt.At(e,r.tn(t.kind)),i.push(r)}return i}Sn(e,t){return!!e.filters.find(e=>e instanceof nT&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tS(e,tn),r=tS(e,ti);return(t?n.G(tr,IDBKeyRange.bound(t,t)):n.G()).next(e=>{let t=[];return ef.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new es(t.sequenceNumber,new el(iC(t.readTime),new X(eV(t.documentKey)),t.largestBatchId)):es.empty(),r=e.fields.map(([e,t])=>new ei(J.fromServerFormat(e),t));return new ee(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:z(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tS(e,tn),i=tS(e,ti);return this.vn(e).next(e=>r.G(tr,IDBKeyRange.bound(t,t)).next(t=>ef.forEach(t,t=>i.put(iF(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ef.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ef.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ef.forEach(i,n=>this.Cn(e,t,n).next(t=>{let i=this.Fn(r,n);return t.isEqual(i)?ef.resolve():this.Mn(e,r,n,t,i)}))))})}xn(e,t,n,r){return tS(e,tl).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.wn(n,t.key),documentKey:t.key.path.toArray()})}On(e,t,n,r){return tS(e,tl).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.wn(n,t.key),t.key.path.toArray()])}Cn(e,t,n){let r=tS(e,tl),i=new tV(ij);return r.Z({index:th,range:IDBKeyRange.only([n.indexId,this.uid,this.wn(n,t)])},(e,r)=>{i=i.add(new iG(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}Fn(e,t){let n=new tV(ij),r=this.yn(t,e);if(null==r)return n;let i=et(t);if(null!=i){let s=e.data.field(i.fieldPath);if(ns(s))for(let i of s.arrayValue.values||[])n=n.add(new iG(t.indexId,e.key,this.fn(i),r))}else n=n.add(new iG(t.indexId,e.key,i8,r));return n}Mn(e,t,n,r,i){T(i5,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tF(s),l=tF(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tF(a)):t?(i(o),o=tF(s)):(o=tF(s),l=tF(a))}}(r,i,ij,r=>{s.push(this.xn(e,t,n,r))},r=>{s.push(this.On(e,t,n,r))}),ef.waitFor(s)}vn(e){let t=1;return tS(e,ti).Z({index:ta,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>ij(e,t)).filter((e,t,n)=>!t||0!==ij(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=ij(i,e),s=ij(i,t);if(0===n)r[0]=e.nn();else if(n>0&&s<0)r.push(i),r.push(i.nn());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Nn(r[e],r[e+1]))return[];let t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,i8,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,i8,[]];i.push(IDBKeyRange.bound(t,n))}return i}Nn(e,t){return ij(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(i4)}getMinOffset(e,t){return ef.mapArray(this.dn(t),t=>this.An(e,t).next(e=>e||x())).next(i4)}}function i4(e){0!==e.length||x();let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>eu(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new el(t.readTime,t.documentKey,n)}let i6={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class i9{static withCacheSize(e){return new i9(e,i9.DEFAULT_COLLECTION_PERCENTILE,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function i7(e,t,n){let r=e.store(eP),i=e.store(eK),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.Z({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{1===o||x()}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,eR(h),c]);s.push(i.delete(r)),u.push(e.key)}return ef.waitFor(s).next(()=>u)}function se(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw x();t=e.noDocument}return JSON.stringify(t).length}i9.DEFAULT_COLLECTION_PERCENTILE=10,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,i9.DEFAULT=new i9(0x2800000,i9.DEFAULT_COLLECTION_PERCENTILE,i9.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),i9.DISABLED=new i9(-1,0,0);class st{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Bn={}}static It(e,t,n,r){return""!==e.uid||x(),new st(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return sr(e).Z({index:eU,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tS(e,eK),s=sr(e);return s.add({}).next(a=>{var o,l;"number"==typeof a||x();let u=new rF(a,t,n,r),h=function(e,t,n){let r=n.baseMutations.map(t=>im(e.Tt,t)),i=n.mutations.map(t=>im(e.Tt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,u),c=[],d=new tV((e,t)=>z(e.canonicalString(),t.canonicalString()));for(let e of r){let t=(o=this.userId,l=e.key.path,[o,eR(l),a]);d=d.add(e.key.path.popLast()),c.push(s.put(h)),c.push(i.put(t,ez))}return d.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Bn[a]=u.keys()}),ef.waitFor(c).next(()=>u)})}lookupMutationBatch(e,t){return sr(e).get(t).next(e=>e?(e.userId===this.userId||x(),ik(this.serializer,e)):null)}Ln(e,t){return this.Bn[t]?ef.resolve(this.Bn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Bn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return sr(e).Z({index:eU,range:r},(e,t,r)=>{t.userId===this.userId&&(t.batchId>=n||x(),i=ik(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return sr(e).Z({index:eU,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return sr(e).G(eU,t).next(e=>e.map(e=>ik(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eR(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tS(e,eK).Z({range:r},(n,r,s)=>{let[a,o,l]=n,u=eV(o);if(a===this.userId&&t.path.isEqual(u))return sr(e).get(l).next(e=>{if(!e)throw x();e.userId===this.userId||x(),i.push(ik(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tV(z),r=[];return t.forEach(t=>{let i=[this.userId,eR(t.path)],s=IDBKeyRange.lowerBound(i),a=tS(e,eK).Z({range:s},(e,r,i)=>{let[s,a,o]=e,l=eV(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ef.waitFor(r).next(()=>this.kn(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eR(n)],s=IDBKeyRange.lowerBound(i),a=new tV(z);return tS(e,eK).Z({range:s},(e,t,i)=>{let[s,o,l]=e,u=eV(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.kn(e,a))}kn(e,t){let n=[],r=[];return t.forEach(t=>{r.push(sr(e).get(t).next(e=>{if(null===e)throw x();e.userId===this.userId||x(),n.push(ik(this.serializer,e))}))}),ef.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return i7(e.ue,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.qn(t.batchId)}),ef.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}qn(e){delete this.Bn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ef.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tS(e,eK).Z({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eV(e[1]);r.push(t)}else n.done()}).next(()=>{0===r.length||x()})})}containsKey(e,t){return sn(e,this.userId,t)}Qn(e){return tS(e,eL).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function sn(e,t,n){let r=[t,eR(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tS(e,eK).Z({range:s,Y:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function sr(e){return tS(e,eP)}class si{constructor(e){this.$n=e}next(){return this.$n+=2,this.$n}static Un(){return new si(0)}static Kn(){return new si(-1)}}class ss{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Wn(e).next(t=>{let n=new si(t.highestTargetId);return t.highestTargetId=n.next(),this.Gn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Wn(e).next(e=>Q.fromTimestamp(new j(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Wn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.Wn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Gn(e,r)))}addTargetData(e,t){return this.zn(e,t).next(()=>this.Wn(e).next(n=>(n.targetCount+=1,this.jn(t,n),this.Gn(e,n))))}updateTargetData(e,t){return this.zn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tS(e,eJ).delete(t.targetId)).next(()=>this.Wn(e)).next(t=>(t.targetCount>0||x(),t.targetCount-=1,this.Gn(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tS(e,eJ).Z((s,a)=>{let o=iD(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ef.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tS(e,eJ).Z((e,n)=>{t(iD(n))})}Wn(e){return tS(e,e4).get(e3).next(e=>(null!==e||x(),e))}Gn(e,t){return tS(e,e4).put(e3,t)}zn(e,t){return tS(e,eJ).put(iA(this.serializer,t))}jn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Wn(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nq(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tS(e,eJ).Z({range:r,index:eX},(e,n,r)=>{let s=iD(n);nU(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=sa(e);return t.forEach(t=>{let s=eR(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ef.waitFor(r)}removeMatchingKeys(e,t,n){let r=sa(e);return ef.forEach(t,t=>{let i=eR(t.path);return ef.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=sa(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=sa(e),i=rs();return r.Z({range:n,Y:!0},(e,t,n)=>{let r=new X(eV(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eR(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return sa(e).Z({index:e5,Y:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}lt(e,t){return tS(e,eJ).get(t).next(e=>e?iD(e):null)}}function sa(e){return tS(e,e1)}let so="LruGarbageCollector";function sl([e,t],[n,r]){let i=z(e,n);return 0===i?z(t,r):i}class su{constructor(e){this.Hn=e,this.buffer=new tV(sl),this.Jn=0}Yn(){return++this.Jn}Zn(e){let t=[e,this.Yn()];if(this.buffer.size<this.Hn)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>sl(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class sh{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Xn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.er(6e4)}stop(){this.Xn&&(this.Xn.cancel(),this.Xn=null)}get started(){return null!==this.Xn}er(e){T(so,`Garbage collection scheduled in ${e}ms`),this.Xn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Xn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eI(e)?T(so,"Ignoring IndexedDB error during garbage collection: ",e):await ed(e)}await this.er(3e5)})}}class sc{constructor(e,t){this.tr=e,this.params=t}calculateTargetCount(e,t){return this.tr.nr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ef.resolve(eC.ae);let n=new su(t);return this.tr.forEachTarget(e,e=>n.Zn(e.sequenceNumber)).next(()=>this.tr.rr(e,e=>n.Zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.tr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.tr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),ef.resolve(i6)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),i6):this.ir(e,t))}getCacheSize(e){return this.tr.getCacheSize(e)}ir(e,t){let n,r,i,s,a,o,l,h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),ef.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sd{constructor(e,t){this.db=e,this.garbageCollector=new sc(this,t)}nr(e){let t=this.sr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}rr(e,t){return this._r(e,(e,n)=>t(n))}addReference(e,t,n){return sf(e,n)}removeReference(e,t,n){return sf(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sf(e,t)}ar(e,t){let n;return n=!1,tS(e,eL).X(r=>sn(e,r,t).next(e=>(e&&(n=!0),ef.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this._r(e,(s,a)=>{if(a<=t){let t=this.ar(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,Q.min()),sa(e).delete([0,eR(s.path)])))});r.push(t)}}).next(()=>ef.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sf(e,t)}_r(e,t){let n=sa(e),r,i=eC.ae;return n.Z({index:e5},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==eC.ae&&t(new X(eV(r)),i),i=a,r=s):i=eC.ae}).next(()=>{i!==eC.ae&&t(new X(eV(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sf(e,t){var n;return sa(e).put((n=e.currentSequenceNumber,{targetId:0,path:eR(t.path),sequenceNumber:n}))}class sm{constructor(){this.changes=new n6(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,np.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ef.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sg{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tS(e,e$).put(n)}removeEntry(e,t,n){return tS(e,e$).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],ix(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.ur(e,n)))}getEntry(e,t){let n=np.newInvalidDocument(t);return tS(e,e$).Z({index:ej,range:IDBKeyRange.only(sy(t))},(e,r)=>{n=this.cr(t,r)}).next(()=>n)}lr(e,t){let n={size:0,document:np.newInvalidDocument(t)};return tS(e,e$).Z({index:ej,range:IDBKeyRange.only(sy(t))},(e,r)=>{n={document:this.cr(t,r),size:se(r)}}).next(()=>n)}getEntries(e,t){let n=n9;return this.hr(e,t,(e,t)=>{let r=this.cr(e,t);n=n.insert(e,r)}).next(()=>n)}Pr(e,t){let n=n9,r=new tD(X.comparator);return this.hr(e,t,(e,t)=>{let i=this.cr(e,t);n=n.insert(e,i),r=r.insert(e,se(t))}).next(()=>({documents:n,Tr:r}))}hr(e,t,n){if(t.isEmpty())return ef.resolve();let r=new tV(sv);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sy(r.first()),sy(r.last())),s=r.getIterator(),a=s.getNext();return tS(e,e$).Z({index:ej,range:i},(e,t,r)=>{let i=X.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sv(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.W(sy(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),ix(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tS(e,e$).G(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=n9;for(let i of e){let e=this.cr(X.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(n8(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=n9,s=sw(t,n),a=sw(t,el.max());return tS(e,e$).Z({index:eW,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.cr(X.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sp(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tS(e,eY).get(eZ).next(e=>(e||x(),e))}ur(e,t){return tS(e,eY).put(eZ,t)}cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=id(e.Tt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=X.fromSegments(t.noDocument.path),r=iC(t.noDocument.readTime);n=np.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return x();{let e=X.fromSegments(t.unknownDocument.path),r=iC(t.unknownDocument.version);n=np.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new j(e[0],e[1]);return Q.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(Q.min())))return e}return np.newInvalidDocument(e)}}class sp extends sm{constructor(e,t){super(),this.Ir=e,this.trackRemovals=t,this.Er=new n6(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tV((e,t)=>z(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Er.get(i);if(t.push(this.Ir.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iS(this.Ir.serializer,s);r=r.add(i.path.popLast());let l=se(o);n+=l-a.size,t.push(this.Ir.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=iS(this.Ir.serializer,s.convertToNoDocument(Q.min()));t.push(this.Ir.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Ir.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Ir.updateMetadata(e,n)),ef.waitFor(t)}getFromCache(e,t){return this.Ir.lr(e,t).next(e=>(this.Er.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Ir.Pr(e,t).next(({documents:e,Tr:t})=>(t.forEach((t,n)=>{this.Er.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sy(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sw(e,t){let n=t.documentKey.path.toArray();return[e,ix(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sv(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=z(n[e],r[e]))return i;return(i=z(n.length,r.length))||(i=z(n[n.length-2],r[r.length-2]))||z(n[n.length-1],r[r.length-1])}class sI{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class s_{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rx(n.mutation,e,tO.empty(),j.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,rs()).next(()=>t))}getLocalViewOfDocuments(e,t,n=rs()){let r=rn();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=re();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=rn();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,rs()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=n9,s=rn(),a=rn();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rk)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rx(a.mutation,t,a.mutation.getFieldMask(),j.now())):s.set(t.key,tO.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new sI(t,null!=(n=s.get(e))?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=rn(),r=new tD((e,t)=>e-t),i=rs();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tO.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||rs()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=rn();l.forEach(e=>{if(!i.has(e)){let r=rS(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ef.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return X.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nW(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ef.resolve(rn()),a=-1,o=i;return s.next(t=>ef.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ef.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,rs())).next(e=>({batchId:a,changes:rt(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new X(t)).next(e=>{let t=re();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=re();return this.indexManager.getCollectionParents(e,i).next(a=>ef.forEach(a,a=>{let o=new nG(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,np.newInvalidDocument(r)))});let n=re();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rx(s.mutation,r,tO.empty(),j.now()),n8(t,r)&&(n=n.insert(e,r))}),n})}}class sT{constructor(e){this.serializer=e,this.dr=new Map,this.Ar=new Map}getBundleMetadata(e,t){return ef.resolve(this.dr.get(t))}saveBundleMetadata(e,t){return this.dr.set(t.id,{id:t.id,version:t.version,createTime:ie(t.createTime)}),ef.resolve()}getNamedQuery(e,t){return ef.resolve(this.Ar.get(t))}saveNamedQuery(e,t){return this.Ar.set(t.name,{name:t.name,query:iR(t.bundledQuery),readTime:ie(t.readTime)}),ef.resolve()}}class sb{constructor(){this.overlays=new tD(X.comparator),this.Rr=new Map}getOverlay(e,t){return ef.resolve(this.overlays.get(t))}getOverlays(e,t){let n=rn();return ef.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.Et(e,t,r)}),ef.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Rr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Rr.delete(n)),ef.resolve()}getOverlaysForCollection(e,t,n){let r=rn(),i=t.length+1,s=new X(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ef.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tD((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rn(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=rn(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ef.resolve(a)}Et(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Rr.get(r.largestBatchId).delete(n.key);this.Rr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rL(t,n));let i=this.Rr.get(t);void 0===i&&(i=rs(),this.Rr.set(t,i)),this.Rr.set(t,i.add(n.key))}}class sE{constructor(){this.sessionToken=tq.EMPTY_BYTE_STRING}getSessionToken(e){return ef.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ef.resolve()}}class sS{constructor(){this.Vr=new tV(sx.mr),this.gr=new tV(sx.pr)}isEmpty(){return this.Vr.isEmpty()}addReference(e,t){let n=new sx(e,t);this.Vr=this.Vr.add(n),this.gr=this.gr.add(n)}yr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.wr(new sx(e,t))}Sr(e,t){e.forEach(e=>this.removeReference(e,t))}br(e){let t=new X(new Y([])),n=new sx(t,e),r=new sx(t,e+1),i=[];return this.gr.forEachInRange([n,r],e=>{this.wr(e),i.push(e.key)}),i}Dr(){this.Vr.forEach(e=>this.wr(e))}wr(e){this.Vr=this.Vr.delete(e),this.gr=this.gr.delete(e)}vr(e){let t=new X(new Y([])),n=new sx(t,e),r=new sx(t,e+1),i=rs();return this.gr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sx(e,0),n=this.Vr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sx{constructor(e,t){this.key=e,this.Cr=t}static mr(e,t){return X.comparator(e.key,t.key)||z(e.Cr,t.Cr)}static pr(e,t){return z(e.Cr,t.Cr)||X.comparator(e.key,t.key)}}class sN{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Fr=1,this.Mr=new tV(sx.mr)}checkEmpty(e){return ef.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Fr;this.Fr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rF(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Mr=this.Mr.add(new sx(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ef.resolve(s)}lookupMutationBatch(e,t){return ef.resolve(this.Or(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.Nr(t+1),r=n<0?0:n;return ef.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ef.resolve(0===this.mutationQueue.length?-1:this.Fr-1)}getAllMutationBatches(e){return ef.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sx(t,0),r=new sx(t,Number.POSITIVE_INFINITY),i=[];return this.Mr.forEachInRange([n,r],e=>{let t=this.Or(e.Cr);i.push(t)}),ef.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tV(z);return t.forEach(e=>{let t=new sx(e,0),r=new sx(e,Number.POSITIVE_INFINITY);this.Mr.forEachInRange([t,r],e=>{n=n.add(e.Cr)})}),ef.resolve(this.Br(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;X.isDocumentKey(i)||(i=i.child(""));let s=new sx(new X(i),0),a=new tV(z);return this.Mr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Cr)),!0)},s),ef.resolve(this.Br(a))}Br(e){let t=[];return e.forEach(e=>{let n=this.Or(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){0===this.Lr(t.batchId,"removed")||x(),this.mutationQueue.shift();let n=this.Mr;return ef.forEach(t.mutations,r=>{let i=new sx(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Mr=n})}qn(e){}containsKey(e,t){let n=new sx(t,0),r=this.Mr.firstAfterOrEqual(n);return ef.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ef.resolve()}Lr(e,t){return this.Nr(e)}Nr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Or(e){let t=this.Nr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sC{constructor(e){this.kr=e,this.docs=new tD(X.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.kr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ef.resolve(n?n.document.mutableCopy():np.newInvalidDocument(t))}getEntries(e,t){let n=n9;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():np.newInvalidDocument(e))}),ef.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=n9,s=t.path,a=new X(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=eu(eo(a),n)||(r.has(a.key)||n8(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ef.resolve(i)}getAllFromCollectionGroup(e,t,n,r){x()}qr(e,t){return ef.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sk(this)}getSize(e){return ef.resolve(this.size)}}class sk extends sm{constructor(e){super(),this.Ir=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Ir.addEntry(e,r)):this.Ir.removeEntry(n)}),ef.waitFor(t)}getFromCache(e,t){return this.Ir.getEntry(e,t)}getAllFromCache(e,t){return this.Ir.getEntries(e,t)}}class sD{constructor(e){this.persistence=e,this.Qr=new n6(e=>nq(e),nU),this.lastRemoteSnapshotVersion=Q.min(),this.highestTargetId=0,this.$r=0,this.Ur=new sS,this.targetCount=0,this.Kr=si.Un()}forEachTarget(e,t){return this.Qr.forEach((e,n)=>t(n)),ef.resolve()}getLastRemoteSnapshotVersion(e){return ef.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ef.resolve(this.$r)}allocateTargetId(e){return this.highestTargetId=this.Kr.next(),ef.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.$r&&(this.$r=t),ef.resolve()}zn(e){this.Qr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.Kr=new si(t),this.highestTargetId=t),e.sequenceNumber>this.$r&&(this.$r=e.sequenceNumber)}addTargetData(e,t){return this.zn(t),this.targetCount+=1,ef.resolve()}updateTargetData(e,t){return this.zn(t),ef.resolve()}removeTargetData(e,t){return this.Qr.delete(t.target),this.Ur.br(t.targetId),this.targetCount-=1,ef.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.Qr.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Qr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ef.waitFor(i).next(()=>r)}getTargetCount(e){return ef.resolve(this.targetCount)}getTargetData(e,t){let n=this.Qr.get(t)||null;return ef.resolve(n)}addMatchingKeys(e,t,n){return this.Ur.yr(t,n),ef.resolve()}removeMatchingKeys(e,t,n){this.Ur.Sr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ef.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Ur.br(t),ef.resolve()}getMatchingKeysForTargetId(e,t){let n=this.Ur.vr(t);return ef.resolve(n)}containsKey(e,t){return ef.resolve(this.Ur.containsKey(t))}}class sA{constructor(e,t){this.Wr={},this.overlays={},this.Gr=new eC(0),this.zr=!1,this.zr=!0,this.jr=new sE,this.referenceDelegate=e(this),this.Hr=new sD(this),this.indexManager=new i1,this.remoteDocumentCache=new sC(e=>this.referenceDelegate.Jr(e)),this.serializer=new iE(t),this.Yr=new sT(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.zr=!1,Promise.resolve()}get started(){return this.zr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sb,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Wr[e.toKey()];return n||(n=new sN(t,this.referenceDelegate),this.Wr[e.toKey()]=n),n}getGlobalsCache(){return this.jr}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Yr}runTransaction(e,t,n){T("MemoryPersistence","Starting transaction:",e);let r=new sR(this.Gr.next());return this.referenceDelegate.Zr(),n(r).next(e=>this.referenceDelegate.Xr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}ei(e,t){return ef.or(Object.values(this.Wr).map(n=>()=>n.containsKey(e,t)))}}class sR extends ec{constructor(e){super(),this.currentSequenceNumber=e}}class sV{constructor(e){this.persistence=e,this.ti=new sS,this.ni=null}static ri(e){return new sV(e)}get ii(){if(this.ni)return this.ni;throw x()}addReference(e,t,n){return this.ti.addReference(n,t),this.ii.delete(n.toString()),ef.resolve()}removeReference(e,t,n){return this.ti.removeReference(n,t),this.ii.add(n.toString()),ef.resolve()}markPotentiallyOrphaned(e,t){return this.ii.add(t.toString()),ef.resolve()}removeTarget(e,t){this.ti.br(t.targetId).forEach(e=>this.ii.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.ii.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Zr(){this.ni=new Set}Xr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ef.forEach(this.ii,n=>{let r=X.fromPath(n);return this.si(e,r).next(e=>{e||t.removeEntry(r,Q.min())})}).next(()=>(this.ni=null,t.apply(e)))}updateLimboDocument(e,t){return this.si(e,t).next(e=>{e?this.ii.delete(t.toString()):this.ii.add(t.toString())})}Jr(e){return 0}si(e,t){return ef.or([()=>ef.resolve(this.ti.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.ei(e,t)])}}class sM{constructor(e,t){this.persistence=e,this.oi=new n6(e=>eR(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sc(this,t)}static ri(e,t){return new sM(e,t)}Zr(){}Xr(e){return ef.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}nr(e){let t=this.sr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}sr(e){let t=0;return this.rr(e,e=>{t++}).next(()=>t)}rr(e,t){return ef.forEach(this.oi,(n,r)=>this.ar(e,n,r).next(e=>e?ef.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.qr(e,r=>this.ar(e,r,t).next(e=>{e||(n++,i.removeEntry(r,Q.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.oi.set(t,e.currentSequenceNumber),ef.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),ef.resolve()}removeReference(e,t,n){return this.oi.set(n,e.currentSequenceNumber),ef.resolve()}updateLimboDocument(e,t){return this.oi.set(t,e.currentSequenceNumber),ef.resolve()}Jr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t4(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tH(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return tK(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tN(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw x()}}(e.data.value)),t}ar(e,t,n){return ef.or([()=>this.persistence.ei(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.oi.get(t);return ef.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sF{constructor(e){this.serializer=e}B(e,t,n,r){let i=new eg("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore(eF),e.createObjectStore(eL,{keyPath:"userId"}),e.createObjectStore(eP,{keyPath:eq,autoIncrement:!0}).createIndex(eU,eB,{unique:!0}),e.createObjectStore(eK),sO(e),e.createObjectStore(eM));let s=ef.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(e1),e.deleteObjectStore(eJ),e.deleteObjectStore(e4),sO(e)),s=s.next(()=>(function(e){let t=e.store(e4),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Q.min().toTimestamp(),targetCount:0};return t.put(e3,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eP).G().next(t=>{e.deleteObjectStore(eP),e.createObjectStore(eP,{keyPath:eq,autoIncrement:!0}).createIndex(eU,eB,{unique:!0});let n=i.store(eP),r=t.map(e=>n.put(e));return ef.waitFor(r)}))),s=s.next(()=>{e.createObjectStore(e7,{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this._i(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore(eY),this.ai(i)))),n<7&&r>=7&&(s=s.next(()=>this.ui(i))),n<8&&r>=8&&(s=s.next(()=>this.ci(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.li(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore(te,{keyPath:"bundleId"}),e.createObjectStore(tt,{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t=e.createObjectStore(td,{keyPath:tf});t.createIndex(tm,tg,{unique:!1}),t.createIndex(tp,ty,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(e$,{keyPath:eG});t.createIndex(ej,eQ),t.createIndex(eW,eH)})(e)).next(()=>this.hi(e,i)).next(()=>e.deleteObjectStore(eM))),n<14&&r>=14&&(s=s.next(()=>this.Pi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(tn,{keyPath:"indexId",autoIncrement:!0}).createIndex(tr,"collectionGroup",{unique:!1}),e.createObjectStore(ti,{keyPath:ts}).createIndex(ta,to,{unique:!1}),e.createObjectStore(tl,{keyPath:tu}).createIndex(th,tc,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(ti).clear()}).next(()=>{t.objectStore(tl).clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore(tw,{keyPath:"name"})})),s}ai(e){let t=0;return e.store(eM).Z((e,n)=>{t+=se(n)}).next(()=>{let n={byteSize:t};return e.store(eY).put(eZ,n)})}_i(e){let t=e.store(eL),n=e.store(eP);return t.G().next(t=>ef.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.G(eU,r).next(n=>ef.forEach(n,n=>{n.userId===t.userId||x();let r=ik(this.serializer,n);return i7(e,t.userId,r).next(()=>{})}))}))}ui(e){let t=e.store(e1),n=e.store(eM);return e.store(e4).get(e3).next(e=>{let r=[];return n.Z((n,i)=>{let s=new Y(n),a=[0,eR(s)];r.push(t.get(a).next(n=>n?ef.resolve():t.put({targetId:0,path:eR(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ef.waitFor(r))})}ci(e,t){e.createObjectStore(e6,{keyPath:e9});let n=t.store(e6),r=new i2,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eR(r)})}};return t.store(eM).Z({Y:!0},(e,t)=>i(new Y(e).popLast())).next(()=>t.store(eK).Z({Y:!0},([e,t,n],r)=>i(eV(t).popLast())))}li(e){let t=e.store(eJ);return t.Z((e,n)=>{let r=iD(n),i=iA(this.serializer,r);return t.put(i)})}hi(e,t){let n=t.store(eM),r=[];return n.Z((e,n)=>{let i=t.store(e$),s=(n.document?new X(Y.fromString(n.document.name).popFirst(5)):n.noDocument?X.fromSegments(n.noDocument.path):n.unknownDocument?X.fromSegments(n.unknownDocument.path):x()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ef.waitFor(r))}Pi(e,t){let n=t.store(eP),r=new sg(this.serializer),i=new sA(sV.ri,this.serializer.Tt);return n.G().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!=(t=n.get(e.userId))?t:rs();ik(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),ef.forEach(n,(e,n)=>{let s=new y(n),a=iL.It(this.serializer,s),o=i.getIndexManager(s);return new s_(r,st.It(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tE(t,eC.ae),e).next()})})}}function sO(e){e.createObjectStore(e1,{keyPath:e2}).createIndex(e5,e8,{unique:!0}),e.createObjectStore(eJ,{keyPath:"targetId"}).createIndex(eX,e0,{unique:!0}),e.createObjectStore(e4)}let sL="IndexedDbPersistence",sP="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",sq="main";class sU{constructor(e,t,n,r,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Ti=i,this.window=s,this.document=a,this.Ii=l,this.Ei=u,this.di=h,this.Gr=null,this.zr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ai=null,this.inForeground=!1,this.Ri=null,this.Vi=null,this.mi=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!sU.D())throw new k(C.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sd(this,r),this.gi=t+sq,this.serializer=new iE(o),this.pi=new ep(this.gi,this.di,new sF(this.serializer)),this.jr=new iP,this.Hr=new ss(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sg(this.serializer),this.Yr=new iO,this.window&&this.window.localStorage?this.yi=this.window.localStorage:(this.yi=null,!1===u&&b(sL,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(C.FAILED_PRECONDITION,sP);return this.Si(),this.bi(),this.Di(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Hr.getHighestSequenceNumber(e))}).then(e=>{this.Gr=new eC(e,this.Ii)}).then(()=>{this.zr=!0}).catch(e=>(this.pi&&this.pi.close(),Promise.reject(e)))}Ci(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.pi.k(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Ti.enqueueAndForget(async()=>{this.started&&await this.wi()}))}wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tS(e,e7).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Fi(e).next(e=>{e||(this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Mi(e)).next(t=>this.isPrimary&&!t?this.xi(e).next(()=>!1):!!t&&this.Oi(e).next(()=>!0))).catch(e=>{if(eI(e))return T(sL,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sL,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Ti.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Fi(e){return tS(e,eF).get(eO).next(e=>ef.resolve(this.Ni(e)))}Bi(e){return tS(e,e7).delete(this.clientId)}async Li(){if(this.isPrimary&&!this.ki(this.mi,18e5)){this.mi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tS(e,e7);return t.G().next(e=>{let n=this.qi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ef.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.yi)for(let t of e)this.yi.removeItem(this.Qi(t.clientId))}}Di(){this.Vi=this.Ti.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.wi().then(()=>this.Li()).then(()=>this.Di()))}Ni(e){return!!e&&e.ownerId===this.clientId}Mi(e){return this.Ei?ef.resolve(!0):tS(e,eF).get(eO).next(t=>{if(null!==t&&this.ki(t.leaseTimestampMs,5e3)&&!this.$i(t.ownerId)){if(this.Ni(t)&&this.networkEnabled)return!0;if(!this.Ni(t)){if(!t.allowTabSynchronization)throw new k(C.FAILED_PRECONDITION,sP);return!1}}return!(!this.networkEnabled||!this.inForeground)||tS(e,e7).G().next(e=>void 0===this.qi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sL,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.zr=!1,this.Ui(),this.Vi&&(this.Vi.cancel(),this.Vi=null),this.Ki(),this.Wi(),await this.pi.runTransaction("shutdown","readwrite",[eF,e7],e=>{let t=new tE(e,eC.ae);return this.xi(t).next(()=>this.Bi(t))}),this.pi.close(),this.Gi()}qi(e,t){return e.filter(e=>this.ki(e.updateTimeMs,t)&&!this.$i(e.clientId))}zi(){return this.runTransaction("getActiveClients","readonly",e=>tS(e,e7).G().next(e=>this.qi(e,18e5).map(e=>e.clientId)))}get started(){return this.zr}getGlobalsCache(){return this.jr}getMutationQueue(e,t){return st.It(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Hr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i3(e,this.serializer.Tt.databaseId)}getDocumentOverlayCache(e){return iL.It(this.serializer,e)}getBundleCache(){return this.Yr}runTransaction(e,t,n){var r;let i;T(sL,"Starting transaction:",e);let s=17===(r=this.di)?tb:16===r||15===r?tT:14===r||13===r?t_:12===r?tI:11===r?tv:void x();return this.pi.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tE(r,this.Gr?this.Gr.next():eC.ae),"readwrite-primary"===t?this.Fi(i).next(e=>!!e||this.Mi(i)).next(t=>{if(!t)throw b(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Ti.enqueueRetryable(()=>this.fi(!1)),new k(C.FAILED_PRECONDITION,eh);return n(i)}).next(e=>this.Oi(i).next(()=>e)):this.ji(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}ji(e){return tS(e,eF).get(eO).next(e=>{if(null!==e&&this.ki(e.leaseTimestampMs,5e3)&&!this.$i(e.ownerId)&&!this.Ni(e)&&!(this.Ei||this.allowTabSynchronization&&e.allowTabSynchronization))throw new k(C.FAILED_PRECONDITION,sP)})}Oi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tS(e,eF).put(eO,t)}static D(){return ep.D()}xi(e){let t=tS(e,eF);return t.get(eO).next(e=>this.Ni(e)?(T(sL,"Releasing primary lease."),t.delete(eO)):ef.resolve())}ki(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(b(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Si(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ri=()=>{this.Ti.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.wi()))},this.document.addEventListener("visibilitychange",this.Ri),this.inForeground="visible"===this.document.visibilityState)}Ki(){this.Ri&&(this.document.removeEventListener("visibilitychange",this.Ri),this.Ri=null)}bi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Ai=()=>{this.Ui();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Ti.enterRestrictedMode(!0),this.Ti.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ai))}Wi(){this.Ai&&(this.window.removeEventListener("pagehide",this.Ai),this.Ai=null)}$i(e){var t;try{let n=null!==(null==(t=this.yi)?void 0:t.getItem(this.Qi(e)));return T(sL,`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return b(sL,"Failed to get zombied client id.",e),!1}}Ui(){if(this.yi)try{this.yi.setItem(this.Qi(this.clientId),String(Date.now()))}catch(e){b("Failed to set zombie client id.",e)}}Gi(){if(this.yi)try{this.yi.removeItem(this.Qi(this.clientId))}catch(e){}}Qi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sB(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class sz{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Hi=n,this.Ji=r}static Yi(e,t){let n=rs(),r=rs();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sz(e,t.fromCache,n,r)}}class sK{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class s${constructor(){this.Zi=!1,this.Xi=!1,this.es=100,this.ts=(0,h.nr)()?8:ey((0,h.ZQ)())>0?6:4}initialize(e,t){this.ns=e,this.indexManager=t,this.Zi=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.rs(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ss(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sK;return this._s(e,t,n).next(r=>{if(i.result=r,this.Xi)return this.us(e,t,n,r.size)})}).next(()=>i.result)}us(e,t,n,r){return n.documentReadCount<this.es?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",n5(t),"since it only creates cache indexes for collection contains","more than or equal to",this.es,"documents"),ef.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",n5(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.ts*r?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",n5(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nY(t))):ef.resolve())}rs(e,t){if(nQ(t))return ef.resolve(null);let n=nY(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=nY(t=n0(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=rs(...r);return this.ns.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.cs(t,r);return this.ls(t,s,i,n.readTime)?this.rs(e,n0(t,null,"F")):this.hs(e,s,t,n)}))})))}ss(e,t,n,r){return nQ(t)||r.isEqual(Q.min())?ef.resolve(null):this.ns.getDocuments(e,n).next(i=>{let s=this.cs(t,i);return this.ls(t,s,n,r)?ef.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),n5(t)),this.hs(e,s,t,ea(r,-1)).next(e=>e))})}cs(e,t){let n=new tV(n4(e));return t.forEach((t,r)=>{n8(e,r)&&(n=n.add(r))}),n}ls(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}_s(e,t,n){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",n5(t)),this.ns.getDocumentsMatchingQuery(e,t,el.min(),n)}hs(e,t,n,r){return this.ns.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sG="LocalStore";class sj{constructor(e,t,n,r){this.persistence=e,this.Ps=t,this.serializer=r,this.Ts=new tD(z),this.Is=new n6(e=>nq(e),nU),this.Es=new Map,this.ds=e.getRemoteDocumentCache(),this.Hr=e.getTargetCache(),this.Yr=e.getBundleCache(),this.As(n)}As(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new s_(this.ds,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.ds.setIndexManager(this.indexManager),this.Ps.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ts))}}async function sQ(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.As(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=rs();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Rs:e,removedBatchIds:i,addedBatchIds:s}))})})}function sW(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Hr.getLastRemoteSnapshotVersion(t))}function sH(e,t,n){let r=rs(),i=rs();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=n9;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(Q.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):T(sG,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Vs:r,fs:i}})}function sY(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Hr.getTargetData(n,t).next(i=>i?(r=i,ef.resolve(r)):e.Hr.allocateTargetId(n).next(i=>(r=new ib(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Hr.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.Ts.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.Ts=e.Ts.insert(n.targetId,n),e.Is.set(t,n.targetId)),n})}async function sZ(e,t,n){let r=e.Ts.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eI(e))throw e;T(sG,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ts=e.Ts.remove(t),e.Is.delete(r.target)}function sJ(e,t,n){let r=Q.min(),i=rs();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.Is.get(n);return void 0!==r?ef.resolve(e.Ts.get(r)):e.Hr.getTargetData(t,n)})(e,s,nY(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Hr.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Ps.getDocumentsMatchingQuery(s,t,n?r:Q.min(),n?i:rs())).next(n=>(s1(e,n3(t),n),{documents:n,gs:i})))}function sX(e,t){let n=e.Hr,r=e.Ts.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.lt(e,t).next(e=>e?e.target:null))}function s0(e,t){let n=e.Es.get(t)||Q.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.ds.getAllFromCollectionGroup(r,t,ea(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(s1(e,t,n),n))}function s1(e,t,n){let r=e.Es.get(t)||Q.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Es.set(t,r)}async function s2(e,t,n,r){let i=rs(),s=n9;for(let e of n){let n=t.ps(e.metadata.name);e.document&&(i=i.add(n));let r=t.ys(e);r.setReadTime(t.ws(e.metadata.readTime)),s=s.insert(n,r)}let a=e.ds.newChangeBuffer({trackRemovals:!0}),o=await sY(e,nY(nj(Y.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sH(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Hr.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Hr.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.Vs,n.fs)).next(()=>n.Vs)))}async function s5(e,t,n=rs()){let r=await sY(e,nY(iR(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=ie(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Yr.saveNamedQuery(i,t);let a=r.withResumeToken(tq.EMPTY_BYTE_STRING,s);return e.Ts=e.Ts.insert(a.targetId,a),e.Hr.updateTargetData(i,a).next(()=>e.Hr.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Hr.addMatchingKeys(i,n,r.targetId)).next(()=>e.Yr.saveNamedQuery(i,t))})}let s8="firestore_clients";function s3(e,t){return`${s8}_${e}_${t}`}let s4="firestore_mutations";function s6(e,t,n){let r=`${s4}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let s9="firestore_targets";function s7(e,t){return`${s9}_${e}_${t}`}let ae="SharedClientState";class at{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ss(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new k(r.error.code,r.error.message)),s?new at(e,t,r.state,i):(b(ae,`Failed to parse mutation state for ID '${t}': ${n}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class an{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ss(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new k(n.error.code,n.error.message)),i?new an(e,n.state,r):(b(ae,`Failed to parse target state for ID '${e}': ${t}`),null)}bs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ar{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ss(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=ra;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eA(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new ar(e,i):(b(ae,`Failed to parse client data for instance '${e}': ${t}`),null)}}class ai{constructor(e,t){this.clientId=e,this.onlineState=t}static Ss(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ai(t.clientId,t.onlineState):(b(ae,`Failed to parse online state: ${e}`),null)}}class as{constructor(){this.activeTargetIds=ra}Ds(e){this.activeTargetIds=this.activeTargetIds.add(e)}vs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}bs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class aa{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Ti=t,this.persistenceKey=n,this.Cs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Fs=this.Ms.bind(this),this.xs=new tD(z),this.started=!1,this.Os=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ns=s3(this.persistenceKey,this.Cs),this.Bs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.xs=this.xs.insert(this.Cs,new as),this.Ls=RegExp(`^${s8}_${l}_([^_]*)$`),this.ks=RegExp(`^${s4}_${l}_(\\d+)(?:_(.*))?$`),this.qs=RegExp(`^${s9}_${l}_(\\d+)$`),this.Qs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.$s=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Fs)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.zi())){if(e===this.Cs)continue;let t=this.getItem(s3(this.persistenceKey,e));if(t){let n=ar.Ss(e,t);n&&(this.xs=this.xs.insert(n.clientId,n))}}this.Us();let e=this.storage.getItem(this.Qs);if(e){let t=this.Ks(e);t&&this.Ws(t)}for(let e of this.Os)this.Ms(e);this.Os=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Bs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Gs(this.xs)}isActiveQueryTarget(e){let t=!1;return this.xs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.zs(e,"pending")}updateMutationState(e,t,n){this.zs(e,t,n),this.js(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(s7(this.persistenceKey,e));if(t){let r=an.Ss(e,t);r&&(n=r.state)}}return t&&this.Hs.Ds(e),this.Us(),n}removeLocalQueryTarget(e){this.Hs.vs(e),this.Us()}isLocalQueryTarget(e){return this.Hs.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(s7(this.persistenceKey,e))}updateQueryState(e,t,n){this.Js(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.js(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Ys(e)}notifyBundleLoaded(e){this.Zs(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Fs),this.removeItem(this.Ns),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(ae,"READ",e,t),t}setItem(e,t){T(ae,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(ae,"REMOVE",e),this.storage.removeItem(e)}Ms(e){if(e.storageArea===this.storage){if(T(ae,"EVENT",e.key,e.newValue),e.key===this.Ns)return void b("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Ti.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Ls.test(e.key)){if(null==e.newValue){let t=this.Xs(e.key);return this.eo(t,null)}{let t=this.no(e.key,e.newValue);if(t)return this.eo(t.clientId,t)}}else if(this.ks.test(e.key)){if(null!==e.newValue){let t=this.ro(e.key,e.newValue);if(t)return this.io(t)}}else if(this.qs.test(e.key)){if(null!==e.newValue){let t=this.so(e.key,e.newValue);if(t)return this.oo(t)}}else if(e.key===this.Qs){if(null!==e.newValue){let t=this.Ks(e.newValue);if(t)return this.Ws(t)}}else if(e.key===this.Bs){let t=function(e){let t=eC.ae;if(null!=e)try{let n=JSON.parse(e);"number"==typeof n||x(),t=n}catch(e){b(ae,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eC.ae&&this.sequenceNumberHandler(t)}else if(e.key===this.$s){let t=this._o(e.newValue);await Promise.all(t.map(e=>this.syncEngine.ao(e)))}}}else this.Os.push(e)})}}get Hs(){return this.xs.get(this.Cs)}Us(){this.setItem(this.Ns,this.Hs.bs())}zs(e,t,n){let r=new at(this.currentUser,e,t,n),i=s6(this.persistenceKey,this.currentUser,e);this.setItem(i,r.bs())}js(e){let t=s6(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Ys(e){let t={clientId:this.Cs,onlineState:e};this.storage.setItem(this.Qs,JSON.stringify(t))}Js(e,t,n){let r=s7(this.persistenceKey,e),i=new an(e,t,n);this.setItem(r,i.bs())}Zs(e){let t=JSON.stringify(Array.from(e));this.setItem(this.$s,t)}Xs(e){let t=this.Ls.exec(e);return t?t[1]:null}no(e,t){let n=this.Xs(e);return ar.Ss(n,t)}ro(e,t){let n=this.ks.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return at.Ss(new y(i),r,t)}so(e,t){let n=Number(this.qs.exec(e)[1]);return an.Ss(n,t)}Ks(e){return ai.Ss(e)}_o(e){return JSON.parse(e)}async io(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.uo(e.batchId,e.state,e.error);T(ae,`Ignoring mutation for non-active user ${e.user.uid}`)}oo(e){return this.syncEngine.co(e.targetId,e.state,e.error)}eo(e,t){let n=t?this.xs.insert(e,t):this.xs.remove(e),r=this.Gs(this.xs),i=this.Gs(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.lo(s,a).then(()=>{this.xs=n})}Ws(e){this.xs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Gs(e){let t=ra;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class ao{constructor(){this.ho=new as,this.Po={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.ho.Ds(e),this.Po[e]||"not-current"}updateQueryState(e,t,n){this.Po[e]=t}removeLocalQueryTarget(e){this.ho.vs(e)}isLocalQueryTarget(e){return this.ho.activeTargetIds.has(e)}clearQueryState(e){delete this.Po[e]}getAllActiveQueryTargets(){return this.ho.activeTargetIds}isActiveQueryTarget(e){return this.ho.activeTargetIds.has(e)}start(){return this.ho=new as,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class al{To(e){}shutdown(){}}let au="ConnectivityMonitor";class ah{constructor(){this.Io=()=>this.Eo(),this.Ao=()=>this.Ro(),this.Vo=[],this.mo()}To(e){this.Vo.push(e)}shutdown(){window.removeEventListener("online",this.Io),window.removeEventListener("offline",this.Ao)}mo(){window.addEventListener("online",this.Io),window.addEventListener("offline",this.Ao)}Eo(){for(let e of(T(au,"Network connectivity changed: AVAILABLE"),this.Vo))e(0)}Ro(){for(let e of(T(au,"Network connectivity changed: UNAVAILABLE"),this.Vo))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ac=null;function ad(){return null===ac?ac=0x10000000+Math.round(0x80000000*Math.random()):ac++,"0x"+ac.toString(16)}let af="RestConnection",am={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ag{get fo(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.po=t+"://"+e.host,this.yo=`projects/${n}/databases/${r}`,this.wo=this.databaseId.database===tJ?`project_id=${n}`:`project_id=${n}&database_id=${r}`}So(e,t,n,r,i){let s=ad(),a=this.bo(e,t.toUriEncodedString());T(af,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.yo,"x-goog-request-params":this.wo};return this.Do(o,r,i),this.vo(e,a,o,n).then(t=>(T(af,`Received RPC '${e}' ${s}: `,t),t),t=>{throw E(af,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Co(e,t,n,r,i,s){return this.So(e,t,n,r,i)}Do(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}bo(e,t){let n=am[e];return`${this.po}/v1/${t}:${n}`}terminate(){}}class ap{constructor(e){this.Fo=e.Fo,this.Mo=e.Mo}xo(e){this.Oo=e}No(e){this.Bo=e}Lo(e){this.ko=e}onMessage(e){this.qo=e}close(){this.Mo()}send(e){this.Fo(e)}Qo(){this.Oo()}$o(){this.Bo()}Uo(e){this.ko(e)}Ko(e){this.qo(e)}}let ay="WebChannelConnection";class aw extends ag{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}vo(e,t,n,r){let i=ad();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(ay,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:T(ay,`RPC '${e}' ${i} timed out`),a(new k(C.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(T(ay,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(C).indexOf(t)>=0?t:C.UNKNOWN}(t.status);a(new k(e,t.message))}else a(new k(C.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new k(C.UNAVAILABLE,"Connection failed."));break;default:x()}}finally{T(ay,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(r);T(ay,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",l,n,15)})}Wo(e,t,n){let i=ad(),s=[this.po,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Do(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let h=s.join("");T(ay,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new ap({Fo:t=>{m?T(ay,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(ay,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(ay,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Mo:()=>c.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(ay,`RPC '${e}' stream ${i} transport opened.`),g.Qo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(ay,`RPC '${e}' stream ${i} transport closed`),g.Uo())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,E(ay,`RPC '${e}' stream ${i} transport errored:`,t),g.Uo(new k(C.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var n;if(!m){let s=t.data[0];s||x();let a=(null==s?void 0:s.error)||(null==(n=s[0])?void 0:n.error);if(a){T(ay,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return rB(t)}(t),s=a.message;void 0===n&&(n=C.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.Uo(new k(n,s)),c.close()}else T(ay,`RPC '${e}' stream ${i} received:`,s),g.Ko(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(ay,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(ay,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.$o()},0),g}}function av(){return"undefined"!=typeof window?window:null}function aI(){return"undefined"!=typeof document?document:null}function a_(e){return new r4(e,!0)}class aT{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Ti=e,this.timerId=t,this.Go=n,this.zo=r,this.jo=i,this.Ho=0,this.Jo=null,this.Yo=Date.now(),this.reset()}reset(){this.Ho=0}Zo(){this.Ho=this.jo}Xo(e){this.cancel();let t=Math.floor(this.Ho+this.e_()),n=Math.max(0,Date.now()-this.Yo),r=Math.max(0,t-n);r>0&&T("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ho} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Jo=this.Ti.enqueueAfterDelay(this.timerId,r,()=>(this.Yo=Date.now(),e())),this.Ho*=this.zo,this.Ho<this.Go&&(this.Ho=this.Go),this.Ho>this.jo&&(this.Ho=this.jo)}t_(){null!==this.Jo&&(this.Jo.skipDelay(),this.Jo=null)}cancel(){null!==this.Jo&&(this.Jo.cancel(),this.Jo=null)}e_(){return(Math.random()-.5)*this.Ho}}let ab="PersistentStream";class aE{constructor(e,t,n,r,i,s,a,o){this.Ti=e,this.n_=n,this.r_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.i_=0,this.s_=null,this.o_=null,this.stream=null,this.__=0,this.a_=new aT(e,t)}u_(){return 1===this.state||5===this.state||this.c_()}c_(){return 2===this.state||3===this.state}start(){this.__=0,4!==this.state?this.auth():this.l_()}async stop(){this.u_()&&await this.close(0)}h_(){this.state=0,this.a_.reset()}P_(){this.c_()&&null===this.s_&&(this.s_=this.Ti.enqueueAfterDelay(this.n_,6e4,()=>this.T_()))}I_(e){this.E_(),this.stream.send(e)}async T_(){if(this.c_())return this.close(0)}E_(){this.s_&&(this.s_.cancel(),this.s_=null)}d_(){this.o_&&(this.o_.cancel(),this.o_=null)}async close(e,t){this.E_(),this.d_(),this.a_.cancel(),this.i_++,4!==e?this.a_.reset():t&&t.code===C.RESOURCE_EXHAUSTED?(b(t.toString()),b("Using maximum backoff delay to prevent overloading the backend."),this.a_.Zo()):t&&t.code===C.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.A_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Lo(t)}A_(){}auth(){this.state=1;let e=this.R_(this.i_),t=this.i_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.i_===t&&this.V_(e,n)},t=>{e(()=>{let e=new k(C.UNKNOWN,"Fetching auth token failed: "+t.message);return this.m_(e)})})}V_(e,t){let n=this.R_(this.i_);this.stream=this.f_(e,t),this.stream.xo(()=>{n(()=>this.listener.xo())}),this.stream.No(()=>{n(()=>(this.state=2,this.o_=this.Ti.enqueueAfterDelay(this.r_,1e4,()=>(this.c_()&&(this.state=3),Promise.resolve())),this.listener.No()))}),this.stream.Lo(e=>{n(()=>this.m_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.__?this.g_(e):this.onNext(e))})}l_(){this.state=5,this.a_.Xo(async()=>{this.state=0,this.start()})}m_(e){return T(ab,`close with error: ${e}`),this.stream=null,this.close(4,e)}R_(e){return t=>{this.Ti.enqueueAndForget(()=>this.i_===e?t():(T(ab,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class aS extends aE{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}f_(e,t){return this.connection.Wo("Listen",e,t)}g_(e){return this.onNext(e)}onNext(e){this.a_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:x(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||x(),tq.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||x(),tq.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new rJ(s,a,o,l&&new k(void 0===l.code?C.UNKNOWN:rB(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=ia(e,r.document.name),s=ie(r.document.updateTime),a=r.document.createTime?ie(r.document.createTime):Q.min(),o=new ng({mapValue:{fields:r.document.fields}}),l=np.newFoundDocument(i,s,a,o);n=new rY(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=ia(e,r.document),s=r.readTime?ie(r.readTime):Q.min(),a=np.newNoDocument(i,s);n=new rY([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=ia(e,r.document);n=new rY([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return x();{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rq(r,i);n=new rZ(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return Q.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?Q.min():t.readTime?ie(t.readTime):Q.min()}(e);return this.listener.p_(t,n)}y_(e){let t={};t.database=iu(this.serializer),t.addTarget=function(e,t){let n,r=t.target;if((n=nB(r)?{documents:ip(e,r)}:{query:iy(e,r).ht}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=r7(e,t.resumeToken);let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(Q.min())>0){n.readTime=r9(e,t.snapshotVersion.toTimestamp());let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return x()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.I_(t)}w_(e){let t={};t.database=iu(this.serializer),t.removeTarget=e,this.I_(t)}}class ax extends aE{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get S_(){return this.__>0}start(){this.lastStreamToken=void 0,super.start()}A_(){this.S_&&this.b_([])}f_(e,t){return this.connection.Wo("Write",e,t)}g_(e){return e.streamToken||x(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&x(),this.listener.D_()}onNext(e){var t,n;e.streamToken||x(),this.lastStreamToken=e.streamToken,this.a_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(void 0!==n||x(),t.map(e=>{let t;return(t=e.updateTime?ie(e.updateTime):ie(n)).isEqual(Q.min())&&(t=ie(n)),new r_(t,e.transformResults||[])})):[]),i=ie(e.commitTime);return this.listener.v_(i,r)}C_(){let e={};e.database=iu(this.serializer),this.I_(e)}b_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>im(this.serializer,e))};this.I_(t)}}class aN{}class aC extends aN{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.F_=!1}M_(){if(this.F_)throw new k(C.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,n,r){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.So(e,ir(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new k(C.UNKNOWN,e.toString())})}Co(e,t,n,r,i){return this.M_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Co(e,ir(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===C.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new k(C.UNKNOWN,e.toString())})}terminate(){this.F_=!0,this.connection.terminate()}}class ak{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.x_=0,this.O_=null,this.N_=!0}B_(){0===this.x_&&(this.L_("Unknown"),this.O_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.O_=null,this.k_("Backend didn't respond within 10 seconds."),this.L_("Offline"),Promise.resolve())))}q_(e){"Online"===this.state?this.L_("Unknown"):(this.x_++,this.x_>=1&&(this.Q_(),this.k_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.L_("Offline")))}set(e){this.Q_(),this.x_=0,"Online"===e&&(this.N_=!1),this.L_(e)}L_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}k_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.N_?(b(t),this.N_=!1):T("OnlineStateTracker",t)}Q_(){null!==this.O_&&(this.O_.cancel(),this.O_=null)}}let aD="RemoteStore";class aA{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.U_=[],this.K_=new Map,this.W_=new Set,this.G_=[],this.z_=i,this.z_.To(e=>{n.enqueueAndForget(async()=>{aU(this)&&(T(aD,"Restarting streams for network reachability change."),await async function(e){e.W_.add(4),await aV(e),e.j_.set("Unknown"),e.W_.delete(4),await aR(e)}(this))})}),this.j_=new ak(n,r)}}async function aR(e){if(aU(e))for(let t of e.G_)await t(!0)}async function aV(e){for(let t of e.G_)await t(!1)}function aM(e,t){e.K_.has(t.targetId)||(e.K_.set(t.targetId,t),aq(e)?aP(e):a2(e).c_()&&aO(e,t))}function aF(e,t){let n=a2(e);e.K_.delete(t),n.c_()&&aL(e,t),0===e.K_.size&&(n.c_()?n.P_():aU(e)&&e.j_.set("Unknown"))}function aO(e,t){if(e.H_.Ne(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(Q.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}a2(e).y_(t)}function aL(e,t){e.H_.Ne(t),a2(e).w_(t)}function aP(e){e.H_=new r0({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),lt:t=>e.K_.get(t)||null,it:()=>e.datastore.serializer.databaseId}),a2(e).start(),e.j_.B_()}function aq(e){return aU(e)&&!a2(e).u_()&&e.K_.size>0}function aU(e){return 0===e.W_.size}async function aB(e){e.j_.set("Online")}async function az(e){e.K_.forEach((t,n)=>{aO(e,t)})}async function aK(e,t){e.H_=void 0,aq(e)?(e.j_.q_(t),aP(e)):e.j_.set("Unknown")}async function a$(e,t,n){if(e.j_.set("Online"),t instanceof rJ&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.K_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.K_.delete(r),e.H_.removeTarget(r))}(e,t)}catch(n){T(aD,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await aG(e,n)}else if(t instanceof rY?e.H_.We(t):t instanceof rZ?e.H_.Ze(t):e.H_.je(t),!n.isEqual(Q.min()))try{let t=await sW(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.H_.ot(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.K_.get(r);i&&e.K_.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.K_.get(t);if(!r)return;e.K_.set(t,r.withResumeToken(tq.EMPTY_BYTE_STRING,r.snapshotVersion)),aL(e,t);let i=new ib(r.target,t,n,r.sequenceNumber);aO(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){T(aD,"Failed to raise snapshot:",t),await aG(e,t)}}async function aG(e,t,n){if(!eI(t))throw t;e.W_.add(1),await aV(e),e.j_.set("Offline"),n||(n=()=>sW(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(aD,"Retrying IndexedDB access"),await n(),e.W_.delete(1),await aR(e)})}function aj(e,t){return t().catch(n=>aG(e,n,t))}async function aQ(e){var t;let n=a5(e),r=e.U_.length>0?e.U_[e.U_.length-1].batchId:-1;for(;aU(t=e)&&t.U_.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.U_.length&&n.P_();break}r=t.batchId,function(e,t){e.U_.push(t);let n=a5(e);n.c_()&&n.S_&&n.b_(t.mutations)}(e,t)}catch(t){await aG(e,t)}aW(e)&&aH(e)}function aW(e){return aU(e)&&!a5(e).u_()&&e.U_.length>0}function aH(e){a5(e).start()}async function aY(e){a5(e).C_()}async function aZ(e){let t=a5(e);for(let n of e.U_)t.b_(n.mutations)}async function aJ(e,t,n){let r=e.U_.shift(),i=rO.from(r,t,n);await aj(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aQ(e)}async function aX(e,t){t&&a5(e).S_&&await async function(e,t){var n;if(rU(n=t.code)&&n!==C.ABORTED){let n=e.U_.shift();a5(e).h_(),await aj(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await aQ(e)}}(e,t),aW(e)&&aH(e)}async function a0(e,t){e.asyncQueue.verifyOperationInProgress(),T(aD,"RemoteStore received new credentials");let n=aU(e);e.W_.add(3),await aV(e),n&&e.j_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.W_.delete(3),await aR(e)}async function a1(e,t){t?(e.W_.delete(2),await aR(e)):t||(e.W_.add(2),await aV(e),e.j_.set("Unknown"))}function a2(e){var t,n,r;return e.J_||(t=e.datastore,n=e.asyncQueue,r={xo:aB.bind(null,e),No:az.bind(null,e),Lo:aK.bind(null,e),p_:a$.bind(null,e)},t.M_(),e.J_=new aS(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.G_.push(async t=>{t?(e.J_.h_(),aq(e)?aP(e):e.j_.set("Unknown")):(await e.J_.stop(),e.H_=void 0)})),e.J_}function a5(e){var t,n,r;return e.Y_||(t=e.datastore,n=e.asyncQueue,r={xo:()=>Promise.resolve(),No:aY.bind(null,e),Lo:aX.bind(null,e),D_:aZ.bind(null,e),v_:aJ.bind(null,e)},t.M_(),e.Y_=new ax(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.G_.push(async t=>{t?(e.Y_.h_(),await aQ(e)):(await e.Y_.stop(),e.U_.length>0&&(T(aD,`Stopping write stream with ${e.U_.length} pending writes`),e.U_=[]))})),e.Y_}class a8{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new D,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new a8(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new k(C.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a3(e,t){if(b("AsyncQueue",`${t}: ${e}`),eI(e))return new k(C.UNAVAILABLE,`${t}: ${e}`);throw e}class a4{static emptySet(e){return new a4(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||X.comparator(t.key,n.key):(e,t)=>X.comparator(e.key,t.key),this.keyedMap=re(),this.sortedSet=new tD(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof a4)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new a4;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class a6{constructor(){this.Z_=new tD(X.comparator)}track(e){let t=e.doc.key,n=this.Z_.get(t);n?0!==e.type&&3===n.type?this.Z_=this.Z_.insert(t,e):3===e.type&&1!==n.type?this.Z_=this.Z_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Z_=this.Z_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Z_=this.Z_.remove(t):1===e.type&&2===n.type?this.Z_=this.Z_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Z_=this.Z_.insert(t,{type:2,doc:e.doc}):x():this.Z_=this.Z_.insert(t,e)}X_(){let e=[];return this.Z_.inorderTraversal((t,n)=>{e.push(n)}),e}}class a9{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a9(e,t,a4.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&n1(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class a7{constructor(){this.ea=void 0,this.ta=[]}na(){return this.ta.some(e=>e.ra())}}class oe{constructor(){this.queries=ot(),this.onlineState="Unknown",this.ia=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=ot(),n.forEach((e,n)=>{for(let e of n.ta)e.onError(t)})}(this,new k(C.ABORTED,"Firestore shutting down"))}}function ot(){return new n6(e=>n2(e),n1)}async function on(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.na()&&t.ra()&&(n=2):(i=new a7,n=+!t.ra());try{switch(n){case 0:i.ea=await e.onListen(r,!0);break;case 1:i.ea=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=a3(n,`Initialization of query '${n5(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.ta.push(t),t.sa(e.onlineState),i.ea&&t.oa(i.ea)&&oa(e)}async function or(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.ta.indexOf(t);e>=0&&(i.ta.splice(e,1),0===i.ta.length?r=+!t.ra():!i.na()&&t.ra()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function oi(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.ta)e.oa(r)&&(n=!0);i.ea=r}}n&&oa(e)}function os(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.ta)e.onError(n);e.queries.delete(t)}function oa(e){e.ia.forEach(e=>{e.next()})}(a=s||(s={}))._a="default",a.Cache="cache";class oo{constructor(e,t,n){this.query=e,this.aa=t,this.ua=!1,this.ca=null,this.onlineState="Unknown",this.options=n||{}}oa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new a9(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.ua?this.la(e)&&(this.aa.next(e),t=!0):this.ha(e,this.onlineState)&&(this.Pa(e),t=!0),this.ca=e,t}onError(e){this.aa.error(e)}sa(e){this.onlineState=e;let t=!1;return this.ca&&!this.ua&&this.ha(this.ca,e)&&(this.Pa(this.ca),t=!0),t}ha(e,t){return!(e.fromCache&&this.ra())||(!this.options.Ta||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}la(e){if(e.docChanges.length>0)return!0;let t=this.ca&&this.ca.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Pa(e){e=a9.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.ua=!0,this.aa.next(e)}ra(){return this.options.source!==s.Cache}}class ol{constructor(e,t){this.Ia=e,this.byteLength=t}Ea(){return"metadata"in this.Ia}}class ou{constructor(e){this.serializer=e}ps(e){return ia(this.serializer,e)}ys(e){return e.metadata.exists?id(this.serializer,e.document,!1):np.newNoDocument(this.ps(e.metadata.name),this.ws(e.metadata.readTime))}ws(e){return ie(e)}}class oh{constructor(e,t,n){this.da=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=oc(e)}Aa(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Ia.namedQuery)this.queries.push(e.Ia.namedQuery);else if(e.Ia.documentMetadata){this.documents.push({metadata:e.Ia.documentMetadata}),e.Ia.documentMetadata.exists||++t;let n=Y.fromString(e.Ia.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Ia.document&&(this.documents[this.documents.length-1].document=e.Ia.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Ra(e){let t=new Map,n=new ou(this.serializer);for(let r of e)if(r.metadata.queries){let e=n.ps(r.metadata.name);for(let n of r.metadata.queries){let r=(t.get(n)||rs()).add(e);t.set(n,r)}}return t}async complete(){let e=await s2(this.localStore,new ou(this.serializer),this.documents,this.da.id),t=this.Ra(this.documents);for(let e of this.queries)await s5(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Va:this.collectionGroups,ma:e}}}function oc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class od{constructor(e){this.key=e}}class of{constructor(e){this.key=e}}class om{constructor(e,t){this.query=e,this.fa=t,this.ga=null,this.hasCachedResults=!1,this.current=!1,this.pa=rs(),this.mutatedKeys=rs(),this.ya=n4(e),this.wa=new a4(this.ya)}get Sa(){return this.fa}ba(e,t){let n=t?t.Da:new a6,r=t?t.wa:this.wa,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=n8(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.va(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.ya(h,o)>0||l&&0>this.ya(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{wa:s,Da:n,ls:a,mutatedKeys:i}}va(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.wa;this.wa=e.wa,this.mutatedKeys=e.mutatedKeys;let s=e.Da.X_();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return x()}};return n(e)-n(t)})(e.type,t.type)||this.ya(e.doc,t.doc)),this.Ca(n),r=null!=r&&r;let a=t&&!r?this.Fa():[],o=0===this.pa.size&&this.current&&!r?1:0,l=o!==this.ga;return(this.ga=o,0!==s.length||l)?{snapshot:new a9(this.query,e.wa,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),Ma:a}:{Ma:a}}sa(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({wa:this.wa,Da:new a6,mutatedKeys:this.mutatedKeys,ls:!1},!1)):{Ma:[]}}xa(e){return!this.fa.has(e)&&!!this.wa.has(e)&&!this.wa.get(e).hasLocalMutations}Ca(e){e&&(e.addedDocuments.forEach(e=>this.fa=this.fa.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.fa=this.fa.delete(e)),this.current=e.current)}Fa(){if(!this.current)return[];let e=this.pa;this.pa=rs(),this.wa.forEach(e=>{this.xa(e.key)&&(this.pa=this.pa.add(e.key))});let t=[];return e.forEach(e=>{this.pa.has(e)||t.push(new of(e))}),this.pa.forEach(n=>{e.has(n)||t.push(new od(n))}),t}Oa(e){this.fa=e.gs,this.pa=rs();let t=this.ba(e.documents);return this.applyChanges(t,!0)}Na(){return a9.fromInitialDocuments(this.query,this.wa,this.mutatedKeys,0===this.ga,this.hasCachedResults)}}let og="SyncEngine";class op{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class oy{constructor(e){this.key=e,this.Ba=!1}}class ow{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.La={},this.ka=new n6(e=>n2(e),n1),this.qa=new Map,this.Qa=new Set,this.$a=new tD(X.comparator),this.Ua=new Map,this.Ka=new sS,this.Wa={},this.Ga=new Map,this.za=si.Kn(),this.onlineState="Unknown",this.ja=void 0}get isPrimaryClient(){return!0===this.ja}}async function ov(e,t,n=!0){let r,i=oY(e),s=i.ka.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.Na()):r=await o_(i,t,n,!0),r}async function oI(e,t){let n=oY(e);await o_(n,t,!0,!1)}async function o_(e,t,n,r){let i,s=await sY(e.localStore,nY(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await oT(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aM(e.remoteStore,s),i}async function oT(e,t,n,r,i){e.Ha=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ba(n);i.ls&&(i=await sJ(e.localStore,t.query,!1).then(({documents:e})=>t.view.ba(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return oO(e,t.targetId,o.Ma),o.snapshot})(e,t,n,r);let s=await sJ(e.localStore,t,!0),a=new om(t,s.gs),o=a.ba(s.documents),l=rH.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);oO(e,n,u.Ma);let h=new op(t,n,a);return e.ka.set(t,h),e.qa.has(n)?e.qa.get(n).push(t):e.qa.set(n,[t]),u.snapshot}async function ob(e,t,n){let r=e.ka.get(t),i=e.qa.get(r.targetId);if(i.length>1)return e.qa.set(r.targetId,i.filter(e=>!n1(e,t))),void e.ka.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sZ(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aF(e.remoteStore,r.targetId),oM(e,r.targetId)}).catch(ed)):(oM(e,r.targetId),await sZ(e.localStore,r.targetId,!0))}async function oE(e,t){let n=e.ka.get(t),r=e.qa.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aF(e.remoteStore,n.targetId))}async function oS(e,t,n){let r=oZ(e);try{var i;let e,s=await function(e,t){let n,r,i=j.now(),s=t.reduce((e,t)=>e.add(t.key),rs());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=n9,l=rs();return e.ds.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rc(r.transform,e||null);null!=i&&(null===n&&(n=ng.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rk(e.key,t,function e(t){let n=[];return tN(t.fields,(t,r)=>{let i=new J([t]);if(nl(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tO(n)}(t.value.mapValue),rT.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:rt(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Wa[r.currentUser.toKey()])||(e=new tD(z)),e=e.insert(i,n),r.Wa[r.currentUser.toKey()]=e,await oP(r,s.changes),await aQ(r.remoteStore)}catch(t){let e=a3(t,"Failed to persist write");n.reject(e)}}async function ox(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.Ts;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.ds.newChangeBuffer({trackRemovals:!0});r=e.Ts;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Hr.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Hr.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tq.EMPTY_BYTE_STRING,Q.min()).withLastLimboFreeSnapshotVersion(Q.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Hr.updateTargetData(i,h))});let o=n9,l=rs();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sH(i,s,t.documentUpdates).next(e=>{o=e.Vs,l=e.fs})),!n.isEqual(Q.min())){let t=e.Hr.getLastRemoteSnapshotVersion(i).next(t=>e.Hr.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ef.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ts=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Ua.get(n);r&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||x(),t.addedDocuments.size>0?r.Ba=!0:t.modifiedDocuments.size>0?r.Ba||x():t.removedDocuments.size>0&&(r.Ba||x(),r.Ba=!1))}),await oP(e,n,t)}catch(e){await ed(e)}}function oN(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.ka.forEach((e,n)=>{let r=n.view.sa(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.ta)e.sa(t)&&(n=!0)}),n&&oa(r),i.length&&e.La.p_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function oC(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Ua.get(t),i=r&&r.key;if(i){let n=new tD(X.comparator);n=n.insert(i,np.newNoDocument(i,Q.min()));let r=rs().add(i),s=new rW(Q.min(),new Map,new tD(z),n,r);await ox(e,s),e.$a=e.$a.remove(i),e.Ua.delete(t),oL(e)}else await sZ(e.localStore,t,!1).then(()=>oM(e,t,n)).catch(ed)}async function ok(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.ds.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ef.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);null!==s||x(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=rs();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))}));oV(e,r,null),oR(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oP(e,i)}catch(e){await ed(e)}}async function oD(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||x(),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));oV(e,t,n),oR(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oP(e,i)}catch(e){await ed(e)}}async function oA(e,t){var n;aU(e.remoteStore)||T(og,"The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=await (n=e.localStore).persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>n.mutationQueue.getHighestUnacknowledgedBatchId(e));if(-1===r)return void t.resolve();let i=e.Ga.get(r)||[];i.push(t),e.Ga.set(r,i)}catch(n){let e=a3(n,"Initialization of waitForPendingWrites() operation failed");t.reject(e)}}function oR(e,t){(e.Ga.get(t)||[]).forEach(e=>{e.resolve()}),e.Ga.delete(t)}function oV(e,t,n){let r=e.Wa[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Wa[e.currentUser.toKey()]=r}}function oM(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.qa.get(t)))e.ka.delete(r),n&&e.La.Ja(r,n);e.qa.delete(t),e.isPrimaryClient&&e.Ka.br(t).forEach(t=>{e.Ka.containsKey(t)||oF(e,t)})}function oF(e,t){e.Qa.delete(t.path.canonicalString());let n=e.$a.get(t);null!==n&&(aF(e.remoteStore,n),e.$a=e.$a.remove(t),e.Ua.delete(n),oL(e))}function oO(e,t,n){for(let r of n)r instanceof od?(e.Ka.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.$a.get(n)||e.Qa.has(r)||(T(og,"New document in limbo: "+n),e.Qa.add(r),oL(e))}(e,r)):r instanceof of?(T(og,"Document no longer in limbo: "+r.key),e.Ka.removeReference(r.key,t),e.Ka.containsKey(r.key)||oF(e,r.key)):x()}function oL(e){for(;e.Qa.size>0&&e.$a.size<e.maxConcurrentLimboResolutions;){let t=e.Qa.values().next().value;e.Qa.delete(t);let n=new X(Y.fromString(t)),r=e.za.next();e.Ua.set(r,new oy(n)),e.$a=e.$a.insert(n,r),aM(e.remoteStore,new ib(nY(nj(n.path)),r,"TargetPurposeLimboResolution",eC.ae))}}async function oP(e,t,n){let r=[],i=[],s=[];e.ka.isEmpty()||(e.ka.forEach((a,o)=>{s.push(e.Ha(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null==(s=null==n?void 0:n.targetChanges.get(o.targetId))?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sz.Yi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.La.p_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ef.forEach(t,t=>ef.forEach(t.Hi,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ef.forEach(t.Ji,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eI(e))throw e;T(sG,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.Ts.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.Ts=e.Ts.insert(t,i)}}}(e.localStore,i))}async function oq(e,t){if(!e.currentUser.isEqual(t)){T(og,"User change. New user:",t.toKey());let n=await sQ(e.localStore,t);e.currentUser=t,e.Ga.forEach(e=>{e.forEach(e=>{e.reject(new k(C.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ga.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await oP(e,n.Rs)}}function oU(e,t){let n=e.Ua.get(t);if(n&&n.Ba)return rs().add(n.key);{let n=rs(),r=e.qa.get(t);if(!r)return n;for(let t of r){let r=e.ka.get(t);n=n.unionWith(r.view.Sa)}return n}}async function oB(e,t){let n=await sJ(e.localStore,t.query,!0),r=t.view.Oa(n);return e.isPrimaryClient&&oO(e,t.targetId,r.Ma),r}async function oz(e,t){return s0(e.localStore,t).then(t=>oP(e,t))}async function oK(e,t,n,r){var i;let s=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.Ln(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):ef.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await aQ(e.remoteStore):"acknowledged"===n||"rejected"===n?(oV(e,t,r||null),oR(e,t),i=e.localStore,i.mutationQueue.qn(t)):x(),await oP(e,s)):T(og,"Cannot apply mutation batch with id: "+t)}async function o$(e,t){if(oY(e),oZ(e),!0===t&&!0!==e.ja){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await oG(e,t.toArray());for(let t of(e.ja=!0,await a1(e.remoteStore,!0),n))aM(e.remoteStore,t)}else if(!1===t&&!1!==e.ja){let t=[],n=Promise.resolve();e.qa.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(oM(e,i),sZ(e.localStore,i,!0))),aF(e.remoteStore,i)}),await n,await oG(e,t),e.Ua.forEach((t,n)=>{aF(e.remoteStore,n)}),e.Ka.Dr(),e.Ua=new Map,e.$a=new tD(X.comparator),e.ja=!1,await a1(e.remoteStore,!1)}}async function oG(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.qa.get(n);if(s&&0!==s.length)for(let n of(t=await sY(e.localStore,nY(s[0])),s)){let t=e.ka.get(n),r=await oB(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sX(e.localStore,n);t=await sY(e.localStore,r),await oT(e,oj(r),n,!1,t.resumeToken)}r.push(t)}return e.La.p_(i),r}function oj(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new nG(t,n,r,i,s,"F",e.startAt,e.endAt)}function oQ(e){return e.localStore.persistence.zi()}async function oW(e,t,n,r){if(e.ja)return void T(og,"Ignoring unexpected query state notification.");let i=e.qa.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await s0(e.localStore,n3(i[0])),s=rW.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tq.EMPTY_BYTE_STRING);await oP(e,r,s);break}case"rejected":await sZ(e.localStore,t,!0),oM(e,t,r);break;default:x()}}async function oH(e,t,n){let r=oY(e);if(r.ja){for(let e of t){if(r.qa.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){T(og,"Adding an already active target "+e);continue}let t=await sX(r.localStore,e),n=await sY(r.localStore,t);await oT(r,oj(t),n.targetId,!1,n.resumeToken),aM(r.remoteStore,n)}for(let e of n)r.qa.has(e)&&await sZ(r.localStore,e,!1).then(()=>{aF(r.remoteStore,e),oM(r,e)}).catch(ed)}}function oY(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=ox.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=oU.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=oC.bind(null,e),e.La.p_=oi.bind(null,e.eventManager),e.La.Ja=os.bind(null,e.eventManager),e}function oZ(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=ok.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=oD.bind(null,e),e}class oJ{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=a_(e.databaseInfo.databaseId),this.sharedClientState=this.Za(e),this.persistence=this.Xa(e),await this.persistence.start(),this.localStore=this.eu(e),this.gcScheduler=this.tu(e,this.localStore),this.indexBackfillerScheduler=this.nu(e,this.localStore)}tu(e,t){return null}nu(e,t){return null}eu(e){var t,n;return t=this.persistence,n=new s$,new sj(t,n,e.initialUser,this.serializer)}Xa(e){return new sA(sV.ri,this.serializer)}Za(e){return new ao}async terminate(){var e,t;null==(e=this.gcScheduler)||e.stop(),null==(t=this.indexBackfillerScheduler)||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oJ.provider={build:()=>new oJ};class oX extends oJ{constructor(e){super(),this.cacheSizeBytes=e}tu(e,t){return this.persistence.referenceDelegate instanceof sM||x(),new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Xa(e){let t=void 0!==this.cacheSizeBytes?i9.withCacheSize(this.cacheSizeBytes):i9.DEFAULT;return new sA(e=>sM.ri(e,t),this.serializer)}}class o0 extends oJ{constructor(e,t,n){super(),this.ru=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.ru.initialize(this,e),await oZ(this.ru.syncEngine),await aQ(this.ru.remoteStore),await this.persistence.Ci(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}eu(e){var t,n;return t=this.persistence,n=new s$,new sj(t,n,e.initialUser,this.serializer)}tu(e,t){return new sh(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}nu(e,t){let n=new eN(t,this.persistence);return new ex(e.asyncQueue,n)}Xa(e){let t=sB(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?i9.withCacheSize(this.cacheSizeBytes):i9.DEFAULT;return new sU(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,av(),aI(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Za(e){return new ao}}class o1 extends o0{constructor(e,t){super(e,t,!1),this.ru=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.ru.syncEngine;this.sharedClientState instanceof aa&&(this.sharedClientState.syncEngine={uo:oK.bind(null,t),co:oW.bind(null,t),lo:oH.bind(null,t),zi:oQ.bind(null,t),ao:oz.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ci(async e=>{await o$(this.ru.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Za(e){let t=av();if(!aa.D(t))throw new k(C.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=sB(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new aa(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class o2{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>oN(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oq.bind(null,this.syncEngine),await a1(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new oe}createDatastore(e){var t;let n=a_(e.databaseInfo.databaseId),r=new aw(e.databaseInfo);return t=e.authCredentials,new aC(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new aA(t,n,e.asyncQueue,e=>oN(this.syncEngine,e,0),ah.D()?new ah:new al)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new ow(e,t,n,r,i,s);return a&&(o.ja=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){T(aD,"RemoteStore shutting down."),e.W_.add(5),await aV(e),e.z_.shutdown(),e.j_.set("Unknown")}(this.remoteStore),null==(e=this.datastore)||e.terminate(),null==(t=this.eventManager)||t.terminate()}}function o5(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){let r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}o2.provider={build:()=>new o2};class o8{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.iu(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.iu(this.observer.error,e):b("Uncaught Error in snapshot listener:",e.toString()))}su(){this.muted=!0}iu(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class o3{constructor(e,t){this.ou=e,this.serializer=t,this.metadata=new D,this.buffer=new Uint8Array,this._u=new TextDecoder("utf-8"),this.au().then(e=>{e&&e.Ea()?this.metadata.resolve(e.Ia.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(null==e?void 0:e.Ia)}`))},e=>this.metadata.reject(e))}close(){return this.ou.cancel()}async getMetadata(){return this.metadata.promise}async Ya(){return await this.getMetadata(),this.au()}async au(){let e=await this.uu();if(null===e)return null;let t=this._u.decode(e),n=Number(t);return isNaN(n)&&this.cu(`length string (${t}) is not valid number`),new ol(JSON.parse(await this.lu(n)),e.length+n)}hu(){return this.buffer.findIndex(e=>123===e)}async uu(){for(;0>this.hu()&&!await this.Pu(););if(0===this.buffer.length)return null;let e=this.hu();e<0&&this.cu("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async lu(e){for(;this.buffer.length<e;)await this.Pu()&&this.cu("Reached the end of bundle when more is expected.");let t=this._u.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}cu(e){throw this.ou.cancel(),Error(`Invalid bundle format: ${e}`)}async Pu(){let e=await this.ou.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class o4{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(C.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>is(e.serializer,t))},r=await e.Co("BatchGetDocuments",e.serializer.databaseId,Y.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){t.found||x(),t.found.name,t.found.updateTime;let n=ia(e,t.found.name),r=ie(t.found.updateTime),i=t.found.createTime?ie(t.found.createTime):Q.min(),s=new ng({mapValue:{fields:t.found.fields}});return np.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){t.missing||x(),t.readTime||x();let n=ia(e,t.missing),r=ie(t.readTime);return np.newNoDocument(n,r)}(n,t):x());i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());t||x(),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new rV(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=X.fromPath(t);this.mutations.push(new rM(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>im(e.serializer,t))};await e.So("Commit",e.serializer.databaseId,Y.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw x();t=Q.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new k(C.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(Q.min())?rT.exists(!1):rT.updateTime(t):rT.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(Q.min()))throw new k(C.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return rT.updateTime(t)}return rT.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class o6{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Tu=n.maxAttempts,this.a_=new aT(this.asyncQueue,"transaction_retry")}Iu(){this.Tu-=1,this.Eu()}Eu(){this.a_.Xo(async()=>{let e=new o4(this.datastore),t=this.du(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.Au(e)}))}).catch(e=>{this.Au(e)})})}du(e){try{let t=this.updateFunction(e);return!ek(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Au(e){this.Tu>0&&this.Ru(e)?(this.Tu-=1,this.asyncQueue.enqueueAndForget(()=>(this.Eu(),Promise.resolve()))):this.deferred.reject(e)}Ru(e){if("FirebaseError"===e.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!rU(t)}return!1}}let o9="FirestoreClient";class o7{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=B.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{T(o9,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(T(o9,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new D;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=a3(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function le(e,t){e.asyncQueue.verifyOperationInProgress(),T(o9,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sQ(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function lt(e,t){e.asyncQueue.verifyOperationInProgress();let n=await ln(e);T(o9,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>a0(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>a0(t.remoteStore,n)),e._onlineComponents=t}async function ln(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){T(o9,"Using user provided OfflineComponentProvider");try{await le(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===C.FAILED_PRECONDITION||t.code===C.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;E("Error using user provided cache. Falling back to memory cache: "+t),await le(e,new oJ)}}else T(o9,"Using default OfflineComponentProvider"),await le(e,new oX(void 0));return e._offlineComponents}async function lr(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(o9,"Using user provided OnlineComponentProvider"),await lt(e,e._uninitializedComponentsProvider._online)):(T(o9,"Using default OnlineComponentProvider"),await lt(e,new o2))),e._onlineComponents}function li(e){return ln(e).then(e=>e.persistence)}function ls(e){return ln(e).then(e=>e.localStore)}function la(e){return lr(e).then(e=>e.remoteStore)}function lo(e){return lr(e).then(e=>e.syncEngine)}function ll(e){return lr(e).then(e=>e.datastore)}async function lu(e){let t=await lr(e),n=t.eventManager;return n.onListen=ov.bind(null,t.syncEngine),n.onUnlisten=ob.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=oI.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oE.bind(null,t.syncEngine),n}function lh(e,t,n={}){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new o8({next:o=>{s.su(),t.enqueueAndForget(()=>or(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new k(C.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new k(C.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new oo(nj(n.path),s,{includeMetadataChanges:!0,Ta:!0});return on(e,a)})(await lu(e),e.asyncQueue,t,n,r)),r.promise}function lc(e,t,n={}){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new o8({next:n=>{s.su(),t.enqueueAndForget(()=>or(e,a)),n.fromCache&&"server"===r.source?i.reject(new k(C.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new oo(n,s,{includeMetadataChanges:!0,Ta:!0});return on(e,a)})(await lu(e),e.asyncQueue,t,n,r)),r.promise}function ld(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let lf=new Map;function lm(e,t,n){if(!n)throw new k(C.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function lg(e,t,n,r){if(!0===t&&!0===r)throw new k(C.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function lp(e){if(!X.isDocumentKey(e))throw new k(C.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function ly(e){if(X.isDocumentKey(e))throw new k(C.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function lw(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":x()}function lv(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new k(C.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=lw(e);throw new k(C.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function lI(e,t){if(t<=0)throw new k(C.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}let l_="firestore.googleapis.com";class lT{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new k(C.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=l_,this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new k(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}lg("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=ld(null!=(n=e.experimentalLongPollingOptions)?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new k(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new k(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new k(C.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class lb{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new lT({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new k(C.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new k(C.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new lT(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new R;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new k(C.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=lf.get(e);t&&(T("ComponentProvider","Removing Datastore"),lf.delete(e),t.terminate())}(this),Promise.resolve()}}function lE(e,t,n,r={}){var i;let s=(e=lv(e,lb))._getSettings(),a=Object.assign(Object.assign({},s),{emulatorOptions:e._getEmulatorOptions()}),o=`${t}:${n}`;s.host!==l_&&s.host!==o&&E("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l=Object.assign(Object.assign({},s),{host:o,ssl:!1,emulatorOptions:r});if(!(0,h.bD)(l,a)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=(0,h.Fy)(r.mockUserToken,null==(i=e._app)?void 0:i.options.projectId);let s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new k(C.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(s)}e._authCredentials=new V(new A(t,n))}}class lS{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new lS(this.firestore,e,this._query)}}class lx{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new lN(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lx(this.firestore,e,this._key)}}class lN extends lS{constructor(e,t,n){super(e,t,nj(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lx(this.firestore,null,new X(e))}withConverter(e){return new lN(this.firestore,e,this._path)}}function lC(e,t,...n){if(e=(0,h.Ku)(e),lm("collection","path",t),e instanceof lb){let r=Y.fromString(t,...n);return ly(r),new lN(e,null,r)}{if(!(e instanceof lx||e instanceof lN))throw new k(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(Y.fromString(t,...n));return ly(r),new lN(e.firestore,null,r)}}function lk(e,t){if(e=lv(e,lb),lm("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new k(C.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new lS(e,null,new nG(Y.emptyPath(),t))}function lD(e,t,...n){if(e=(0,h.Ku)(e),1==arguments.length&&(t=B.newId()),lm("doc","path",t),e instanceof lb){let r=Y.fromString(t,...n);return lp(r),new lx(e,null,new X(r))}{if(!(e instanceof lx||e instanceof lN))throw new k(C.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(Y.fromString(t,...n));return lp(r),new lx(e.firestore,e instanceof lN?e.converter:null,new X(r))}}function lA(e,t){return e=(0,h.Ku)(e),t=(0,h.Ku)(t),(e instanceof lx||e instanceof lN)&&(t instanceof lx||t instanceof lN)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function lR(e,t){return e=(0,h.Ku)(e),t=(0,h.Ku)(t),e instanceof lS&&t instanceof lS&&e.firestore===t.firestore&&n1(e._query,t._query)&&e.converter===t.converter}let lV="AsyncQueue";class lM{constructor(e=Promise.resolve()){this.Vu=[],this.mu=!1,this.fu=[],this.gu=null,this.pu=!1,this.yu=!1,this.wu=[],this.a_=new aT(this,"async_queue_retry"),this.Su=()=>{let e=aI();e&&T(lV,"Visibility state changed to "+e.visibilityState),this.a_.t_()},this.bu=e;let t=aI();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Su)}get isShuttingDown(){return this.mu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Du(),this.vu(e)}enterRestrictedMode(e){if(!this.mu){this.mu=!0,this.yu=e||!1;let t=aI();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Su)}}enqueue(e){if(this.Du(),this.mu)return new Promise(()=>{});let t=new D;return this.vu(()=>this.mu&&this.yu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Vu.push(e),this.Cu()))}async Cu(){if(0!==this.Vu.length){try{await this.Vu[0](),this.Vu.shift(),this.a_.reset()}catch(e){if(!eI(e))throw e;T(lV,"Operation failed with retryable error: "+e)}this.Vu.length>0&&this.a_.Xo(()=>this.Cu())}}vu(e){let t=this.bu.then(()=>(this.pu=!0,e().catch(e=>{let t;throw this.gu=e,this.pu=!1,b("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.pu=!1,e))));return this.bu=t,t}enqueueAfterDelay(e,t,n){this.Du(),this.wu.indexOf(e)>-1&&(t=0);let r=a8.createAndSchedule(this,e,t,n,e=>this.Fu(e));return this.fu.push(r),r}Du(){this.gu&&x()}verifyOperationInProgress(){}async Mu(){let e;do e=this.bu,await e;while(e!==this.bu)}xu(e){for(let t of this.fu)if(t.timerId===e)return!0;return!1}Ou(e){return this.Mu().then(()=>{for(let t of(this.fu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.fu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Mu()})}Nu(e){this.wu.push(e)}Fu(e){let t=this.fu.indexOf(e);this.fu.splice(t,1)}}function lF(e){if("object"!=typeof e||null===e)return!1;for(let t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}class lO{constructor(){this._progressObserver={},this._taskCompletionResolver=new D,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}let lL=-1;class lP extends lb{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new lM,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new lM(e),this._firestoreClient=void 0,await e}}}function lq(e,t,n){n||(n=tJ);let r=(0,o.j6)(e,"firestore");if(r.isInitialized(n)){let e=r.getImmediate({identifier:n}),i=r.getOptions(n);if((0,h.bD)(i,t))return e;throw new k(C.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new k(C.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new k(C.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:t,instanceIdentifier:n})}function lU(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r="string"==typeof e?e:t||tJ,i=(0,o.j6)(n,"firestore").getImmediate({identifier:r});if(!i._initialized){let e=(0,h.yU)("firestore");e&&lE(i,...e)}return i}function lB(e){if(e._terminated)throw new k(C.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||lz(e),e._firestoreClient}function lz(e){var t,n,r,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null==(t=e._app)?void 0:t.options.appId)||"",new tZ(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,ld(a.experimentalLongPollingOptions),a.useFetchStreams));e._componentsProvider||(null==(n=a.localCache)?void 0:n._offlineComponentProvider)&&(null==(r=a.localCache)?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new o7(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}function lK(e,t){E("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let n=e._freezeSettings();return lG(e,o2.provider,{build:e=>new o0(e,n.cacheSizeBytes,null==t?void 0:t.forceOwnership)}),Promise.resolve()}async function l$(e){E("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=e._freezeSettings();lG(e,o2.provider,{build:e=>new o1(e,t.cacheSizeBytes)})}function lG(e,t,n){if((e=lv(e,lP))._firestoreClient||e._terminated)throw new k(C.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(e._componentsProvider||e._getSettings().localCache)throw new k(C.FAILED_PRECONDITION,"SDK cache is already specified.");e._componentsProvider={_online:t,_offline:n},lz(e)}function lj(e){if(e._initialized&&!e._terminated)throw new k(C.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let t=new D;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!ep.D())return Promise.resolve();await ep.delete(e+sq)}(sB(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}function lQ(e){var t=lB(e=lv(e,lP));let n=new D;return t.asyncQueue.enqueueAndForget(async()=>oA(await lo(t),n)),n.promise}function lW(e){var t;return(t=lB(e=lv(e,lP))).asyncQueue.enqueue(async()=>{let e=await li(t),n=await la(t);return e.setNetworkEnabled(!0),n.W_.delete(0),aR(n)})}function lH(e){var t;return(t=lB(e=lv(e,lP))).asyncQueue.enqueue(async()=>{let e=await li(t),n=await la(t);return e.setNetworkEnabled(!1),async function(e){e.W_.add(0),await aV(e),e.j_.set("Offline")}(n)})}function lY(e){return(0,o.Us)(e.app,"firestore",e._databaseId.database),e._delete()}function lZ(e,t){let n=lB(e=lv(e,lP)),r=new lO;return function(e,t,n,r){var i;let s=(i=a_(t),new o3(function(e,t){if(e instanceof Uint8Array)return o5(e,void 0);if(e instanceof ArrayBuffer)return o5(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?U().encode(n):n),i));e.asyncQueue.enqueueAndForget(async()=>{var t;(async function(e,t,n){try{var r;let i=await t.getMetadata();if(await function(e,t){let n=ie(t.createTime);return e.persistence.runTransaction("hasNewerBundle","readonly",n=>e.Yr.getBundleMetadata(n,t.id)).then(e=>!!e&&e.createTime.compareTo(n)>=0)}(e.localStore,i))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:i.totalDocuments,bytesLoaded:i.totalBytes,totalDocuments:i.totalDocuments,totalBytes:i.totalBytes}),Promise.resolve(new Set);n._updateProgress(oc(i));let s=new oh(i,e.localStore,t.serializer),a=await t.Ya();for(;a;){let e=await s.Aa(a);e&&n._updateProgress(e),a=await t.Ya()}let o=await s.complete();return await oP(e,o.ma,void 0),await (r=e.localStore,r.persistence.runTransaction("Save bundle","readwrite",e=>r.Yr.saveBundleMetadata(e,i))),n._completeWith(o.progress),Promise.resolve(o.Va)}catch(e){return E(og,`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(t=await lo(e),s,r).then(e=>{t.sharedClientState.notifyBundleLoaded(e)})})}(n,e._databaseId,t,r),r}function lJ(e,t){var n;return(n=lB(e=lv(e,lP)),n.asyncQueue.enqueue(async()=>{var e;return e=await ls(n),e.persistence.runTransaction("Get named query","readonly",n=>e.Yr.getNamedQuery(n,t))})).then(t=>t?new lS(e,null,t.query):null)}class lX{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class l0{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class l1{constructor(e){this._byteString=e}static fromBase64String(e){try{return new l1(tq.fromBase64String(e))}catch(e){throw new k(C.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new l1(tq.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class l2{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new k(C.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new J(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}function l5(){return new l2(W)}class l8{constructor(e){this._methodName=e}}class l3{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(C.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(C.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return z(this._lat,e._lat)||z(this._long,e._long)}}class l4{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let l6=/^__.*__$/;class l9{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rk(e,this.data,this.fieldMask,t,this.fieldTransforms):new rC(e,this.data,t,this.fieldTransforms)}}class l7{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rk(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function ue(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw x()}}class ut{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Bu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Lu(){return this.settings.Lu}ku(e){return new ut(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}qu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.$u(e),r}Uu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.ku({path:n,Qu:!1});return r.Bu(),r}Ku(e){return this.ku({path:void 0,Qu:!0})}Wu(e){return u_(e,this.settings.methodName,this.settings.Gu||!1,this.path,this.settings.zu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Bu(){if(this.path)for(let e=0;e<this.path.length;e++)this.$u(this.path.get(e))}$u(e){if(0===e.length)throw this.Wu("Document fields must not be empty");if(ue(this.Lu)&&l6.test(e))throw this.Wu('Document fields cannot begin and end with "__"')}}class un{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||a_(e)}ju(e,t,n,r=!1){return new ut({Lu:e,methodName:t,zu:n,path:J.emptyPath(),Qu:!1,Gu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ur(e){let t=e._freezeSettings(),n=a_(e._databaseId);return new un(e._databaseId,!!t.ignoreUndefinedProperties,n)}function ui(e,t,n,r,i,s={}){let a,o,l=e.ju(s.merge||s.mergeFields?2:0,t,n,i);uy("Data must be an object, but it was:",l,r);let u=ug(r,l);if(s.merge)a=new tO(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=uw(t,r,n);if(!l.contains(i))throw new k(C.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);uT(e,i)||e.push(i)}a=new tO(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new l9(new ng(u),a,o)}class us extends l8{_toFieldTransform(e){if(2!==e.Lu)throw 1===e.Lu?e.Wu(`${this._methodName}() can only appear at the top level of your update data`):e.Wu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof us}}function ua(e,t,n){return new ut({Lu:3,zu:t.settings.zu,methodName:e._methodName,Qu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class uo extends l8{_toFieldTransform(e){return new rI(e.path,new rd)}isEqual(e){return e instanceof uo}}class ul extends l8{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ua(this,e,!0),n=new rf(this.Hu.map(e=>um(e,t)));return new rI(e.path,n)}isEqual(e){return e instanceof ul&&(0,h.bD)(this.Hu,e.Hu)}}class uu extends l8{constructor(e,t){super(e),this.Hu=t}_toFieldTransform(e){let t=ua(this,e,!0),n=new rg(this.Hu.map(e=>um(e,t)));return new rI(e.path,n)}isEqual(e){return e instanceof uu&&(0,h.bD)(this.Hu,e.Hu)}}class uh extends l8{constructor(e,t){super(e),this.Ju=t}_toFieldTransform(e){let t=new ry(e.serializer,ru(e.serializer,this.Ju));return new rI(e.path,t)}isEqual(e){return e instanceof uh&&this.Ju===e.Ju}}function uc(e,t,n,r){let i=e.ju(1,t,n);uy("Data must be an object, but it was:",i,r);let s=[],a=ng.empty();return tN(r,(e,r)=>{let o=uI(t,e,n);r=(0,h.Ku)(r);let l=i.Uu(o);if(r instanceof us)s.push(o);else{let e=um(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new l7(a,new tO(s),i.fieldTransforms)}function ud(e,t,n,r,i,s){let a=e.ju(1,t,n),o=[uw(t,r,n)],l=[i];if(s.length%2!=0)throw new k(C.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(uw(t,s[e])),l.push(s[e+1]);let u=[],c=ng.empty();for(let e=o.length-1;e>=0;--e)if(!uT(u,o[e])){let t=o[e],n=l[e];n=(0,h.Ku)(n);let r=a.Uu(t);if(n instanceof us)u.push(t);else{let e=um(n,r);null!=e&&(u.push(t),c.set(t,e))}}return new l7(c,new tO(u),a.fieldTransforms)}function uf(e,t,n,r=!1){return um(n,e.ju(r?4:3,t))}function um(e,t){if(up(e=(0,h.Ku)(e)))return uy("Unsupported field value:",t,e),ug(e,t);if(e instanceof l8)return function(e,t){if(!ue(t.Lu))throw t.Wu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Wu(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Qu&&4!==t.Lu)throw t.Wu("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=um(i,t.Ku(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return ru(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=j.fromDate(e);return{timestampValue:r9(t.serializer,n)}}if(e instanceof j){let n=new j(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:r9(t.serializer,n)}}if(e instanceof l3)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof l1)return{bytesValue:r7(t.serializer,e._byteString)};if(e instanceof lx){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Wu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:it(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof l4)return{mapValue:{fields:{[t0]:{stringValue:t5},[t8]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Wu("VectorValues must only contain numeric values.");return ro(t.serializer,e)})}}}}};throw t.Wu(`Unsupported field value: ${lw(e)}`)}(e,t)}function ug(e,t){let n={};return tk(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tN(e,(e,r)=>{let i=um(r,t.qu(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function up(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof j||e instanceof l3||e instanceof l1||e instanceof lx||e instanceof l8||e instanceof l4)}function uy(e,t,n){if(!up(n)||"object"!=typeof n||null===n||Object.getPrototypeOf(n)!==Object.prototype&&null!==Object.getPrototypeOf(n)){let r=lw(n);throw"an object"===r?t.Wu(e+" a custom object"):t.Wu(e+" "+r)}}function uw(e,t,n){if((t=(0,h.Ku)(t))instanceof l2)return t._internalPath;if("string"==typeof t)return uI(e,t);throw u_("Field path arguments must be of type string or ",e,!1,void 0,n)}let uv=RegExp("[~\\*/\\[\\]]");function uI(e,t,n){if(t.search(uv)>=0)throw u_(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new l2(...t.split("."))._internalPath}catch(r){throw u_(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function u_(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new k(C.INVALID_ARGUMENT,o+e+l)}function uT(e,t){return e.some(e=>e.isEqual(t))}class ub{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lx(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new uE(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(uS("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class uE extends ub{data(){return super.data()}}function uS(e,t){return"string"==typeof t?uI(e,t):t instanceof l2?t._internalPath:t._delegate._internalPath}function ux(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new k(C.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class uN{}class uC extends uN{}function uk(e,t,...n){let r=[];for(let i of(t instanceof uN&&r.push(t),function(e){let t=e.filter(e=>e instanceof uR).length,n=e.filter(e=>e instanceof uD).length;if(t>1||t>0&&n>0)throw new k(C.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e}class uD extends uC{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new uD(e,t,n)}_apply(e){let t=this._parse(e);return uH(e._query,t),new lS(e.firestore,e.converter,nX(e._query,t))}_parse(e){let t=ur(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new k(C.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){uW(a,s);let t=[];for(let n of a)t.push(uQ(r,e,n));o={arrayValue:{values:t}}}else o=uQ(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||uW(a,s),o=uf(n,t,a,"in"===s||"not-in"===s);return nT.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}function uA(e,t,n){let r=uS("where",e);return uD._create(r,t,n)}class uR extends uN{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new uR(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nb.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())uH(n,e),n=nX(n,e)}(e._query,t),new lS(e.firestore,e.converter,nX(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function uV(...e){return e.forEach(e=>uY("or",e)),uR._create("or",e)}function uM(...e){return e.forEach(e=>uY("and",e)),uR._create("and",e)}class uF extends uC{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new uF(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new k(C.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new k(C.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nI(t,n)}(e._query,this._field,this._direction);return new lS(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new nG(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function uO(e,t="asc"){let n=uS("orderBy",e);return uF._create(n,t)}class uL extends uC{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new uL(e,t,n)}_apply(e){return new lS(e.firestore,e.converter,n0(e._query,this._limit,this._limitType))}}function uP(e){return lI("limit",e),uL._create("limit",e,"F")}function uq(e){return lI("limitToLast",e),uL._create("limitToLast",e,"L")}class uU extends uC{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uU(e,t,n)}_apply(e){var t;let n=uj(e,this.type,this._docOrFields,this._inclusive);return new lS(e.firestore,e.converter,(t=e._query,new nG(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}function uB(...e){return uU._create("startAt",e,!0)}function uz(...e){return uU._create("startAfter",e,!1)}class uK extends uC{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new uK(e,t,n)}_apply(e){var t;let n=uj(e,this.type,this._docOrFields,this._inclusive);return new lS(e.firestore,e.converter,(t=e._query,new nG(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function u$(...e){return uK._create("endBefore",e,!1)}function uG(...e){return uK._create("endAt",e,!0)}function uj(e,t,n,r){if(n[0]=(0,h.Ku)(n[0]),n[0]instanceof ub)return function(e,t,n,r,i){if(!r)throw new k(C.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of nH(e))if(n.field.isKeyField())s.push(nr(t,r.key));else{let e=r.data.field(n.field);if(tW(e))throw new k(C.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new k(C.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new ny(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=ur(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new k(C.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new k(C.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!nW(e)&&-1!==l.indexOf("/"))throw new k(C.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(Y.fromString(l));if(!X.isDocumentKey(n))throw new k(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new X(n);o.push(nr(t,i))}else{let e=uf(n,r,l);o.push(e)}}return new ny(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function uQ(e,t,n){if("string"==typeof(n=(0,h.Ku)(n))){if(""===n)throw new k(C.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!nW(t)&&-1!==n.indexOf("/"))throw new k(C.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(Y.fromString(n));if(!X.isDocumentKey(r))throw new k(C.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return nr(e,new X(r))}if(n instanceof lx)return nr(e,n._key);throw new k(C.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${lw(n)}.`)}function uW(e,t){if(!Array.isArray(e)||0===e.length)throw new k(C.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function uH(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new k(C.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new k(C.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function uY(e,t){if(!(t instanceof uD||t instanceof uR))throw new k(C.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class uZ{convertValue(e,t="none"){switch(t4(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tz(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tK(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw x()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tN(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new l4(null==(r=null==(n=null==(t=e.fields)?void 0:t[t8].arrayValue)?void 0:n.values)?void 0:r.map(e=>tz(e.doubleValue)))}convertGeoPoint(e){return new l3(tz(e.latitude),tz(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tH(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tY(e));default:return null}}convertTimestamp(e){let t=tB(e);return new j(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=Y.fromString(e);iT(n)||x();let r=new tX(n.get(1),n.get(3)),i=new X(n.popFirst(5));return r.isEqual(t)||b(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function uJ(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class uX extends uZ{constructor(e){super(),this.firestore=e}convertBytes(e){return new l1(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lx(this.firestore,null,t)}}function u0(e){return new lX("sum",uw("sum",e))}function u1(e){return new lX("avg",uw("average",e))}function u2(){return new lX("count")}function u5(e,t){var n,r;return e instanceof lX&&t instanceof lX&&e.aggregateType===t.aggregateType&&(null==(n=e._internalFieldPath)?void 0:n.canonicalString())===(null==(r=t._internalFieldPath)?void 0:r.canonicalString())}function u8(e,t){return lR(e.query,t.query)&&(0,h.bD)(e.data(),t.data())}class u3{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class u4 extends ub{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new u6(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(uS("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class u6 extends u4{data(e={}){return super.data(e)}}class u9{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new u3(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new u6(this._firestore,this._userDataWriter,n.key,n,new u3(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(C.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new u6(e._firestore,e._userDataWriter,n.doc.key,n.doc,new u3(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new u6(e._firestore,e._userDataWriter,t.doc.key,t.doc,new u3(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return x()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function u7(e,t){return e instanceof u4&&t instanceof u4?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof u9&&t instanceof u9&&e._firestore===t._firestore&&lR(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function he(e){e=lv(e,lx);let t=lv(e.firestore,lP);return lh(lB(t),e._key).then(n=>hm(t,e,n))}class ht extends uZ{constructor(e){super(),this.firestore=e}convertBytes(e){return new l1(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lx(this.firestore,null,t)}}function hn(e){e=lv(e,lx);let t=lv(e.firestore,lP),n=lB(t),r=new ht(t);return(function(e,t){let n=new D;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await e.persistence.runTransaction("read document","readonly",n=>e.localDocuments.getDocument(n,t));r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new k(C.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(r){let e=a3(r,`Failed to get document '${t} from cache`);n.reject(e)}})(await ls(e),t,n)),n.promise})(n,e._key).then(n=>new u4(t,r,e._key,n,new u3(null!==n&&n.hasLocalMutations,!0),e.converter))}function hr(e){e=lv(e,lx);let t=lv(e.firestore,lP);return lh(lB(t),e._key,{source:"server"}).then(n=>hm(t,e,n))}function hi(e){e=lv(e,lS);let t=lv(e.firestore,lP),n=lB(t),r=new ht(t);return ux(e._query),lc(n,e._query).then(n=>new u9(t,r,e,n))}function hs(e){e=lv(e,lS);let t=lv(e.firestore,lP),n=lB(t),r=new ht(t);return(function(e,t){let n=new D;return e.asyncQueue.enqueueAndForget(async()=>(async function(e,t,n){try{let r=await sJ(e,t,!0),i=new om(t,r.gs),s=i.ba(r.documents),a=i.applyChanges(s,!1);n.resolve(a.snapshot)}catch(r){let e=a3(r,`Failed to execute query '${t} against cache`);n.reject(e)}})(await ls(e),t,n)),n.promise})(n,e._query).then(n=>new u9(t,r,e,n))}function ha(e){e=lv(e,lS);let t=lv(e.firestore,lP),n=lB(t),r=new ht(t);return lc(n,e._query,{source:"server"}).then(n=>new u9(t,r,e,n))}function ho(e,t,n){e=lv(e,lx);let r=lv(e.firestore,lP),i=uJ(e.converter,t,n);return hf(r,[ui(ur(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,rT.none())])}function hl(e,t,n,...r){e=lv(e,lx);let i=lv(e.firestore,lP),s=ur(i);return hf(i,[("string"==typeof(t=(0,h.Ku)(t))||t instanceof l2?ud(s,"updateDoc",e._key,t,n,r):uc(s,"updateDoc",e._key,t)).toMutation(e._key,rT.exists(!0))])}function hu(e){return hf(lv(e.firestore,lP),[new rV(e._key,rT.none())])}function hh(e,t){let n=lv(e.firestore,lP),r=lD(e),i=uJ(e.converter,t);return hf(n,[ui(ur(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,rT.exists(!1))]).then(()=>r)}function hc(e,...t){let n,r,i;e=(0,h.Ku)(e);let s={includeMetadataChanges:!1,source:"default"},a=0;"object"!=typeof t[0]||lF(t[a])||(s=t[a],a++);let o={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(lF(t[a])){let e=t[a];t[a]=null==(l=e.next)?void 0:l.bind(e),t[a+1]=null==(u=e.error)?void 0:u.bind(e),t[a+2]=null==(c=e.complete)?void 0:c.bind(e)}if(e instanceof lx)r=lv(e.firestore,lP),i=nj(e._key.path),n={next:n=>{t[a]&&t[a](hm(r,e,n))},error:t[a+1],complete:t[a+2]};else{let s=lv(e,lS);r=lv(s.firestore,lP),i=s._query;let o=new ht(r);n={next:e=>{t[a]&&t[a](new u9(r,o,s,e))},error:t[a+1],complete:t[a+2]},ux(e._query)}var l,u,c,d=lB(r),f=i;let m=new o8(n),g=new oo(f,m,o);return d.asyncQueue.enqueueAndForget(async()=>on(await lu(d),g)),()=>{m.su(),d.asyncQueue.enqueueAndForget(async()=>or(await lu(d),g))}}function hd(e,t){return function(e,t){let n=new o8(t);return e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lu(e),void(t.ia.add(n),n.next())}),()=>{n.su(),e.asyncQueue.enqueueAndForget(async()=>{var t;return t=await lu(e),void t.ia.delete(n)})}}(lB(e=lv(e,lP)),lF(t)?t:{next:t})}function hf(e,t){var n=lB(e);let r=new D;return n.asyncQueue.enqueueAndForget(async()=>oS(await lo(n),t,r)),r.promise}function hm(e,t,n){let r=n.docs.get(t._key),i=new ht(e);return new u4(e,i,t._key,r,new u3(n.hasPendingWrites,n.fromCache),t.converter)}function hg(e){return hp(e,{count:u2()})}function hp(e,t){let n=lv(e.firestore,lP),r=lB(n),i=tC(t,(e,t)=>new rP(t,e.aggregateType,e._internalFieldPath));return(function(e,t,n){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>{try{let i=await ll(e);r.resolve(async function(e,t,n){var r;let{request:i,Pt:s,parent:a}=iw(e.serializer,nZ(t),n);e.connection.fo||delete i.parent;let o=(await e.Co("RunAggregationQuery",e.serializer.databaseId,a,i,1)).filter(e=>!!e.result);1===o.length||x();let l=null==(r=o[0].result)?void 0:r.aggregateFields;return Object.keys(l).reduce((e,t)=>(e[s[t]]=l[t],e),{})}(i,t,n))}catch(e){r.reject(e)}}),r.promise})(r,e._query,i).then(t=>new l0(e,new ht(n),t))}class hy{constructor(e){this.kind="memory",this._onlineComponentProvider=o2.provider,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider={build:()=>new oX(void 0)}}toJSON(){return{kind:this.kind}}}class hw{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=hN(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class hv{constructor(){this.kind="memoryEager",this._offlineComponentProvider=oJ.provider}toJSON(){return{kind:this.kind}}}class hI{constructor(e){this.kind="memoryLru",this._offlineComponentProvider={build:()=>new oX(e)}}toJSON(){return{kind:this.kind}}}function h_(){return new hv}function hT(e){return new hI(null==e?void 0:e.cacheSizeBytes)}function hb(e){return new hy(e)}function hE(e){return new hw(e)}class hS{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=o2.provider,this._offlineComponentProvider={build:t=>new o0(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}class hx{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=o2.provider,this._offlineComponentProvider={build:t=>new o1(t,null==e?void 0:e.cacheSizeBytes)}}}function hN(e){return new hS(null==e?void 0:e.forceOwnership)}function hC(){return new hx}let hk={maxAttempts:5};class hD{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=ur(e)}set(e,t,n){this._verifyNotCommitted();let r=hA(e,this._firestore),i=uJ(r.converter,t,n),s=ui(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,rT.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=hA(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof l2?ud(this._dataReader,"WriteBatch.update",s._key,t,n,r):uc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,rT.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=hA(e,this._firestore);return this._mutations=this._mutations.concat(new rV(t._key,rT.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(C.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function hA(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new k(C.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class hR{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=ur(e)}get(e){let t=hA(e,this._firestore),n=new uX(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return x();let r=e[0];if(r.isFoundDocument())return new ub(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new ub(this._firestore,n,t._key,null,t.converter);throw x()})}set(e,t,n){let r=hA(e,this._firestore),i=uJ(r.converter,t,n),s=ui(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=hA(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof l2?ud(this._dataReader,"Transaction.update",s._key,t,n,r):uc(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=hA(e,this._firestore);return this._transaction.delete(t._key),this}}class hV extends hR{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=hA(e,this._firestore),n=new ht(this._firestore);return super.get(e).then(e=>new u4(this._firestore,n,t._key,e._document,new u3(!1,!1),t.converter))}}function hM(e,t,n){e=lv(e,lP);let r=Object.assign(Object.assign({},hk),n);if(r.maxAttempts<1)throw new k(C.INVALID_ARGUMENT,"Max attempts must be at least 1");return function(e,t,n){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>{let i=await ll(e);new o6(e.asyncQueue,i,n,t,r).Iu()}),r.promise}(lB(e),n=>t(new hV(e,n)),r)}function hF(){return new us("deleteField")}function hO(){return new uo("serverTimestamp")}function hL(...e){return new ul("arrayUnion",e)}function hP(...e){return new uu("arrayRemove",e)}function hq(e){return new uh("increment",e)}function hU(e){return new l4(e)}function hB(e){return lB(e=lv(e,lP)),new hD(e,t=>hf(e,t))}function hz(e,t){let n=lB(e=lv(e,lP));if(!n._uninitializedComponentsProvider||"memory"===n._uninitializedComponentsProvider._offline.kind)return E("Cannot enable indexes when persistence is disabled"),Promise.resolve();let r=function(e){let t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new k(C.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(let e of t.indexes){let t=hK(e,"collectionGroup"),r=[];if(Array.isArray(e.fields))for(let t of e.fields){let e=uI("setIndexConfiguration",hK(t,"fieldPath"));"CONTAINS"===t.arrayConfig?r.push(new ei(e,2)):"ASCENDING"===t.order?r.push(new ei(e,0)):"DESCENDING"===t.order&&r.push(new ei(e,1))}n.push(new ee(ee.UNKNOWN_ID,t,r,es.empty()))}return n}(t);return n.asyncQueue.enqueue(async()=>(async function(e,t){let n=e.indexManager,r=[];return e.persistence.runTransaction("Configure indexes","readwrite",e=>n.getFieldIndexes(e).next(i=>(function(e,t,n,r,i){t=[...t],(e=[...e]).sort(n),t.sort(n);let s=e.length,a=t.length,o=0,l=0;for(;o<a&&l<s;){let s=n(e[l],t[o]);s<0?i(e[l++]):s>0?r(t[o++]):(o++,l++)}for(;o<a;)r(t[o++]);for(;l<s;)i(e[l++])})(i,t,er,t=>{r.push(n.addFieldIndex(e,t))},t=>{r.push(n.deleteFieldIndex(e,t))})).next(()=>ef.waitFor(r)))})(await ls(n),r))}function hK(e,t){if("string"!=typeof e[t])throw new k(C.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class h${constructor(e){this._firestore=e,this.type="PersistentCacheIndexManager"}}function hG(e){var t;e=lv(e,lP);let n=hY.get(e);if(n)return n;if("persistent"!==(null==(t=lB(e)._uninitializedComponentsProvider)?void 0:t._offline.kind))return null;let r=new h$(e);return hY.set(e,r),r}function hj(e){hH(e,!0)}function hQ(e){hH(e,!1)}function hW(e){var t;(t=lB(e._firestore)).asyncQueue.enqueue(async()=>(function(e){let t=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",e=>t.deleteAllFieldIndexes(e))})(await ls(t))).then(e=>T("deleting all persistent cache indexes succeeded")).catch(e=>E("deleting all persistent cache indexes failed",e))}function hH(e,t){var n;(n=lB(e._firestore),n.asyncQueue.enqueue(async()=>{var e;return e=await ls(n),void(e.Ps.Xi=t)})).then(e=>T(`setting persistent cache index auto creation isEnabled=${t} succeeded`)).catch(e=>E(`setting persistent cache index auto creation isEnabled=${t} failed`,e))}let hY=new WeakMap;function hZ(e){var t;let n=null==(t=lB(lv(e.firestore,lP))._onlineComponents)?void 0:t.datastore.serializer;return void 0===n?null:iy(n,nY(e._query)).ht}function hJ(e,t){var n;let r=tC(t,(e,t)=>new rP(t,e.aggregateType,e._internalFieldPath)),i=null==(n=lB(lv(e.firestore,lP))._onlineComponents)?void 0:n.datastore.serializer;return void 0===i?null:iw(i,nZ(e._query),r,!0).request}class hX{constructor(){throw Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return h0.instance.onExistenceFilterMismatch(e)}}class h0{constructor(){this.Yu=new Map}static get instance(){return h1||function(e){if(rz)throw Error("a TestingHooksSpi instance is already set");rz=e}(h1=new h0),h1}rt(e){this.Yu.forEach(t=>t(e))}onExistenceFilterMismatch(e){let t=Symbol(),n=this.Yu;return n.set(t,e),()=>n.delete(t)}}let h1=null;!function(e,t=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:n,options:r})=>{let i=e.getProvider("app").getImmediate(),s=new lP(new M(e.getProvider("auth-internal")),new P(i,e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new k(C.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new tX(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2017")}()}}]);