"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9122],{9122:(e,t,r)=>{r.d(t,{Aq:()=>n,Gy:()=>d,QT:()=>l,Tt:()=>i,saveReflectionResponse:()=>c});var o=r(5112),a=r(3201);async function c(e,t,r,c,i){let l=!(arguments.length>5)||void 0===arguments[5]||arguments[5],n=a.j2.currentUser;if(!n)return void s(e,t,r,c,i,l);let d="".concat(n.uid,"_").concat(e,"_").concat(t,"_").concat(Date.now()),p=(0,o.doc)(a.db,"reflectionResponses",d),u={id:d,userId:n.uid,articleId:e,promptId:t,promptText:r,response:c,position:i,createdAt:(0,o.serverTimestamp)(),isPrivate:l};try{await (0,o.setDoc)(p,u),s(e,t,r,c,i,l)}catch(o){console.error("Error saving reflection response:",o),s(e,t,r,c,i,l)}}function s(e,t,r,o,a,c){try{let s="reflection_".concat(e),i=localStorage.getItem(s),l=i?JSON.parse(i):[],n={id:"local_".concat(Date.now()),promptId:t,promptText:r,response:o,position:a,createdAt:new Date().toISOString(),isPrivate:c};l.push(n),localStorage.setItem(s,JSON.stringify(l))}catch(e){console.error("Error saving reflection to local storage:",e)}}async function i(e){let t=a.j2.currentUser,c=e||(null==t?void 0:t.uid),s=new Map;if(t&&c)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",c),(0,o.orderBy)("createdAt","desc"));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data(),r=t.articleId;s.has(r)||s.set(r,{userId:t.userId,articleId:r,articleTitle:"Loading...",articleSlug:r,responses:[],createdAt:t.createdAt,updatedAt:t.createdAt});let o=s.get(r);o.responses.push(t),t.createdAt>o.updatedAt&&(o.updatedAt=t.createdAt)})}catch(e){console.error("Error fetching reflection responses from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=e.replace("reflection_",""),r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);if(!Array.isArray(e))return;e.forEach(e=>{let r={id:e.id||"local_".concat(Date.now()),userId:"local",articleId:t,promptId:e.promptId,promptText:e.promptText,response:e.response,position:e.position,createdAt:new Date(e.createdAt),isPrivate:e.isPrivate};s.has(t)||s.set(t,{userId:"local",articleId:t,articleTitle:"Loading...",articleSlug:t,responses:[],createdAt:r.createdAt,updatedAt:r.createdAt});let o=s.get(t);!o.responses.some(e=>e.promptId===r.promptId&&e.position===r.position&&e.response===r.response)&&(o.responses.push(r),r.createdAt>o.updatedAt&&(o.updatedAt=r.createdAt))})}catch(e){console.error("Error parsing local storage reflection data:",e)}})}catch(e){console.error("Error reading from local storage:",e)}let i=Array.from(s.values()).filter(e=>e.responses.length>0);return await Promise.all(i.map(async e=>{try{let{getArticleById:t}=await r.e(9210).then(r.bind(r,9210)),o=await t(e.articleId);o?(e.articleTitle=o.title,e.articleSlug=o.slug||e.articleId):e.articleTitle="Article: ".concat(e.articleId)}catch(t){console.error("Error fetching article for ".concat(e.articleId,":"),t),e.articleTitle="Article: ".concat(e.articleId)}})),i.sort((e,t)=>{let r=e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis();return(t.updatedAt instanceof Date?t.updatedAt.getTime():t.updatedAt.toMillis())-r}),i}async function l(e,t){let r=a.j2.currentUser,c=!1,s=!1;if(r)try{let s=(0,o.collection)(a.db,"reflectionResponses"),i=(0,o.query)(s,(0,o.where)("userId","==",r.uid),(0,o.where)("articleId","==",e),(0,o.where)("id","==",t)),l=await (0,o.getDocs)(i);if(!l.empty){let e=l.docs[0];await (0,o.deleteDoc)(e.ref),c=!0}}catch(e){console.error("Error deleting from Firestore:",e)}try{let r="reflection_".concat(e),o=localStorage.getItem(r);if(o){let e=JSON.parse(o),a=e.filter(e=>e.id!==t);a.length!==e.length&&(0===a.length?localStorage.removeItem(r):localStorage.setItem(r,JSON.stringify(a)),s=!0)}}catch(e){console.error("Error deleting from local storage:",e)}return c||s}async function n(e){let t=a.j2.currentUser,c=e||(null==t?void 0:t.uid),s=[],i=new Set;if(t&&c)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",c),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(10)),l=await (0,o.getDocs)(t),n=new Map;for(let e of l.docs){let t=e.data();if(t.response&&t.response.length>20){let e=t.response.toLowerCase().trim();if(!i.has(e)){i.add(e);let o=n.get(t.articleId);if(!o)try{let{getArticleById:e}=await r.e(9210).then(r.bind(r,9210)),a=await e(t.articleId);o=(null==a?void 0:a.title)||"Unknown Article",n.set(t.articleId,o)}catch(e){o="Unknown Article"}s.push({response:t.response,articleTitle:o,promptText:t.promptText})}}}}catch(e){console.error("Error fetching inspiration from Firestore:",e)}try{let e=Object.keys(localStorage).filter(e=>e.startsWith("reflection_")),t=[];e.forEach(e=>{let r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);Array.isArray(e)&&t.push(...e)}catch(e){console.error("Error parsing local storage reflection:",e)}}),t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,10).forEach(e=>{if(e.response&&e.response.length>20){let t=e.response.toLowerCase().trim();i.has(t)||(i.add(t),s.push({response:e.response,articleTitle:"Local Article",promptText:e.promptText}))}})}catch(e){console.error("Error reading inspiration from local storage:",e)}return s.sort(()=>Math.random()-.5).slice(0,5)}async function d(e){let t=a.j2.currentUser,r=e||(null==t?void 0:t.uid),c=new Set,s=[];if(t&&r)try{let e=(0,o.collection)(a.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",r),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(20));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data();t.promptText&&s.push(t.promptText)})}catch(e){console.error("Error fetching themes from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=localStorage.getItem(e);if(t)try{let e=JSON.parse(t);Array.isArray(e)&&e.forEach(e=>{e.promptText&&s.push(e.promptText)})}catch(e){console.error("Error parsing local storage for themes:",e)}})}catch(e){console.error("Error reading themes from local storage:",e)}return s.forEach(e=>{let t=e.toLowerCase();t.includes("feel")&&c.add("emotions"),(t.includes("choice")||t.includes("decision"))&&c.add("decision-making"),t.includes("experience")&&c.add("personal experience"),t.includes("question")&&c.add("questioning"),t.includes("surprise")&&c.add("unexpected insights"),(t.includes("perspective")||t.includes("view"))&&c.add("perspectives"),t.includes("author")&&c.add("dialogue with authors"),(t.includes("relate")||t.includes("connect"))&&c.add("connections")}),Array.from(c).slice(0,6)}}}]);