"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9122],{9122:(e,t,r)=>{r.d(t,{Aq:()=>n,Gy:()=>d,QT:()=>i,Tt:()=>s,saveReflectionResponse:()=>l});var o=r(5317),c=r(3201);async function l(e,t,r,l,s){let i=!(arguments.length>5)||void 0===arguments[5]||arguments[5];console.log("saveReflectionResponse called with:",{articleId:e,promptId:t,promptText:r,response:l,position:s,isPrivate:i});let n=c.j2.currentUser;if(console.log("Current user:",n?n.uid:"Not authenticated"),!n){console.log("User not authenticated, saving to local storage"),a(e,t,r,l,s,i);return}let d="".concat(n.uid,"_").concat(e,"_").concat(t,"_").concat(Date.now()),p=(0,o.doc)(c.db,"reflectionResponses",d),u={id:d,userId:n.uid,articleId:e,promptId:t,promptText:r,response:l,position:s,createdAt:(0,o.serverTimestamp)(),isPrivate:i};try{console.log("Attempting to save to Firestore with ID:",d),await (0,o.setDoc)(p,u),console.log("Successfully saved to Firestore"),a(e,t,r,l,s,i)}catch(o){console.error("Error saving reflection response:",o),a(e,t,r,l,s,i)}}function a(e,t,r,o,c,l){try{let a="reflection_".concat(e);console.log("Saving to local storage with key:",a);let s=localStorage.getItem(a),i=s?JSON.parse(s):[];console.log("Existing reflections:",i.length);let n={id:"local_".concat(Date.now()),promptId:t,promptText:r,response:o,position:c,createdAt:new Date().toISOString(),isPrivate:l};i.push(n),localStorage.setItem(a,JSON.stringify(i)),console.log("Successfully saved to local storage. Total reflections:",i.length)}catch(e){console.error("Error saving reflection to local storage:",e)}}async function s(e){let t=c.j2.currentUser,l=e||(null==t?void 0:t.uid),a=new Map;if(t&&l)try{let e=(0,o.collection)(c.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",l),(0,o.orderBy)("createdAt","desc"));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data(),r=t.articleId;a.has(r)||a.set(r,{userId:t.userId,articleId:r,articleTitle:"Loading...",articleSlug:r,responses:[],createdAt:t.createdAt,updatedAt:t.createdAt});let o=a.get(r);o.responses.push(t),t.createdAt>o.updatedAt&&(o.updatedAt=t.createdAt)})}catch(e){console.error("Error fetching reflection responses from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=e.replace("reflection_",""),r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);if(!Array.isArray(e))return;e.forEach(e=>{let r={id:e.id||"local_".concat(Date.now()),userId:"local",articleId:t,promptId:e.promptId,promptText:e.promptText,response:e.response,position:e.position,createdAt:new Date(e.createdAt),isPrivate:e.isPrivate};a.has(t)||a.set(t,{userId:"local",articleId:t,articleTitle:"Loading...",articleSlug:t,responses:[],createdAt:r.createdAt,updatedAt:r.createdAt});let o=a.get(t);!o.responses.some(e=>e.promptId===r.promptId&&e.position===r.position&&e.response===r.response)&&(o.responses.push(r),r.createdAt>o.updatedAt&&(o.updatedAt=r.createdAt))})}catch(e){console.error("Error parsing local storage reflection data:",e)}})}catch(e){console.error("Error reading from local storage:",e)}let s=Array.from(a.values()).filter(e=>e.responses.length>0);return await Promise.all(s.map(async e=>{try{let{getArticleById:t}=await r.e(9210).then(r.bind(r,9210)),o=await t(e.articleId);o?(e.articleTitle=o.title,e.articleSlug=o.slug||e.articleId,console.log("Successfully fetched title for ".concat(e.articleId,": ").concat(o.title))):(e.articleTitle="Article: ".concat(e.articleId),console.log("Article not found for ID: ".concat(e.articleId)))}catch(t){console.error("Error fetching article for ".concat(e.articleId,":"),t),e.articleTitle="Article: ".concat(e.articleId)}})),s.sort((e,t)=>{let r=e.updatedAt instanceof Date?e.updatedAt.getTime():e.updatedAt.toMillis();return(t.updatedAt instanceof Date?t.updatedAt.getTime():t.updatedAt.toMillis())-r}),s}async function i(e,t){console.log("Deleting reflection:",{articleId:e,reflectionId:t});let r=c.j2.currentUser,l=!1,a=!1;if(r)try{let a=(0,o.collection)(c.db,"reflectionResponses"),s=(0,o.query)(a,(0,o.where)("userId","==",r.uid),(0,o.where)("articleId","==",e),(0,o.where)("id","==",t)),i=await (0,o.getDocs)(s);if(!i.empty){let e=i.docs[0];await (0,o.deleteDoc)(e.ref),console.log("Successfully deleted from Firestore"),l=!0}}catch(e){console.error("Error deleting from Firestore:",e)}try{let r="reflection_".concat(e),o=localStorage.getItem(r);if(o){let e=JSON.parse(o),c=e.filter(e=>e.id!==t);c.length!==e.length&&(0===c.length?localStorage.removeItem(r):localStorage.setItem(r,JSON.stringify(c)),console.log("Successfully deleted from local storage"),a=!0)}}catch(e){console.error("Error deleting from local storage:",e)}return l||a}async function n(e){let t=c.j2.currentUser,l=e||(null==t?void 0:t.uid),a=[],s=new Set;if(t&&l)try{let e=(0,o.collection)(c.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",l),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(10)),i=await (0,o.getDocs)(t),n=new Map;for(let e of i.docs){let t=e.data();if(t.response&&t.response.length>20){let e=t.response.toLowerCase().trim();if(!s.has(e)){s.add(e);let o=n.get(t.articleId);if(!o)try{let{getArticleById:e}=await r.e(9210).then(r.bind(r,9210)),c=await e(t.articleId);o=(null==c?void 0:c.title)||"Unknown Article",n.set(t.articleId,o)}catch(e){o="Unknown Article"}a.push({response:t.response,articleTitle:o,promptText:t.promptText})}}}}catch(e){console.error("Error fetching inspiration from Firestore:",e)}try{let e=Object.keys(localStorage).filter(e=>e.startsWith("reflection_")),t=[];e.forEach(e=>{let r=localStorage.getItem(e);if(r)try{let e=JSON.parse(r);Array.isArray(e)&&t.push(...e)}catch(e){console.error("Error parsing local storage reflection:",e)}}),t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,10).forEach(e=>{if(e.response&&e.response.length>20){let t=e.response.toLowerCase().trim();s.has(t)||(s.add(t),a.push({response:e.response,articleTitle:"Local Article",promptText:e.promptText}))}})}catch(e){console.error("Error reading inspiration from local storage:",e)}return a.sort(()=>Math.random()-.5).slice(0,5)}async function d(e){let t=c.j2.currentUser,r=e||(null==t?void 0:t.uid),l=new Set,a=[];if(t&&r)try{let e=(0,o.collection)(c.db,"reflectionResponses"),t=(0,o.query)(e,(0,o.where)("userId","==",r),(0,o.orderBy)("createdAt","desc"),(0,o.limit)(20));(await (0,o.getDocs)(t)).docs.forEach(e=>{let t=e.data();t.promptText&&a.push(t.promptText)})}catch(e){console.error("Error fetching themes from Firestore:",e)}try{Object.keys(localStorage).filter(e=>e.startsWith("reflection_")).forEach(e=>{let t=localStorage.getItem(e);if(t)try{let e=JSON.parse(t);Array.isArray(e)&&e.forEach(e=>{e.promptText&&a.push(e.promptText)})}catch(e){console.error("Error parsing local storage for themes:",e)}})}catch(e){console.error("Error reading themes from local storage:",e)}return a.forEach(e=>{let t=e.toLowerCase();t.includes("feel")&&l.add("emotions"),(t.includes("choice")||t.includes("decision"))&&l.add("decision-making"),t.includes("experience")&&l.add("personal experience"),t.includes("question")&&l.add("questioning"),t.includes("surprise")&&l.add("unexpected insights"),(t.includes("perspective")||t.includes("view"))&&l.add("perspectives"),t.includes("author")&&l.add("dialogue with authors"),(t.includes("relate")||t.includes("connect"))&&l.add("connections")}),Array.from(l).slice(0,6)}}}]);